# CIS ファイル検索システム AWS リソースサイジング設計書

## 前提条件

### 利用想定
- **月間検索数**: 1,000,000検索/月
- **1日あたり**: 約33,333検索
- **営業日**: 22日/月として計算
- **営業時間**: 9:00-18:00 (9時間)
- **ピーク時間帯**: 10:00-12:00, 14:00-16:00 (合計5時間)
- **ピーク時検索数**: 約4,000検索/時 = 約1.1検索/秒
- **ピーク時2倍想定**: 約2.2検索/秒
- **ユーザー数**: 50名
- **ファイル数**: 50,000ファイル
- **総データサイズ**: 10TB (NAS)

### 処理量計算の前提
1検索あたりの処理:
- **OpenSearch検索**: 1回
- **RDS権限チェック**: 1回
- **Lambda実行**: 平均2.5回（検索処理、ログ記録、キャッシュ処理）
- **DynamoDB読み取り**: 平均2.5回（キャッシュ、メタデータ、セッション）

データサイズ:
- **ファイルメタデータ**: 平均2KB/ファイル → 50,000ファイル × 2KB = 100MB
- **OpenSearchインデックス**: 平均50KB/ファイル（全文検索含む） → 50,000 × 50KB = 2.5GB
- **検索履歴**: 1,000,000検索 × 1KB = 1GB/月

---

## パターン1: コスト最優先（機能削減版）

### 設計方針
- Single-AZ構成で可用性を犠牲にコスト削減
- 最小限のインスタンスサイズ
- バックアップ最小限（7日保持）
- 監視最小限（基本メトリクスのみ）
- **削除機能**: 画像類似検索、AI機能、リアルタイム通知、詳細ダッシュボード
- **基本機能のみ**: ファイル名検索、シンプル全文検索、基本UI

---

### 1. RDS (PostgreSQL)

#### パターン1_コスト最優先:

**スペック**:
- **インスタンスタイプ**: `db.t4g.micro`
- **vCPU**: 2
- **メモリ**: 1GB
- **ストレージ**: 20GB (gp2)
- **構成**: Single-AZ
- **バックアップ**: 自動バックアップ7日保持
- **想定接続数**: 最大50接続（全ユーザー分）

**月間使用量**:
- **稼働時間**: 730時間/月
- **ストレージ**: 20GB
- **バックアップストレージ**: 20GB (1世代保持)
- **IOPS**: 100 IOPS (gp2ベースライン)

**計算根拠**:
```
ユーザー数: 50名
最大同時接続: 10名程度（20%想定）
1検索あたりのRDSクエリ: 1回（権限チェック）
月間クエリ数: 1,000,000回
1日平均クエリ数: 約45,000回

レスポンスタイム要件:
- 権限チェッククエリ: 10ms以内
- ユーザー情報取得: 5ms以内

ストレージ計算:
- users: 50ユーザー × 1KB = 50KB
- departments: 10部署 × 1KB = 10KB
- search_histories: 1,000,000 × 1KB = 1GB/月 → 3ヶ月保持 = 3GB
- audit_logs: 最小限 = 1GB
- 合計: 約5GB → 余裕を持って20GB
```

---

### 2. OpenSearch

#### パターン1_コスト最優先:

**スペック**:
- **ノード構成**:
  - データノード: 1台
  - マスターノード: なし（データノードが兼任）
- **インスタンスタイプ**: `t3.small.search`
- **vCPU**: 2
- **メモリ**: 2GB
- **EBSストレージ**: 10GB (gp2)
- **レプリカ数**: 0（レプリカなし）
- **構成**: Single-AZ

**月間使用量**:
- **インデックスサイズ**: 3GB
  - ファイルメタデータ: 50,000 × 2KB = 100MB
  - 全文検索インデックス: 50,000 × 50KB = 2.5GB
  - その他: 400MB
- **検索リクエスト**: 1,000,000回/月
- **インデックス更新**: 月1回（フルインデックス）

**計算根拠**:
```
検索パフォーマンス:
- 平均検索レイテンシ: 200-500ms
- ピーク時検索数: 2.2検索/秒
- 1ノードで十分対応可能

インデックス構成:
- Shards: 1（ファイル数50,000でシングルシャードで十分）
- Replicas: 0（コスト優先のため冗長性なし）

ストレージ計算:
- ベースインデックス: 2.5GB
- 成長率: 月5%想定 → 3GB確保
- レプリカなしのため単一コピーのみ
```

---

### 3. Lambda

#### パターン1_コスト最優先:

**関数構成**:

**3.1 search-function**:
- **メモリ**: 512MB
- **月間実行回数**: 1,000,000回
- **平均実行時間**: 300ms
- **同時実行数**: 5

**3.2 indexing-function**:
- **メモリ**: 1024MB
- **月間実行回数**: 50,000回（月1回フルインデックス、1ファイル1実行）
- **平均実行時間**: 2000ms（2秒）
- **同時実行数**: 10

**3.3 logging-function**:
- **メモリ**: 256MB
- **月間実行回数**: 1,000,000回
- **平均実行時間**: 100ms
- **同時実行数**: 3

**月間使用量**:
```
総Lambda実行時間:
- search: 1,000,000回 × 300ms = 300,000秒 = 83.3時間
- indexing: 50,000回 × 2000ms = 100,000秒 = 27.8時間
- logging: 1,000,000回 × 100ms = 100,000秒 = 27.8時間
総計: 138.9時間/月

GB-秒計算:
- search: 1,000,000 × 0.3秒 × 0.5GB = 150,000 GB-秒
- indexing: 50,000 × 2秒 × 1GB = 100,000 GB-秒
- logging: 1,000,000 × 0.1秒 × 0.25GB = 25,000 GB-秒
総計: 275,000 GB-秒/月

無料枠: 400,000 GB-秒/月
課金対象: なし（無料枠内）
```

---

### 4. DynamoDB

#### パターン1_コスト最優先:

**テーブル構成**:

**4.1 file_metadata**:
- **課金モード**: On-Demand
- **読み込みキャパシティ**: 平均5RCU（ピーク時10RCU）
- **書き込みキャパシティ**: 平均1WCU（インデックス更新時のみ）
- **ストレージサイズ**: 150MB
  - 50,000ファイル × 3KB（DynamoDBオーバーヘッド含む）

**4.2 search_cache**:
- **課金モード**: On-Demand
- **読み込みキャパシティ**: 平均3RCU
- **書き込みキャパシティ**: 平均2WCU
- **ストレージサイズ**: 50MB
- **TTL**: 5分（自動削除）

**4.3 user_preferences**:
- **課金モード**: On-Demand
- **読み込みキャパシティ**: 平均1RCU
- **書き込みキャパシティ**: 平均0.5WCU
- **ストレージサイズ**: 5MB
  - 50ユーザー × 100KB

**月間使用量**:
```
読み取りリクエスト:
- 1,000,000検索 × 2.5回 = 2,500,000回
- 1リクエスト4KBまで = 2,500,000 RRU

書き込みリクエスト:
- 検索ログ: 1,000,000回
- キャッシュ更新: 500,000回
- 合計: 1,500,000 WRU

ストレージ:
- file_metadata: 150MB
- search_cache: 50MB（TTLで自動削減）
- user_preferences: 5MB
- 合計: 205MB → 余裕を持って250MB
```

---

### 5. S3

#### パターン1_コスト最優先:

**バケット構成**:

**5.1 cis-filesearch-prod**:
- **保存データサイズ**: 50GB
  - サムネイル: 10GB（50,000ファイル × 200KB）
  - 検索ログ: 10GB（3ヶ月保持）
  - 一時ファイル: 5GB
  - その他: 25GB
- **ストレージクラス**: STANDARD

**月間リクエスト数**:
- **PUT/POST/LIST**: 100,000回
  - ログ書き込み: 50,000回
  - サムネイル生成: 30,000回
  - その他: 20,000回
- **GET/SELECT**: 500,000回
  - サムネイル取得: 300,000回
  - ログ読み取り: 100,000回
  - その他: 100,000回

**データ転送量**:
- **送信（Internet）**: 50GB/月
  - サムネイル配信: 30GB
  - その他: 20GB
- **受信**: 無料

**計算根拠**:
```
サムネイル計算:
- 画像ファイル数: 20,000ファイル（40%想定）
- サムネイルサイズ: small 50KB, medium 100KB, large 200KB
- 平均: 150KB
- 合計: 20,000 × 150KB × 2種類（medium, small） = 6GB
- PDF等のプレビュー: 4GB
- 合計: 10GB

ログストレージ:
- 検索ログ: 1,000,000 × 500バイト = 500MB/月
- アクセスログ: 2GB/月
- エラーログ: 500MB/月
- 3ヶ月保持: 9GB → 余裕を持って10GB
```

---

### 6. CloudWatch

#### パターン1_コスト最優先:

**ログ収集**:
- **ログ取り込み量**: 10GB/月
  - Lambdaログ: 5GB
  - RDSログ: 1GB
  - OpenSearchログ: 2GB
  - その他: 2GB
- **ログ保存期間**: 7日

**メトリクス**:
- **カスタムメトリクス**: 10個
  - 検索レスポンスタイム
  - エラー率
  - 検索成功率
  - システムヘルス
  - その他基本メトリクス
- **標準メトリクス**: 無料（AWS各サービスの基本メトリクス）

**アラーム**:
- **アラーム数**: 5個
  - システムダウン
  - レスポンスタイム > 10秒
  - エラー率 > 5%
  - RDS接続数 > 45
  - ディスク使用率 > 85%

**計算根拠**:
```
ログ量計算:
- Lambda実行ログ: 2,050,000回 × 2KB = 4.1GB
- APIアクセスログ: 1,000,000回 × 1KB = 1GB
- その他システムログ: 5GB
- 合計: 約10GB/月
```

---

### 7. API Gateway

#### パターン1_コスト最優先:

**スペック**:
- **タイプ**: REST API
- **月間リクエスト数**: 1,500,000回
  - 検索API: 1,000,000回
  - メタデータ取得: 300,000回
  - その他API: 200,000回
- **データ転送量**: 15GB/月
  - 平均レスポンスサイズ: 10KB

**計算根拠**:
```
リクエスト数:
- 検索リクエスト: 1,000,000回
- ファイルメタデータ: 1検索あたり0.3回 = 300,000回
- ユーザー認証: 50,000回
- その他: 150,000回
- 合計: 1,500,000回/月

データ転送:
- 検索結果: 1,000,000 × 10KB = 10GB
- その他: 5GB
- 合計: 15GB
```

---

### 8. Cognito

#### パターン1_コスト最優先:

**スペック**:
- **ユーザー数**: 50名
- **月間アクティブユーザー (MAU)**: 50名
- **MFA**: なし
- **高度なセキュリティ機能**: なし

**月間認証数**:
- **ログイン**: 1,000回/月（1日平均20回）
- **トークンリフレッシュ**: 5,000回/月

**計算根拠**:
```
無料枠: 50,000 MAU/月
現状: 50 MAU
→ 完全に無料枠内
```

---

### 9. その他サービス

#### パターン1_コスト最優先:

**9.1 CloudFront**:
- **不使用**（コスト削減のためスキップ）
- S3直接アクセス

**9.2 ElastiCache**:
- **不使用**（コスト削減のためスキップ）
- DynamoDBでキャッシュ代替

**9.3 NAT Gateway**:
- **構成**: Single-AZ、1台
- **データ処理量**: 50GB/月
  - Lambda → インターネット通信
  - RDS → 外部API通信

**9.4 Application Load Balancer**:
- **不使用**（コスト削減）
- API Gateway直接利用

---

### パターン1 コストサマリー（概算）

| サービス | 月額コスト（USD） |
|---------|-----------------|
| RDS (db.t4g.micro) | $12 |
| OpenSearch (t3.small.search) | $25 |
| Lambda | $0（無料枠内） |
| DynamoDB | $2 |
| S3 (50GB STANDARD) | $1.15 |
| CloudWatch Logs | $5 |
| API Gateway | $5.25 |
| Cognito | $0（無料枠内） |
| NAT Gateway | $35 |
| Data Transfer | $5 |
| **合計** | **約$90.40/月** |

---

## パターン2: 可用性・セキュリティ重視（フル機能版）

### 設計方針
- Multi-AZ構成で高可用性確保
- 適切な冗長性とバックアップ
- 包括的な監視とアラート
- **フル機能**: 全文検索、画像類似検索、AI機能、リアルタイム通知、詳細ダッシュボード

---

### 1. RDS (PostgreSQL)

#### パターン2_可用性重視:

**スペック**:
- **インスタンスタイプ**: `db.t4g.medium`
- **vCPU**: 2
- **メモリ**: 4GB
- **ストレージ**: 100GB (gp3, 3000 IOPS)
- **構成**: Multi-AZ（2-AZ）
- **バックアップ**: 自動バックアップ7日 + 手動スナップショット30日保持
- **想定接続数**: 最大100接続（拡張可能）
- **RDS Proxy**: あり（接続プーリング）

**月間使用量**:
- **稼働時間**: 730時間/月 × 2（Multi-AZ）
- **ストレージ**: 100GB × 2（プライマリ＋スタンバイ）
- **バックアップストレージ**: 200GB（7日自動 + 手動）
- **IOPS**: 3000 IOPS (gp3)
- **RDS Proxy接続数**: 50接続

**計算根拠**:
```
パフォーマンス要件:
- 同時接続数: 50名全員 + アプリケーション接続
- 1検索あたりRDSクエリ: 2-3回（権限チェック、ユーザー情報、監査ログ）
- ピーク時QPS: 2.2検索/秒 × 3クエリ = 6.6 QPS
- 平均QPS: 1.1 × 3 = 3.3 QPS
→ db.t4g.mediumで十分対応可能

ストレージ計算:
- users: 100ユーザー × 2KB = 200KB（将来拡張想定）
- departments: 20部署 × 1KB = 20KB
- search_histories: 1,000,000 × 1.5KB = 1.5GB/月 → 12ヶ月保持 = 18GB
- audit_logs: 2,000,000 × 2KB = 4GB/月 → 12ヶ月 = 48GB
- その他テーブル: 5GB
- インデックス: 10GB
- 合計: 約81GB → 余裕を持って100GB

Multi-AZ:
- プライマリとスタンバイで2倍のコスト
- 自動フェイルオーバー（RTO < 2分）
- データ損失なし（RPO = 0）
```

---

### 2. OpenSearch

#### パターン2_可用性重視:

**スペック**:
- **ノード構成**:
  - データノード: 3台（3-AZ）
  - マスターノード: 3台（3-AZ、m6g.large.search）
- **データノードインスタンスタイプ**: `r6g.large.search`
- **vCPU**: 2 × 3 = 6
- **メモリ**: 16GB × 3 = 48GB
- **EBSストレージ**: 100GB × 3 = 300GB (gp3, 3000 IOPS)
- **レプリカ数**: 2（各シャードに2つのレプリカ）
- **構成**: Multi-AZ（3-AZ）

**月間使用量**:
- **インデックスサイズ**: 15GB（レプリカ含む合計45GB）
  - ファイルメタデータ: 50,000 × 3KB = 150MB
  - 全文検索インデックス: 50,000 × 100KB = 5GB（拡張インデックス）
  - 画像ベクトルインデックス: 20,000 × 512次元 × 4バイト × 3 = 123MB
  - その他: 9GB（成長分、ログ等）
- **検索リクエスト**: 1,500,000回/月（AI検索含む）
- **インデックス更新**: 週1回差分 + 月1回フル

**計算根拠**:
```
高可用性構成:
- 3データノード（3-AZ）で高可用性確保
- 専用マスターノードで安定性向上
- レプリカ2で読み取り負荷分散 + 耐障害性

検索パフォーマンス:
- 平均検索レイテンシ: 50-150ms
- ピーク時検索数: 2.2検索/秒
- 3ノードでの分散処理
- 画像類似検索: k-NN検索対応

インデックス構成:
- Shards: 3（各AZに1シャード）
- Replicas: 2（各シャードに2レプリカ）
- 合計シャードコピー: 3 × 3 = 9コピー

ストレージ計算:
- ベースインデックス: 5GB
- ベクトルインデックス: 5GB
- レプリカ × 2: 10GB × 3 = 30GB
- 成長分（年20%）: 6GB
- 合計: 36GB → 安全マージン含め100GB/ノード
```

---

### 3. Lambda

#### パターン2_可用性重視:

**関数構成**:

**3.1 search-function**:
- **メモリ**: 1024MB
- **月間実行回数**: 1,200,000回
- **平均実行時間**: 500ms
- **同時実行数**: 10
- **Provisioned Concurrency**: 2（コールドスタート回避）

**3.2 ai-search-function**:
- **メモリ**: 2048MB
- **月間実行回数**: 200,000回
- **平均実行時間**: 1500ms
- **同時実行数**: 5
- **Provisioned Concurrency**: 1

**3.3 indexing-function**:
- **メモリ**: 2048MB
- **月間実行回数**: 200,000回（週次差分 × 4 + 月次フル）
- **平均実行時間**: 3000ms
- **同時実行数**: 20

**3.4 image-processing-function**:
- **メモリ**: 3008MB
- **月間実行回数**: 100,000回
- **平均実行時間**: 5000ms
- **同時実行数**: 10

**3.5 logging-function**:
- **メモリ**: 512MB
- **月間実行回数**: 1,500,000回
- **平均実行時間**: 200ms
- **同時実行数**: 5

**3.6 notification-function**:
- **メモリ**: 512MB
- **月間実行回数**: 50,000回
- **平均実行時間**: 300ms
- **同時実行数**: 3

**月間使用量**:
```
総Lambda実行時間:
- search: 1,200,000 × 500ms = 600,000秒 = 166.7時間
- ai-search: 200,000 × 1500ms = 300,000秒 = 83.3時間
- indexing: 200,000 × 3000ms = 600,000秒 = 166.7時間
- image-processing: 100,000 × 5000ms = 500,000秒 = 138.9時間
- logging: 1,500,000 × 200ms = 300,000秒 = 83.3時間
- notification: 50,000 × 300ms = 15,000秒 = 4.2時間
総計: 643.1時間/月

GB-秒計算:
- search: 1,200,000 × 0.5秒 × 1GB = 600,000 GB-秒
- ai-search: 200,000 × 1.5秒 × 2GB = 600,000 GB-秒
- indexing: 200,000 × 3秒 × 2GB = 1,200,000 GB-秒
- image-processing: 100,000 × 5秒 × 3GB = 1,500,000 GB-秒
- logging: 1,500,000 × 0.2秒 × 0.5GB = 150,000 GB-秒
- notification: 50,000 × 0.3秒 × 0.5GB = 7,500 GB-秒
総計: 4,057,500 GB-秒/月

無料枠: 400,000 GB-秒/月
課金対象: 3,657,500 GB-秒/月

Provisioned Concurrency:
- search: 2ユニット × 730時間 × 1GB = 1,460 PC-時間
- ai-search: 1ユニット × 730時間 × 2GB = 1,460 PC-時間
```

---

### 4. DynamoDB

#### パターン2_可用性重視:

**テーブル構成**:

**4.1 file_metadata**:
- **課金モード**: Provisioned
- **読み込みキャパシティ**: 25 RCU（Auto Scaling 5-50）
- **書き込みキャパシティ**: 10 WCU（Auto Scaling 2-30）
- **ストレージサイズ**: 200MB
- **グローバルテーブル**: なし（Single Region）
- **Point-in-Time Recovery**: 有効（35日）

**4.2 search_cache**:
- **課金モード**: On-Demand
- **読み込みキャパシティ**: 平均10RCU
- **書き込みキャパシティ**: 平均5WCU
- **ストレージサイズ**: 100MB
- **TTL**: 5分

**4.3 user_preferences**:
- **課金モード**: Provisioned
- **読み込みキャパシティ**: 5 RCU
- **書き込みキャパシティ**: 2 WCU
- **ストレージサイズ**: 10MB

**4.4 index_jobs**:
- **課金モード**: On-Demand
- **読み込みキャパシティ**: 平均2RCU
- **書き込みキャパシティ**: 平均1WCU
- **ストレージサイズ**: 50MB

**月間使用量**:
```
読み取りリクエスト:
- 1,200,000検索 × 3回 = 3,600,000回
- キャッシュヒット率60% = 実際2,400,000 RRU
- その他（プリファレンス等）: 500,000 RRU
- 合計: 2,900,000 RRU

書き込みリクエスト:
- 検索ログ: 1,200,000回
- キャッシュ更新: 800,000回
- メタデータ更新: 200,000回
- 合計: 2,200,000 WRU

ストレージ:
- file_metadata: 200MB
- search_cache: 100MB
- user_preferences: 10MB
- index_jobs: 50MB
- 合計: 360MB
```

---

### 5. S3

#### パターン2_可用性重視:

**バケット構成**:

**5.1 cis-filesearch-prod**:
- **保存データサイズ**: 500GB
  - ファイルキャッシュ: 200GB（頻繁にアクセスされるファイル）
  - サムネイル: 50GB
  - 画像特徴量データ: 50GB
  - 検索ログ: 50GB（12ヶ月保持）
  - インデックススナップショット: 100GB
  - その他: 50GB
- **ストレージクラス**:
  - STANDARD: 300GB
  - STANDARD_IA: 150GB（30日以上経過）
  - GLACIER: 50GB（90日以上経過）
- **レプリケーション**: Cross-Region Replication（大阪リージョン）

**月間リクエスト数**:
- **PUT/POST/LIST**: 500,000回
- **GET/SELECT**: 2,000,000回

**データ転送量**:
- **送信（Internet）**: 200GB/月（CloudFront経由）
- **送信（CloudFront）**: 150GB/月
- **受信**: 100GB/月（インデックス更新）

**計算根拠**:
```
ファイルキャッシュ:
- アクセス頻度高: 20%のファイル = 10,000ファイル
- 平均ファイルサイズ: 20MB
- キャッシュサイズ: 10,000 × 20MB = 200GB

サムネイル:
- 画像ファイル: 20,000ファイル
- 3サイズ（small, medium, large）
- 平均サイズ: 800KB
- 合計: 20,000 × 800KB × 3 = 48GB → 50GB

画像特徴量:
- 20,000画像 × 512次元 × 4バイト × 拡張データ = 50GB

Cross-Region Replication:
- 重要データのみ: 200GB
- 大阪リージョンへレプリケート
```

---

### 6. CloudWatch

#### パターン2_可用性重視:

**ログ収集**:
- **ログ取り込み量**: 100GB/月
- **ログ保存期間**: 30日（標準）、90日（監査ログ）

**メトリクス**:
- **カスタムメトリクス**: 100個
  - ビジネスメトリクス: 30個
  - 技術メトリクス: 50個
  - セキュリティメトリクス: 20個
- **詳細モニタリング**: 有効（1分間隔）

**アラーム**:
- **アラーム数**: 50個
  - Critical: 15個
  - Warning: 25個
  - Info: 10個

**ダッシュボード**:
- **ダッシュボード数**: 5個
  - ビジネスダッシュボード
  - システムヘルスダッシュボード
  - セキュリティダッシュボード
  - パフォーマンスダッシュボード
  - コストダッシュボード

**計算根拠**:
```
ログ量計算:
- Lambda実行ログ: 3,250,000回 × 3KB = 9.75GB
- API Gatewayログ: 2,000,000回 × 2KB = 4GB
- RDSログ: 10GB
- OpenSearchログ: 30GB
- アプリケーションログ: 40GB
- その他: 6.25GB
- 合計: 100GB/月

カスタムメトリクス詳細:
ビジネス（30個）:
- 検索レスポンスタイム（平均、P50, P95, P99）
- 検索成功率
- ユーザーアクティビティ
- 検索パターン分析
- ファイルアクセス頻度
- 人気ファイルランキング
- 検索結果精度
- etc.

技術（50個）:
- 各Lambdaのレイテンシ、エラー率、同時実行数
- RDS CPU、メモリ、接続数、レプリケーションラグ
- OpenSearch CPU、JVMメモリ、検索レイテンシ、インデックスレート
- DynamoDB読み書きキャパシティ、スロットル率
- S3リクエスト数、エラー率
- API Gatewayレイテンシ、4XX/5XXエラー
- etc.

セキュリティ（20個）:
- 不正アクセス試行回数
- 認証失敗回数
- 異常なAPI呼び出しパターン
- ファイルアクセス権限違反
- etc.
```

---

### 7. API Gateway

#### パターン2_可用性重視:

**スペック**:
- **タイプ**: REST API
- **月間リクエスト数**: 2,500,000回
- **データ転送量**: 50GB/月
- **キャッシング**: 有効（0.5GBキャッシュ、TTL 5分）
- **WAF**: 有効（レート制限、SQLインジェクション防止）

**計算根拠**:
```
リクエスト数:
- 検索リクエスト: 1,200,000回
- AI検索: 200,000回
- ファイルメタデータ: 600,000回
- 画像プレビュー: 300,000回
- その他API: 200,000回
- 合計: 2,500,000回/月

データ転送:
- 検索結果: 1,200,000 × 15KB = 18GB
- AI検索結果: 200,000 × 20KB = 4GB
- メタデータ: 600,000 × 5KB = 3GB
- その他: 25GB
- 合計: 50GB

キャッシュ効果:
- キャッシュヒット率: 40%
- バックエンド負荷軽減: 1,000,000リクエスト削減
```

---

### 8. Cognito

#### パターン2_可用性重視:

**スペック**:
- **ユーザー数**: 100名（将来拡張想定）
- **月間アクティブユーザー (MAU)**: 50名
- **MFA**: 有効（TOTP）
- **高度なセキュリティ機能**: 有効
  - 侵害された認証情報の保護
  - アダプティブ認証
  - リスクベース認証

**月間認証数**:
- **ログイン**: 2,000回/月
- **トークンリフレッシュ**: 10,000回/月
- **MFA検証**: 2,000回/月

**計算根拠**:
```
無料枠: 50,000 MAU/月
現状: 50 MAU
→ 無料枠内

高度なセキュリティ機能:
- リスクベース認証で不正ログイン防止
- アダプティブ認証で異常検知
- 課金: $0.05/MAU → 50 × $0.05 = $2.50/月
```

---

### 9. その他サービス

#### パターン2_可用性重視:

**9.1 CloudFront**:
- **ディストリビューション数**: 2個
  - フロントエンド用
  - API用
- **データ転送量（送信）**: 200GB/月
- **リクエスト数**: 3,000,000回/月
- **地理的配信**: 日本、北米、ヨーロッパ、アジア

**9.2 ElastiCache (Redis)**:
- **ノードタイプ**: `cache.t4g.small`
- **ノード数**: 2（プライマリ + レプリカ）
- **メモリ**: 1.37GB × 2
- **構成**: Multi-AZ
- **使用用途**: セッションストア、頻繁にアクセスされるメタデータ

**9.3 NAT Gateway**:
- **構成**: Multi-AZ、2台
- **データ処理量**: 200GB/月
  - Lambda → インターネット
  - RDS → 外部API
  - データ同期

**9.4 Application Load Balancer**:
- **ALB数**: 1台
- **LCU時間**: 730時間
- **データ処理量**: 100GB/月

**9.5 AWS WAF**:
- **ルール数**: 10個
  - レート制限（100req/5min/IP）
  - SQLインジェクション防止
  - XSS防止
  - 地理的制限（日本のみ許可）
  - etc.
- **リクエスト数**: 2,500,000回/月

**9.6 Amazon SES**:
- **送信メール数**: 10,000通/月
  - アラート通知: 5,000通
  - レポート: 3,000通
  - その他: 2,000通

**9.7 EventBridge**:
- **ルール数**: 10個
- **イベント数**: 100,000回/月
  - 定期実行（cron）
  - S3イベント
  - システムイベント

**計算根拠**:
```
CloudFront:
- 静的アセット配信: 100GB
- APIレスポンス配信: 50GB
- 画像/サムネイル配信: 50GB
- 合計: 200GB

リクエスト:
- 静的アセット: 2,000,000回
- API: 500,000回（キャッシュ有効化）
- 画像: 500,000回
- 合計: 3,000,000回

ElastiCache:
- セッションストア: 50ユーザー × 10KB = 500KB
- メタデータキャッシュ: 500MB
- 検索結果キャッシュ: 300MB
- 合計: 約800MB → 1.37GBノードで十分

NAT Gateway:
- Lambda外部API呼び出し: 100GB
- RDSパッチ適用等: 50GB
- その他: 50GB
- Multi-AZ: 2台で冗長性確保
```

---

### パターン2 コストサマリー（概算）

| サービス | 月額コスト（USD） |
|---------|-----------------|
| RDS (db.t4g.medium Multi-AZ) | $120 |
| RDS Proxy | $15 |
| OpenSearch (r6g.large × 3 + マスター) | $450 |
| Lambda（実行時間） | $85 |
| Lambda（Provisioned Concurrency） | $45 |
| DynamoDB | $35 |
| S3 (500GB Multi-Tier) | $15 |
| S3 Cross-Region Replication | $10 |
| CloudWatch Logs (100GB) | $50 |
| CloudWatch Custom Metrics | $30 |
| CloudWatch Alarms | $10 |
| CloudWatch Dashboards | $15 |
| API Gateway | $10 |
| API Gateway Cache | $12 |
| Cognito Advanced Security | $2.50 |
| CloudFront | $30 |
| ElastiCache (t4g.small × 2) | $35 |
| NAT Gateway × 2 | $70 |
| Application Load Balancer | $25 |
| AWS WAF | $15 |
| Amazon SES | $1 |
| EventBridge | $1 |
| Data Transfer | $20 |
| **合計** | **約$1,105.50/月** |

---

## パターン3: 月次バッチ同期（NAS-AWS ハイブリッド / 最適化版）

### 設計方針
- **ユースケース**: 過去データのみ検索（新しいデータは検索対象外）
- **NAS-AWSハイブリッド**: ファイルはNASに保持、メタデータ・抽出テキストのみAWS
- **月次バッチ同期**: リアルタイム同期不要、月1回の増分同期
- **コスト最適化**: VPN間欠接続（月4時間のみ）で97%削減
- **フル機能**: 全文検索（Japanese kuromoji）+ 画像類似検索（k-NN）

---

### 利用想定（Pattern 3専用）

- **ユーザー数**: 50名
- **ファイル数**: 1,000,000ファイル（Pattern 1/2の20倍）
- **データ量**: 500GB（NAS側）
- **月次増分**: 20GB/月
- **月間検索数**: 10,000回（過去データ検索のみ）
- **同期頻度**: 月1回（深夜バッチ、4時間）
- **VPN接続時間**: 月4時間のみ（月1回 × 4時間）

---

### 1. ネットワーク・VPN

#### パターン3_月次バッチ:

**スペック**:
- **サービス**: AWS Site-to-Site VPN
- **接続タイプ**: IPsec VPN（ipsec.1）
- **接続時間**: **月4時間のみ**（月1回のバッチ同期時のみ）
- **VPN Gateway**: Virtual Private Gateway
- **Customer Gateway**: オンプレミス側VPNルーター
- **BGP**: 使用しない（Static Routes）

**月間使用量**:
- **接続時間料金**: 4時間/月 × $0.05/時間 = **$0.20/月**
- **データ転送（アウトバウンド）**: 20GB/月 × $0.05/GB = **$1.00/月**
- **合計**: **$1.20/月**

**計算根拠**:
```
通常のVPN（常時接続）:
- 730時間/月 × $0.05/時間 = $36.50/月

月次バッチVPN（月1回4時間のみ）:
- 4時間/月 × $0.05/時間 = $0.20/月
- 削減率: 97% 削減

VPN接続シーケンス:
1. EventBridge（月1回トリガー）
2. Lambda VPNManager → VPN接続確立
3. DataSync実行（3時間）
4. Lambda VPNManager → VPN切断
5. 残りの処理（Lambda、OpenSearchインデックス）
```

**コスト削減のポイント**:
- 常時接続不要（過去データ検索のみのため）
- VPN接続は同期時のみ（月1回、4時間）
- **97%のVPNコスト削減**

---

### 2. データ転送・同期

#### パターン3_月次バッチ:

**スペック**:
- **サービス**: AWS DataSync
- **ソース**: NAS (SMB/NFS)
- **デスティネーション**: S3
- **転送モード**: **増分のみ（CHANGED）**
- **検証モード**: POINT_IN_TIME_CONSISTENT
- **帯域制限**: 100Mbps（業務時間帯への影響回避）

**月間使用量**:
- **初回同期**: 500GB × $0.125/GB = **$62.50**（初回のみ）
- **月次増分**: 20GB/月 × $0.25/GB = **$5.00/月**
- **検証データ**: 無料（メタデータ検証のみ）

**計算根拠**:
```
初回同期（1回のみ）:
- 全ファイルメタデータ収集: 500GB
- DataSync料金（初回）: $0.125/GB（長時間転送割引）
- 初回コスト: $62.50

月次増分同期:
- 新規/更新ファイル: 20GB/月（月次成長率4%）
- DataSync料金（増分）: $0.25/GB
- 月額コスト: $5.00/月

転送時間計算:
- 20GB ÷ 100Mbps = 約27分
- バッファ含め1時間程度で完了
```

**DataSync設定**:
```typescript
const taskOptions = {
  VerifyMode: 'POINT_IN_TIME_CONSISTENT',
  TransferMode: 'CHANGED',  // 変更分のみ
  PreserveDeletedFiles: 'REMOVE',
  BytesPerSecond: 12500000,  // 100Mbps制限
};
```

---

### 3. Lambda

#### パターン3_月次バッチ:

**関数構成**:

**3.1 VPNManager**:
- **メモリ**: 512MB
- **月間実行回数**: 2回（接続1回、切断1回）
- **平均実行時間**: 5秒
- **アーキテクチャ**: ARM64 (Graviton2)

**3.2 FileScanner**:
- **メモリ**: 1024MB
- **月間実行回数**: 1回（月次バッチ）
- **平均実行時間**: 600秒（10分）
- **処理内容**: S3バケット全体スキャン、メタデータ収集
- **アーキテクチャ**: ARM64 (Graviton2)

**3.3 TextExtractor**:
- **メモリ**: 2048MB
- **月間実行回数**: 5,000回（新規/更新PDFファイルのみ）
- **平均実行時間**: 5秒
- **処理内容**: PDF/Docuworksからテキスト抽出
- **使用ライブラリ**: pdf-parse, pdfplumber
- **アーキテクチャ**: ARM64 (Graviton2)

**3.4 ImageFeatureExtractor**:
- **メモリ**: 2048MB
- **月間実行回数**: 2,000回（新規/更新画像のみ）
- **平均実行時間**: 3秒
- **処理内容**: ResNet-50で512次元特徴ベクトル抽出
- **使用ライブラリ**: PyTorch (arm64-optimized)
- **アーキテクチャ**: ARM64 (Graviton2)

**3.5 BulkIndexer**:
- **メモリ**: 1024MB
- **月間実行回数**: 1回（月次バッチ）
- **平均実行時間**: 600秒（10分）
- **処理内容**: OpenSearchへ一括インデックス登録
- **アーキテクチャ**: ARM64 (Graviton2)

**3.6 SearchAPI**:
- **メモリ**: 512MB
- **月間実行回数**: 10,000回（検索リクエスト）
- **平均実行時間**: 100ms
- **処理内容**: OpenSearch検索、結果整形
- **アーキテクチャ**: ARM64 (Graviton2)

**月間使用量**:
```
GB-秒計算（ARM64, 20%割引適用）:
- VPNManager: 2回 × 5秒 × 0.5GB = 5 GB-秒
- FileScanner: 1回 × 600秒 × 1GB = 600 GB-秒
- TextExtractor: 5,000回 × 5秒 × 2GB = 50,000 GB-秒
- ImageFeatureExtractor: 2,000回 × 3秒 × 2GB = 12,000 GB-秒
- BulkIndexer: 1回 × 600秒 × 1GB = 600 GB-秒
- SearchAPI: 10,000回 × 0.1秒 × 0.5GB = 500 GB-秒
総計: 63,705 GB-秒/月

無料枠: 400,000 GB-秒/月
課金対象: なし（無料枠内）

リクエスト数:
- 総リクエスト: 17,003回/月
- 無料枠: 1,000,000回/月
- 課金対象: なし（無料枠内）

実質Lambda料金: $1.06/月（ARM64割引適用後の推定値）
```

**ARM64 (Graviton2) 使用理由**:
- 20%のコスト削減
- PyTorch, pdf-parseなど主要ライブラリがARM64対応
- 同一性能でコスト効率向上

---

### 4. OpenSearch

#### パターン3_月次バッチ:

**スペック**:
- **ノード構成**: 1データノード（Single-AZ）
- **インスタンスタイプ**: `t3.small.search`
- **vCPU**: 2
- **メモリ**: 2GB
- **EBSストレージ**: 50GB (gp3, 3000 IOPS)
- **レプリカ数**: 0（コスト優先）
- **プラグイン**:
  - **analysis-kuromoji**（日本語形態素解析）
  - **k-NN plugin**（画像類似検索用）

**インデックス構成**:

**4.1 files_index**:
```json
{
  "mappings": {
    "properties": {
      "file_path": { "type": "text", "analyzer": "kuromoji" },
      "file_name": { "type": "text", "analyzer": "kuromoji" },
      "file_content": {
        "type": "text",
        "analyzer": "kuromoji",
        "fields": {
          "keyword": { "type": "keyword" }
        }
      },
      "file_size": { "type": "long" },
      "modified_date": { "type": "date" },
      "file_type": { "type": "keyword" },
      "image_vector": {
        "type": "knn_vector",
        "dimension": 512,
        "method": {
          "name": "hnsw",
          "space_type": "cosinesimil",
          "engine": "nmslib",
          "parameters": {
            "ef_construction": 512,
            "m": 16
          }
        }
      }
    }
  }
}
```

**月間使用量**:
- **インスタンス時間**: 730時間/月 × $0.034/時間 = **$24.82/月**
- **EBSストレージ**: 50GB × $0.135/GB = **$6.75/月**
- **合計**: **$31.57/月**

**計算根拠**:
```
インデックスサイズ:
- ファイルメタデータ: 1,000,000 × 2KB = 2GB
- 全文検索インデックス（kuromoji）: 200,000 × 100KB = 20GB
  （PDF/Docworksファイルの20%が全文検索対象）
- 画像ベクトル（k-NN）: 100,000 × 512次元 × 4バイト = 205MB
  （画像ファイルの10%）
- 合計インデックスサイズ: 約22GB → 余裕を持って50GB

検索パフォーマンス:
- 平均検索レイテンシ: 100-200ms
- 月間検索数: 10,000回（低負荷）
- t3.small.searchで十分対応可能

k-NN検索:
- HNSW algorithm (ef_construction: 512, m: 16)
- Cosine similarity
- 検索レイテンシ: 50-100ms
```

---

### 5. DynamoDB

#### パターン3_月次バッチ:

**テーブル構成**:

**5.1 file_metadata**:
- **課金モード**: On-Demand
- **読み込みキャパシティ**: 平均 1 RCU
- **書き込みキャパシティ**: 月1回バッチ時のみ
- **ストレージサイズ**: 5GB
  - 1,000,000ファイル × 5KB（パス、サイズ、日時、ハッシュ等）

**5.2 sync_jobs**:
- **課金モード**: On-Demand
- **ストレージサイズ**: 100MB
- **用途**: DataSync job履歴、エラーログ

**月間使用量**:
```
読み取りリクエスト:
- 検索時メタデータ取得: 10,000回/月
- 1リクエスト4KBまで = 10,000 RRU

書き込みリクエスト:
- 月次バッチ更新: 10,000回（変更分のみ）
- 合計: 10,000 WRU

ストレージ:
- file_metadata: 5GB × $0.25/GB = $1.25/月
- sync_jobs: 0.1GB × $0.25/GB = $0.03/月

リクエスト料金:
- Read: 10,000 × $0.25/100万 = $0.00
- Write: 10,000 × $1.25/100万 = $0.01

合計: $1.26/月
```

---

### 6. S3

#### パターン3_月次バッチ:

**バケット構成**:

**6.1 cis-filesearch-metadata**:
- **保存データサイズ**: 100GB
  - 抽出テキスト: 40GB（200,000 PDF × 200KB）
  - 画像特徴ベクトル: 10GB（100,000画像 × 100KB）
  - サムネイル: 30GB
  - ログ・その他: 20GB
- **ストレージクラス**: **S3 Intelligent-Tiering**
  - Frequent Access Tier: 60GB
  - Infrequent Access Tier: 40GB（30日以上アクセスなし）

**月間リクエスト数**:
- **PUT/POST/LIST**: 50,000回（月次バッチ時）
- **GET/SELECT**: 50,000回（検索・プレビュー時）

**データ転送量**:
- **送信（Internet）**: 10GB/月
- **受信**: 20GB/月（DataSync経由）

**月間使用量**:
```
ストレージ:
- Frequent Access: 60GB × $0.023/GB = $1.38
- Infrequent Access: 40GB × $0.0125/GB = $0.50

リクエスト:
- PUT: 50,000 × $0.005/1,000 = $0.25
- GET: 50,000 × $0.0004/1,000 = $0.02

データ転送:
- 送信: 10GB × 無料枠内 = $0.00

合計: $2.15/月
```

**Intelligent-Tiering の利点**:
- 自動階層化（30日、90日）
- アクセスパターンに応じた最適化
- 追加料金なし（監視・自動化料金込み）

---

### 7. Step Functions

#### パターン3_月次バッチ:

**ステートマシン**: MonthlyBatchSyncWorkflow

**ワークフロー**:
1. **VPN接続** (VPNManager Lambda)
2. **DataSync実行** (AWS DataSync Task)
3. **ファイルスキャン** (FileScanner Lambda)
4. **並列処理**:
   - TextExtractor (5,000並列)
   - ImageFeatureExtractor (2,000並列)
5. **一括インデックス** (BulkIndexer Lambda)
6. **VPN切断** (VPNManager Lambda)
7. **通知** (SNS)

**月間使用量**:
```
State Transitions:
- ワークフロー: 約20ステップ
- 実行回数: 1回/月
- 総Transitions: 20回/月

料金:
- 20 transitions × $0.025/1,000 = $0.0005
- 実質無料（最小課金単位未満）

合計: $0.00/月
```

---

### 8. CloudWatch

#### パターン3_月次バッチ:

**ログ収集**:
- **ログ取り込み量**: 2GB/月
- **ログ保存期間**: 7日
- **ログソース**:
  - Lambda実行ログ: 1GB
  - DataSyncログ: 500MB
  - Step Functionsログ: 100MB
  - OpenSearchログ: 400MB

**メトリクス**:
- **カスタムメトリクス**: 10個
  - バッチ実行時間
  - 処理ファイル数
  - エラー数
  - 検索レスポンスタイム
  - OpenSearch CPU使用率

**アラーム**:
- **アラーム数**: 5個
  - バッチ失敗
  - VPN接続失敗
  - OpenSearchディスク使用率 > 80%
  - 検索エラー率 > 5%
  - Lambda同時実行数上限

**月間使用量**:
```
ログ料金:
- 取り込み: 2GB × $0.50/GB = $1.00

カスタムメトリクス:
- 10メトリクス × $0.30/メトリクス = $3.00

合計: $4.00/月
```

---

### 9. EventBridge

#### パターン3_月次バッチ:

**スケジュールルール**:
- **ルール名**: MonthlyBatchTrigger
- **スケジュール**: `cron(0 2 1 * ? *)`（毎月1日 深夜2時）
- **ターゲット**: Step Functions (MonthlyBatchSyncWorkflow)

**月間使用量**:
```
ルール料金:
- 1ルール × $1.00/月 = $1.00

イベント料金:
- 1イベント/月 × 無料枠 = $0.00

合計: $1.00/月
```

---

### 10. SNS

#### パターン3_月次バッチ:

**トピック**:
- **トピック名**: BatchNotifications
- **サブスクライバー**: Email (管理者5名)

**月間使用量**:
```
通知数:
- バッチ成功通知: 1回/月
- エラー通知: 最大10回/月（想定）
- 合計: 10メッセージ/月

料金:
- 10 × $0.50/100万 = $0.00（無料枠内）

合計: $0.00/月
```

---

### パターン3 コストサマリー（概算）

| サービス | 月額コスト（USD） | 構成比 |
|---------|-----------------|-------|
| VPN（月4時間のみ） | $1.20 | 2.5% |
| DataSync（増分20GB） | $5.00 | 10.6% |
| Lambda（ARM64） | $1.06 | 2.2% |
| OpenSearch (t3.small.search) | $31.57 | 66.8% |
| DynamoDB | $1.26 | 2.7% |
| S3 Intelligent-Tiering | $2.15 | 4.6% |
| Step Functions | $0.00 | 0.0% |
| CloudWatch | $4.00 | 8.5% |
| EventBridge | $1.00 | 2.1% |
| SNS | $0.00 | 0.0% |
| **合計** | **$47.24/月** | **100%** |

**初期投資**:
- DataSync 初回同期: $62.50（1回のみ）
- テスト環境運用: $47.24（1ヶ月分）
- **初期投資合計**: $109.74

**年間コスト**:
- Year 1: $676.62（初期投資 + 月額×12）
- Year 2-3: $566.88/年
- **3年間TCO**: $1,810.38

---

### パターン3の主要な特徴

#### コスト削減のポイント

| 削減項目 | 削減額/月 (USD) | 削減率 | 説明 |
|---------|---------------|--------|------|
| VPN常時接続 → 月4時間 | $34.80 | 97% | 730h → 4h |
| DataSync リアルタイム → 増分 | $15.00 | 75% | 100GB → 20GB |
| Lambda常時 → 月次バッチ | $13.94 | 93% | バッチ化で効率化 |
| Lambda x86 → ARM64 | $0.27 | 20% | Graviton2使用 |
| S3 STANDARD → Intelligent-Tiering | $1.20 | 36% | 自動階層化 |
| **合計削減額** | **$65.21/月** | **58%** | vs リアルタイム構成 |

#### 技術的特徴

1. **日本語全文検索**: OpenSearch + kuromoji plugin
2. **画像類似検索**: k-NN plugin + ResNet-50（512次元）
3. **ハイブリッドアーキテクチャ**: ファイル実体はNAS、メタデータ・抽出テキストのみAWS
4. **バッチオーケストレーション**: Step Functions で信頼性の高いワークフロー
5. **ARM64最適化**: 全Lambda関数でGraviton2使用

#### 適用条件

✅ **適している場合**:
- 過去データのみ検索（新しいデータは検索不要）
- リアルタイム同期不要
- 月1回の同期で十分
- コスト最優先
- ファイル数が多い（100万件以上）

❌ **適していない場合**:
- リアルタイム検索が必要
- 新しいファイルも即座に検索したい
- 高可用性が必須（Multi-AZ必要）
- 24時間365日のVPN接続が必要

---

## パターン比較サマリー

### コスト比較

| 項目 | パターン1<br>（コスト優先） | パターン2<br>（可用性重視） | パターン3<br>（月次バッチ） | P3 vs P1 | P3 vs P2 |
|------|---------------------|---------------------|---------------------|---------|---------|
| **月額コスト** | $90.40 | $1,105.50 | **$47.24** | **-48%** | **-96%** |
| **年額コスト** | $1,084.80 | $13,266.00 | $566.88 | -48% | -96% |
| **3年間TCO** | $3,254.40 | $39,798.00 | **$1,810.38** | **-44%** | **-95%** |
| **初期投資** | $0 | $0 | $109.74 | - | - |

### 機能比較

| 機能 | パターン1 | パターン2 | パターン3 |
|------|----------|----------|----------|
| **基本検索** | ✅ | ✅ | ✅ |
| **全文検索** | ✅（シンプル） | ✅（高度） | ✅（高度 + kuromoji） |
| **画像類似検索** | ❌ | ✅ | ✅（k-NN） |
| **AI機能** | ❌ | ✅ | ❌ |
| **リアルタイム同期** | 手動 | リアルタイム | **月次バッチ** |
| **データ保管場所** | AWS | AWS | **NAS（ハイブリッド）** |
| **ファイル実体アクセス** | S3 | S3 | NAS（変更なし） |
| **検索対象** | 全データ | 全データ | **過去データのみ** |
| **VPN接続** | - | 常時 | **月4時間のみ** |
| **Multi-AZ** | ❌ | ✅ | ❌ |
| **バックアップ** | 最小限（7日） | 充実（30日） | 最小限（7日） |
| **監視** | 基本のみ | 包括的 | 基本的 |
| **キャッシング** | DynamoDBのみ | ElastiCache + DynamoDB | DynamoDBのみ |
| **CDN** | なし | CloudFront | なし |
| **想定ファイル数** | 50,000 | 50,000 | **1,000,000** |

### 可用性比較

| 項目 | パターン1 | パターン2 | パターン3 |
|------|----------|----------|----------|
| **RTO（目標復旧時間）** | 4-8時間 | 1-2時間 | 4-8時間 |
| **RPO（目標復旧時点）** | 24時間 | 5分 | **1ヶ月** |
| **稼働率（SLA）** | 99%（推定） | 99.9%（推定） | 99%（推定） |
| **障害時の影響** | 全機能停止 | 自動フェイルオーバー | 全機能停止 |
| **データ同期遅延** | 手動 | リアルタイム | **最大1ヶ月** |

### パフォーマンス比較

| 項目 | パターン1 | パターン2 | パターン3 |
|------|----------|----------|----------|
| **平均検索レスポンス** | 2-5秒 | 0.5-2秒 | 0.1-0.2秒 |
| **ピーク時レスポンス** | 5-10秒 | 1-3秒 | 0.2-0.5秒 |
| **同時接続数** | 10-20ユーザー | 50+ユーザー | 50ユーザー |
| **スケーラビリティ** | 制限あり | 高い | 中程度 |
| **月間検索数想定** | 1,000,000回 | 1,500,000回 | **10,000回** |

---

## 推奨事項

### ユースケース別推奨パターン

#### 推奨パターンの選択基準

| ユースケース | 推奨パターン | 理由 |
|------------|------------|------|
| **過去データのみ検索**<br>（新データは検索不要） | **パターン3（月次バッチ）** | **最もコスト効率が高い**<br>VPN・DataSyncコストを97%削減<br>ファイル数100万件以上に対応 |
| **少量ファイル・低頻度検索** | パターン1（コスト優先） | 基本機能のみで十分<br>初期投資を最小化 |
| **本格運用・高可用性必須** | パターン2（可用性重視） | Multi-AZ構成<br>リアルタイム同期<br>AI機能フル搭載 |

---

### フェーズ別推奨（従来型プロジェクト）

**Phase 1（初期3ヶ月）: パターン1でスタート**
- 初期投資を抑えて基本機能を実装
- ユーザーフィードバック収集
- 実際の使用パターン分析
- **月額コスト**: $90

**Phase 2-3（4-7ヶ月）: ハイブリッド構成**
- RDSをMulti-AZにアップグレード（+$50）
- OpenSearchを2ノードに拡張（+$30）
- CloudWatchログ保存期間延長（+$10）
- **月額コスト**: $180

**Phase 4以降（8ヶ月目〜）: パターン2へ移行**
- 本格運用開始
- AI機能追加
- 完全な高可用性構成
- **月額コスト**: $1,105

---

### 最適化プロジェクト推奨（過去データ検索のみ）

**🎯 推奨: パターン3で直接スタート**

**Week 1-2: インフラ構築**
- VPN設定（間欠接続設定）
- DataSync設定（増分同期）
- Step Functions ワークフロー構築
- **構築期間**: 2週間

**Week 3-4: Lambda関数開発**
- TextExtractor（PDF/Docuworks）
- ImageFeatureExtractor（ResNet-50）
- BulkIndexer（OpenSearch）
- **開発期間**: 2週間

**Week 5-6: OpenSearch設定**
- kuromoji plugin 設定
- k-NN plugin 設定
- インデックスマッピング作成
- **設定期間**: 2週間

**Week 7-8: テスト・本番稼働**
- 初回同期実行（500GB）
- 検索パフォーマンステスト
- 本番稼働開始
- **稼働開始**: 8週間後

**総コスト（8週間）**:
- 開発期間（2ヶ月）: $47.24 × 2 = $94.48
- 初回同期: $62.50
- **合計**: $156.98

**本番稼働後**:
- **月額コスト**: $47.24/月
- **3年間TCO**: $1,810.38

### コスト最適化の追加提案

1. **Savings Plans / Reserved Instances**
   - RDS 1年RI: 30-40%削減
   - OpenSearch RI: 30%削減
   - 年額 $13,266 → 約 $9,300（$3,966削減）

2. **スポットインスタンス（開発環境）**
   - 開発環境で70%コスト削減

3. **S3 Intelligent-Tiering**
   - 自動階層化で20-30%削減

4. **Lambda SnapStart（Java/Python）**
   - コールドスタート削減でProvisioned Concurrency不要に

5. **CloudWatch Logs Insights代替**
   - Athenaでログ分析（コスト50%削減）

---

## 次のステップ

1. **Phase 1開始時**:
   - パターン1で環境構築
   - Terraform/CloudFormationでIaC化
   - 監視・アラート設定

2. **運用3ヶ月後**:
   - 実使用データ分析
   - ボトルネック特定
   - コスト最適化レビュー

3. **Phase 4移行前**:
   - パターン2へのマイグレーション計画
   - ダウンタイム最小化戦略
   - 段階的スケールアップ

---

## 改訂履歴

| 版数 | 日付 | 改訂内容 | 作成者 |
|------|------|----------|--------|
| 1.0 | 2025-10-18 | 初版作成（詳細サイジング） | CIS開発チーム |
| 1.1 | 2025-01-18 | パターン3（月次バッチ同期）追加<br>- NAS-AWSハイブリッドアーキテクチャ<br>- VPN間欠接続（月4時間）<br>- kuromoji + k-NN対応<br>- ARM64 (Graviton2) 最適化<br>- コスト96%削減（vs Pattern 2） | CIS開発チーム |
