# S3 Bucket ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰ï¼ˆDataSyncå®Ÿè£…ç”¨ï¼‰

**ä½œæˆæ—¥**: 2025-01-12
**å¯¾è±¡**: Week 1 Day 1-2
**æ‰€è¦æ™‚é–“**: 20åˆ†
**å‰ææ¡ä»¶**: AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€AdministratorAccessæ¨©é™ã€IAM Rolesä½œæˆå®Œäº†

---

## ğŸ“‹ ä½œæˆã™ã‚‹S3ãƒã‚±ãƒƒãƒˆ

| ãƒã‚±ãƒƒãƒˆå | ç”¨é€” | ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ | æš—å·åŒ– | ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚° |
|-----------|------|-----------|--------|--------------|
| `cis-filesearch-raw-files-prod` | DataSyncã‹ã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡ã€EventBridgeçµŒç”±ã§EC2å‡¦ç† | ap-northeast-1 | AES-256 | æœ‰åŠ¹ |

---

## ğŸª£ S3 Bucketä½œæˆæ‰‹é †

### Step 1: S3 Consoleã«ã‚¢ã‚¯ã‚»ã‚¹

```
1. AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°ã‚¤ãƒ³
2. ã‚µãƒ¼ãƒ“ã‚¹æ¤œç´¢ã§ã€ŒS3ã€ã¨å…¥åŠ›
3. S3 Dashboard â†’ ã€Œãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
```

---

### Step 2: ä¸€èˆ¬çš„ãªè¨­å®š

#### ãƒã‚±ãƒƒãƒˆå

```
ãƒã‚±ãƒƒãƒˆå: cis-filesearch-raw-files-prod
```

**æ³¨æ„äº‹é …**:
- âœ… S3ãƒã‚±ãƒƒãƒˆåã¯å…¨ä¸–ç•Œã§ä¸€æ„ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
- âœ… å°æ–‡å­—ã€æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ï¼ˆ-ï¼‰ã®ã¿ä½¿ç”¨å¯èƒ½
- âŒ ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼ˆ_ï¼‰ã‚„ãƒ”ãƒªã‚ªãƒ‰ï¼ˆ.ï¼‰ã¯éæ¨å¥¨

#### AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³

```
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³: ã‚¢ã‚¸ã‚¢ãƒ‘ã‚·ãƒ•ã‚£ãƒƒã‚¯ï¼ˆæ±äº¬ï¼‰
ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰: ap-northeast-1
```

**ç†ç”±**:
- DataSync Agentï¼ˆæ—¥æœ¬å›½å†…ï¼‰ã¨ã®ç‰©ç†çš„è·é›¢ãŒæœ€çŸ­
- ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚³ã‚¹ãƒˆæœ€å°åŒ–
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æœ€å°åŒ–

#### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ‰€æœ‰è€…

```
é¸æŠ: ACLç„¡åŠ¹ï¼ˆæ¨å¥¨ï¼‰
```

**èª¬æ˜**: ãƒã‚±ãƒƒãƒˆæ‰€æœ‰è€…ãŒå…¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªå‹•çš„ã«æ‰€æœ‰ã—ã¾ã™ã€‚DataSyncãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ãƒã‚±ãƒƒãƒˆæ‰€æœ‰è€…ãŒæ‰€æœ‰ã—ã¾ã™ã€‚

---

### Step 3: ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹è¨­å®š

```
ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã¹ã¦ãƒ–ãƒ­ãƒƒã‚¯: âœ… ãƒã‚§ãƒƒã‚¯ï¼ˆæœ‰åŠ¹ï¼‰
```

**4ã¤ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å…¨ã¦ã«ãƒã‚§ãƒƒã‚¯**:
- [x] æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ (ACL) ã‚’ä»‹ã—ã¦ä»˜ä¸ã•ã‚ŒãŸãƒã‚±ãƒƒãƒˆã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹
- [x] ä»»æ„ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ (ACL) ã‚’ä»‹ã—ã¦ä»˜ä¸ã•ã‚ŒãŸãƒã‚±ãƒƒãƒˆã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹
- [x] æ–°ã—ã„ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆãƒãƒªã‚·ãƒ¼ã‚’ä»‹ã—ã¦ä»˜ä¸ã•ã‚ŒãŸãƒã‚±ãƒƒãƒˆã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹
- [x] ä»»æ„ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã¾ãŸã¯ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚¤ãƒ³ãƒˆãƒãƒªã‚·ãƒ¼ã‚’ä»‹ã—ãŸãƒã‚±ãƒƒãƒˆã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹

**ç†ç”±**: å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã®ãŸã‚ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ä¸€åˆ‡ä¸è¦

---

### Step 4: ãƒã‚±ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°

```
ãƒã‚±ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°: âœ… æœ‰åŠ¹åŒ–
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
- èª¤ã£ã¦ä¸Šæ›¸ããƒ»å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å…ƒãŒå¯èƒ½
- DataSyncãŒåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã§æ›´æ–°ã—ãŸå ´åˆã€å±¥æ­´ãŒä¿å­˜ã•ã‚Œã‚‹
- ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´å±¥æ­´ã®è¿½è·¡ï¼‰ã«å¯¾å¿œ

**ã‚³ã‚¹ãƒˆå½±éŸ¿**:
- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã¯å¢—åŠ ã™ã‚‹ãŒã€Intelligent-Tieringã§æœ€é©åŒ–å¯èƒ½
- æœˆæ¬¡ãƒãƒƒãƒå®Ÿè¡Œã®ãŸã‚ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³è“„ç©ã¯é™å®šçš„

---

### Step 5: ã‚¿ã‚°

```
ã‚¿ã‚°ã‚’è¿½åŠ :
  - Key: Project,      Value: CIS-FileSearch
  - Key: Component,    Value: DataSync-Destination
  - Key: Environment,  Value: Production
  - Key: CostCenter,   Value: IT-Infrastructure
```

**ç”¨é€”**: ã‚³ã‚¹ãƒˆé…åˆ†ã€ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã€è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

---

### Step 6: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæš—å·åŒ–

```
æš—å·åŒ–ã‚¿ã‚¤ãƒ—: ã‚µãƒ¼ãƒãƒ¼å´ã®æš—å·åŒ– Amazon S3 ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚­ãƒ¼ (SSE-S3)
```

**è¨­å®šè©³ç´°**:
- **æš—å·åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: AES-256
- **ãƒã‚±ãƒƒãƒˆã‚­ãƒ¼**: æœ‰åŠ¹åŒ–ï¼ˆKMSãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰Šæ¸›ã«ã‚ˆã‚‹ã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰

**AWS KMS vs SSE-S3 æ¯”è¼ƒ**:

| é …ç›® | SSE-S3 | AWS KMS (CMK) |
|------|--------|---------------|
| æš—å·åŒ–å¼·åº¦ | AES-256 | AES-256 |
| ã‚­ãƒ¼ç®¡ç† | AWSè‡ªå‹•ç®¡ç† | ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†å¯èƒ½ |
| ç›£æŸ»ãƒ­ã‚° | é™å®šçš„ | CloudTrailã§è©³ç´°è¨˜éŒ² |
| ã‚³ã‚¹ãƒˆ | ç„¡æ–™ | $1/æœˆ + APIå‘¼ã³å‡ºã—èª²é‡‘ |
| ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ | IAM Policy | KMSã‚­ãƒ¼ãƒãƒªã‚·ãƒ¼ + IAM |

**ä»Šå›ã®é¸æŠç†ç”±**: SSE-S3ã§ååˆ†ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã€ã‚³ã‚¹ãƒˆæœ€é©åŒ–å„ªå…ˆ

---

### Step 7: è©³ç´°è¨­å®š

#### ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ­ãƒƒã‚¯

```
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ­ãƒƒã‚¯: âŒ ç„¡åŠ¹
```

**ç†ç”±**: WORMï¼ˆWrite Once Read Manyï¼‰è¦ä»¶ãªã—ã€é€šå¸¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã§ååˆ†

#### S3 Intelligent-Tiering ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è¨­å®š

```
Intelligent-Tiering ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–è¨­å®š:
  âœ… Archive Access tier: 90æ—¥é–“ã‚¢ã‚¯ã‚»ã‚¹ãªã—
  âœ… Deep Archive Access tier: 180æ—¥é–“ã‚¢ã‚¯ã‚»ã‚¹ãªã—
```

**ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ**:
- é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•çš„ã«ä½ã‚³ã‚¹ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å±¤ã«ç§»å‹•
- Archive Access tier: 68%ã‚³ã‚¹ãƒˆå‰Šæ¸›
- Deep Archive tier: 95%ã‚³ã‚¹ãƒˆå‰Šæ¸›

**é©ç”¨ã‚·ãƒŠãƒªã‚ª**: æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆå¾Œã€å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¢ã‚¯ã‚»ã‚¹é »åº¦ãŒä½ä¸‹

---

### Step 8: ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆ

```
ã€Œãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
```

**æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›**:
```
âœ… ãƒã‚±ãƒƒãƒˆ cis-filesearch-raw-files-prod ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸã€‚
```

---

## ğŸ”” S3ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥è¨­å®šï¼ˆEventBridgeçµŒç”±ï¼‰

DataSyncãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸã¨ãã«ã€EventBridge â†’ SQS â†’ EC2 Workersã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã‚’è¨­å®šã—ã¾ã™ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ•ãƒ­ãƒ¼

```
S3 (Object Created)
  â†“
EventBridge Rule (S3 Event Pattern)
  â†“
SQS Queue (cis-filesearch-processing-queue)
  â†“
EC2 Auto Scaling Group (Spot Instances)
  â†“
Python Workers â†’ OpenSearch
```

### Step 1: ãƒã‚±ãƒƒãƒˆã‚’é–‹ã

```
S3 Console â†’ ãƒã‚±ãƒƒãƒˆä¸€è¦§ â†’ ã€Œcis-filesearch-raw-files-prodã€ã‚’ã‚¯ãƒªãƒƒã‚¯
```

### Step 2: ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¿ãƒ–

```
ã€Œãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã€ŒAmazon EventBridgeã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
```

### Step 3: EventBridgeé€šçŸ¥ã‚’æœ‰åŠ¹åŒ–

```
Amazon EventBridge:
  âœ… ã‚ªãƒ³ï¼ˆæœ‰åŠ¹ï¼‰

èª¬æ˜:
  ã“ã®ãƒã‚±ãƒƒãƒˆã®ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã‚’EventBridgeã«é€ä¿¡ã—ã¾ã™ã€‚
  EventBridge Ruleã§æŸ”è»Ÿãªã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨è¤‡æ•°ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®šãŒå¯èƒ½ã§ã™ã€‚
```

**æ³¨æ„**: å¾“æ¥ã®S3ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ï¼ˆLambdaç›´æ¥ãƒˆãƒªã‚¬ãƒ¼)ã§ã¯ãªãã€EventBridgeçµŒç”±ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

### Step 4: EventBridge Ruleä½œæˆ

```
1. EventBridge Console â†’ Rules â†’ Create rule
2. Rule name: CIS-S3-ObjectCreated-to-SQS
3. Event bus: default
4. Rule type: Rule with an event pattern
```

#### ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

```json
{
  "source": ["aws.s3"],
  "detail-type": ["Object Created"],
  "detail": {
    "bucket": {
      "name": ["cis-filesearch-raw-files-prod"]
    }
  }
}
```

#### ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š

```
Target type: AWS service
Select a target: SQS queue

Queue: cis-filesearch-processing-queue
```

**æ³¨æ„**: SQS Queueã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®šã¯**Week 2 Day 2ï¼ˆSQS & EC2ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼‰**ã«å®Ÿæ–½ã—ã¾ã™ã€‚

**ä¸€æ—¦ä¿å­˜ã›ãšã€å¾Œå›ã—**ã«ãƒãƒ¼ã‚¯ã—ã¾ã™ã€‚

---

## ğŸ“Š ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼è¨­å®šï¼ˆDataSyncå°‚ç”¨ï¼‰

DataSync TaskãŒç¢ºå®Ÿã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã€ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚

### Step 1: ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚¿ãƒ–

```
ã€Œã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã€Œãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ â†’ ã€Œç·¨é›†ã€
```

### Step 2: ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼JSON

ä»¥ä¸‹ã®ãƒãƒªã‚·ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowDataSyncTaskExecution",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::770923989980:role/CIS-DataSync-Task-Execution-Role"
      },
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:GetObjectTagging",
        "s3:PutObjectTagging",
        "s3:DeleteObject",
        "s3:ListBucket",
        "s3:GetBucketLocation"
      ],
      "Resource": [
        "arn:aws:s3:::cis-filesearch-raw-files-prod",
        "arn:aws:s3:::cis-filesearch-raw-files-prod/*"
      ]
    },
    {
      "Sid": "AllowEC2WorkerS3Access",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::770923989980:role/CIS-EC2-FileProcessor-Role"
      },
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion",
        "s3:GetObjectAttributes",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::cis-filesearch-raw-files-prod",
        "arn:aws:s3:::cis-filesearch-raw-files-prod/*"
      ]
    },
    {
      "Sid": "DenyInsecureTransport",
      "Effect": "Deny",
      "Principal": "*",
      "Action": "s3:*",
      "Resource": [
        "arn:aws:s3:::cis-filesearch-raw-files-prod",
        "arn:aws:s3:::cis-filesearch-raw-files-prod/*"
      ],
      "Condition": {
        "Bool": {
          "aws:SecureTransport": "false"
        }
      }
    }
  ]
}
```

**ãƒãƒªã‚·ãƒ¼èª¬æ˜**:
1. **Statement 1**: DataSync Roleã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¨©é™ã‚’ä»˜ä¸
2. **Statement 2**: EC2 Worker Roleã«èª­ã¿å–ã‚Šãƒ»å‰Šé™¤æ¨©é™ã‚’ä»˜ä¸ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†å¾Œã®å‰Šé™¤å«ã‚€ï¼‰
3. **Statement 3**: HTTPï¼ˆéæš—å·åŒ–ï¼‰ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦ï¼ˆHTTPSå¼·åˆ¶ï¼‰

### Step 3: ä¿å­˜

```
ã€Œå¤‰æ›´ã®ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
```

---

## ğŸ”„ S3ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼è¨­å®šï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰

å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚„å‰Šé™¤ãƒãƒ¼ã‚«ãƒ¼ã‚’è‡ªå‹•å‰Šé™¤ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã—ã¾ã™ã€‚

### Step 1: ç®¡ç†ã‚¿ãƒ–

```
ã€Œç®¡ç†ã€ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯
ã€Œãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
```

### Step 2: ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«ã®ä½œæˆ

#### ãƒ«ãƒ¼ãƒ«å

```
ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«å: CIS-Cleanup-Old-Versions
```

#### ãƒ«ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—

```
ãƒ«ãƒ¼ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—: âœ… ãƒã‚±ãƒƒãƒˆå†…ã®ã™ã¹ã¦ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é©ç”¨
```

#### ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

```
âœ… ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹
âœ… æœŸé™åˆ‡ã‚Œã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ãƒãƒ¼ã‚«ãƒ¼ã¾ãŸã¯ä¸å®Œå…¨ãªãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹
```

#### ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«ã®è©³ç´°

```
ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å®Œå…¨ã«å‰Šé™¤:
  ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãªã£ã¦ã‹ã‚‰: 90æ—¥å¾Œ

æœŸé™åˆ‡ã‚Œã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤: âœ… æœ‰åŠ¹

ä¸å®Œå…¨ãªãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å‰Šé™¤:
  ãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹å¾Œ: 7æ—¥å¾Œ
```

**ã‚³ã‚¹ãƒˆå‰Šæ¸›åŠ¹æœ**:
- 90æ—¥çµŒéã—ãŸå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è‡ªå‹•å‰Šé™¤ â†’ é•·æœŸã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆå‰Šæ¸›
- å¤±æ•—ã—ãŸãƒãƒ«ãƒãƒ‘ãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’7æ—¥å¾Œã«å‰Šé™¤ â†’ ä¸è¦ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸èª²é‡‘å›é¿

### Step 3: ãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆ

```
ã€Œãƒ«ãƒ¼ãƒ«ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
```

---

## âœ… ä½œæˆå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### AWS CLIã§ç¢ºèª

```bash
# ãƒã‚±ãƒƒãƒˆå­˜åœ¨ç¢ºèª
aws s3 ls s3://cis-filesearch-raw-files-prod --profile AdministratorAccess-770923989980

# ãƒã‚±ãƒƒãƒˆè©³ç´°æƒ…å ±
aws s3api get-bucket-versioning \
  --bucket cis-filesearch-raw-files-prod \
  --profile AdministratorAccess-770923989980

aws s3api get-bucket-encryption \
  --bucket cis-filesearch-raw-files-prod \
  --profile AdministratorAccess-770923989980

aws s3api get-bucket-policy \
  --bucket cis-filesearch-raw-files-prod \
  --profile AdministratorAccess-770923989980
```

### æ‰‹å‹•ç¢ºèªï¼ˆAWS Consoleï¼‰

```
S3 Console â†’ cis-filesearch-raw-files-prod ã§ä»¥ä¸‹ã‚’ç¢ºèª:

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¿ãƒ–:
  âœ… ãƒã‚±ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°: æœ‰åŠ¹
  âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æš—å·åŒ–: SSE-S3ï¼ˆAES-256ï¼‰
  âœ… Intelligent-Tiering: æœ‰åŠ¹ï¼ˆ90æ—¥Archive, 180æ—¥Deep Archiveï¼‰
  âœ… Amazon EventBridge: æœ‰åŠ¹
  â³ EventBridge Rule: å¾Œã§è¨­å®šï¼ˆSQS Queueä½œæˆå¾Œï¼‰

ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ã‚¿ãƒ–:
  âœ… ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒ–ãƒ­ãƒƒã‚¯: ã™ã¹ã¦æœ‰åŠ¹
  âœ… ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼: DataSync/EC2 Worker Roleè¨±å¯ã€HTTPSå¼·åˆ¶

ç®¡ç†ã‚¿ãƒ–:
  âœ… ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«: CIS-Cleanup-Old-Versionsï¼ˆ90æ—¥å¾Œå‰Šé™¤ï¼‰
```

---

## ğŸ“ ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’è¨˜éŒ²

`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã‚’è¿½åŠ :

```bash
# /frontend/backend/file-scanner/.env

# S3 Bucket (DataSync Destination)
S3_BUCKET_NAME=cis-filesearch-raw-files-prod
S3_BUCKET_ARN=arn:aws:s3:::cis-filesearch-raw-files-prod
S3_REGION=ap-northeast-1
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

ãƒã‚±ãƒƒãƒˆãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ã€å°ã•ãªãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

```bash
# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
echo "DataSync Test File - $(date)" > /tmp/datasync-test.txt

# S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
aws s3 cp /tmp/datasync-test.txt \
  s3://cis-filesearch-raw-files-prod/test/ \
  --profile AdministratorAccess-770923989980

# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç¢ºèª
aws s3 ls s3://cis-filesearch-raw-files-prod/test/ \
  --profile AdministratorAccess-770923989980

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
# 2025-01-12 14:30:00         45 datasync-test.txt
```

### æš—å·åŒ–ç¢ºèª

```bash
# ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã§æš—å·åŒ–æ–¹å¼ã‚’ç¢ºèª
aws s3api head-object \
  --bucket cis-filesearch-raw-files-prod \
  --key test/datasync-test.txt \
  --profile AdministratorAccess-770923989980 \
  --query 'ServerSideEncryption'

# æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›: "AES256"
```

### ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤

```bash
aws s3 rm s3://cis-filesearch-raw-files-prod/test/datasync-test.txt \
  --profile AdministratorAccess-770923989980
```

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Issue 1: "Bucket name already exists"

**åŸå› **: S3ãƒã‚±ãƒƒãƒˆåã¯å…¨ä¸–ç•Œã§ä¸€æ„
**å¯¾å‡¦æ³•**:
```
åˆ¥ã®åå‰ã‚’è©¦ã™:
  - cis-filesearch-raw-files-prod-20250112
  - cis-filesearch-raw-files-prod-jp
  - cis-filesearch-raw-770923989980-prod
```

### Issue 2: "Access Denied" during bucket policy update

**åŸå› **: IAMæ¨©é™ä¸è¶³
**å¯¾å‡¦æ³•**:
```bash
# å¿…è¦ãªIAMæ¨©é™ã‚’ç¢ºèª
aws iam get-user-policy \
  --user-name YourUserName \
  --policy-name YourPolicyName \
  --profile AdministratorAccess-770923989980
```

å¿…è¦ãªæ¨©é™: `s3:PutBucketPolicy`, `s3:CreateBucket`, `s3:PutBucketVersioning`

### Issue 3: Intelligent-Tieringè¨­å®šãŒè¦‹ã¤ã‹ã‚‰ãªã„

**åŸå› **: å¤ã„S3 Console UIã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
**å¯¾å‡¦æ³•**:
```
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
2. æ–°ã—ã„ã‚¿ãƒ–ã§S3 Consoleã‚’é–‹ã
3. ã¾ãŸã¯ã€AWS CLIã§è¨­å®š:

aws s3api put-bucket-intelligent-tiering-configuration \
  --bucket cis-filesearch-raw-files-prod \
  --id default-archive-config \
  --intelligent-tiering-configuration '{
    "Id": "default-archive-config",
    "Status": "Enabled",
    "Tierings": [
      {
        "Days": 90,
        "AccessTier": "ARCHIVE_ACCESS"
      },
      {
        "Days": 180,
        "AccessTier": "DEEP_ARCHIVE_ACCESS"
      }
    ]
  }' \
  --profile AdministratorAccess-770923989980
```

---

## ğŸ’° ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š

### æƒ³å®šãƒ‡ãƒ¼ã‚¿é‡
- ãƒ•ã‚¡ã‚¤ãƒ«æ•°: 500ä¸‡
- ç·ãƒ‡ãƒ¼ã‚¿é‡: 10TB
- æœˆæ¬¡å¢—åˆ†: 500GB

### S3ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆï¼ˆæœˆé¡ï¼‰

| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒ©ã‚¹ | ãƒ‡ãƒ¼ã‚¿é‡ | å˜ä¾¡ï¼ˆ/GB/æœˆï¼‰ | æœˆé¡ã‚³ã‚¹ãƒˆ |
|----------------|---------|---------------|-----------|
| Standardï¼ˆæœ€åˆ3ãƒ¶æœˆï¼‰ | 10TB | $0.025 | $256 |
| Intelligent-Tiering (3ãƒ¶æœˆå¾Œ) | 8TB (20%ãŒArchiveç§»è¡Œ) | $0.0125 å¹³å‡ | $128 |
| Archive Access | 2TB | $0.005 | $10 |

**å¹´é–“ã‚³ã‚¹ãƒˆå‰Šæ¸›**: ç´„$1,500ï¼ˆIntelligent-Tieringæ¡ç”¨æ™‚ï¼‰

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [S3 Bucket Naming Rules](https://docs.aws.amazon.com/AmazonS3/latest/userguide/bucketnamingrules.html)
- [S3 Event Notifications](https://docs.aws.amazon.com/AmazonS3/latest/userguide/NotificationHowTo.html)
- [S3 Intelligent-Tiering](https://aws.amazon.com/s3/storage-classes/intelligent-tiering/)
- [S3 Lifecycle Configuration](https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html)

---

## âœ… å®Œäº†ç¢ºèª

- [ ] S3ãƒã‚±ãƒƒãƒˆ `cis-filesearch-raw-files-prod` ä½œæˆå®Œäº†
- [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹åŒ–ç¢ºèª
- [ ] æš—å·åŒ–è¨­å®šï¼ˆSSE-S3ï¼‰ç¢ºèª
- [ ] ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼è¨­å®šå®Œäº†
- [ ] Intelligent-Tieringè¨­å®šå®Œäº†
- [ ] ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ«ãƒ¼ãƒ«è¨­å®šå®Œäº†
- [ ] ãƒ†ã‚¹ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ
- [ ] ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’ `.env` ã«è¨˜éŒ²å®Œäº†
- [ ] Amazon EventBridgeæœ‰åŠ¹åŒ–å®Œäº†
- [ ] â³ EventBridge Ruleè¨­å®šï¼ˆSQS Queueä½œæˆå¾Œï¼‰

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**: [03-cloudwatch-logs-setup-guide.md](./03-cloudwatch-logs-setup-guide.md) - CloudWatch Logsè¨­å®š
