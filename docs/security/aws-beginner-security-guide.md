# AWSåˆå¿ƒè€…å‘ã‘ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ - CIS File Search Application

## ðŸ“‹ ç›®æ¬¡

1. [ã¯ã˜ã‚ã« - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é‡è¦æ€§](#ã¯ã˜ã‚ã«)
2. [ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](#ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ)
3. [AWS Console ã§ã®è¨­å®šæ‰‹é †](#aws-console-ã§ã®è¨­å®šæ‰‹é †)
4. [åˆå¿ƒè€…ãŒã‚„ã‚ŠãŒã¡ãªå±é™ºãªè¨­å®š](#åˆå¿ƒè€…ãŒã‚„ã‚ŠãŒã¡ãªå±é™ºãªè¨­å®š)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹](#ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹)
6. [ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
7. [IAMãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](#iamãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)
8. [ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š](#ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š)
9. [ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †](#ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †)
10. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ç¢ºèªæ–¹æ³•](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ç¢ºèªæ–¹æ³•)

---

## ã¯ã˜ã‚ã« - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é‡è¦æ€§

### ãªãœã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒé‡è¦ãªã®ã‹

**ç¾å®Ÿã®è¢«å®³ä¾‹:**

| ä¼æ¥­ | å¹´ | è¢«å®³å†…å®¹ | åŽŸå›  |
|------|-----|---------|------|
| Capital One | 2019 | 1å„„ä»¶ã®é¡§å®¢æƒ…å ±æµå‡º | è¨­å®šãƒŸã‚¹ã®S3ãƒã‚±ãƒƒãƒˆ |
| Tesla | 2018 | æš—å·é€šè²¨ãƒžã‚¤ãƒ‹ãƒ³ã‚°æ”»æ’ƒ | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ã®Kubernetes |
| Uber | 2016 | 5700ä¸‡ä»¶ã®å€‹äººæƒ…å ±æµå‡º | GitHubã«AWSã‚­ãƒ¼å…¬é–‹ |

**è¢«å®³ã®è¦æ¨¡:**
- **é‡‘éŠ­çš„æå¤±**: ãƒ‡ãƒ¼ã‚¿ä¾µå®³1ä»¶ã‚ãŸã‚Šå¹³å‡425ä¸‡ãƒ‰ãƒ« (IBMèª¿æŸ»)
- **GDPRé•åé‡‘**: æœ€å¤§ã§å…¨ä¸–ç•Œå£²ä¸Šã®4% ã¾ãŸã¯ 2000ä¸‡ãƒ¦ãƒ¼ãƒ­
- **ãƒ¬ãƒ”ãƒ¥ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**: é¡§å®¢ã®65%ãŒæƒ…å ±æ¼æ´©å¾Œã«ã‚µãƒ¼ãƒ“ã‚¹é›¢è„±

### CISã‚·ã‚¹ãƒ†ãƒ ã§ä¿è­·ã™ã¹ãè³‡ç”£

1. **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿** (OpenSearch)
   - ãƒ•ã‚¡ã‚¤ãƒ«åã€ãƒ‘ã‚¹ã€ä½œæˆè€…
   - æ©Ÿå¯†åº¦: é«˜ (æ¥­å‹™å†…å®¹ãŒæŽ¨æ¸¬å¯èƒ½)

2. **ç”»åƒãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿** (OpenSearch)
   - Bedrock Titanã§ç”Ÿæˆã•ã‚ŒãŸåŸ‹ã‚è¾¼ã¿
   - æ©Ÿå¯†åº¦: ä¸­ (å…ƒç”»åƒã®å¾©å…ƒã¯å›°é›£ã ãŒé¡žä¼¼æ¤œç´¢å¯èƒ½)

3. **å®Ÿãƒ•ã‚¡ã‚¤ãƒ«** (S3ãƒã‚±ãƒƒãƒˆ)
   - ã‚¹ã‚­ãƒ£ãƒ³ã•ã‚ŒãŸPDFã€ç”»åƒã€Docuworks
   - æ©Ÿå¯†åº¦: æ¥µã‚ã¦é«˜ (æ©Ÿå¯†æ–‡æ›¸å«ã‚€)

4. **ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°** (CloudWatch)
   - èª°ãŒã„ã¤ä½•ã‚’æ¤œç´¢ã—ãŸã‹
   - æ©Ÿå¯†åº¦: é«˜ (è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³æŠŠæ¡å¯èƒ½)

---

## ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### 1. OpenSearch (t3.small.search) - å„ªå…ˆåº¦: ðŸ”´ P0 (Critical)

**è„…å¨ã‚·ãƒŠãƒªã‚ª**:
- ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã§å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æµå‡º
- CVSS 9.1 (Critical) - 100,000ä»¶ä»¥ä¸Šã®æ©Ÿå¯†æƒ…å ±æ¼æ´©

**å¿…é ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š:**

#### âœ… Consoleç¢ºèªé …ç›®

1. **VPCã‚¢ã‚¯ã‚»ã‚¹è¨­å®š**
   ```
   AWS Console â†’ OpenSearch Service â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³é¸æŠž
   â†’ Network configuration

   ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
   âœ“ VPC access: æœ‰åŠ¹
   âœ“ Public access: ç„¡åŠ¹
   âœ“ Subnet: Private subnet
   âœ“ Security group: è¨­å®šæ¸ˆã¿

   âŒ å±é™ºãªè¨­å®š:
   Ã— Public access: æœ‰åŠ¹ (ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½)
   ```

2. **æš—å·åŒ–è¨­å®š**
   ```
   AWS Console â†’ OpenSearch â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³é¸æŠž
   â†’ Encryption

   ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
   âœ“ Encryption at rest: æœ‰åŠ¹
   âœ“ Node-to-node encryption: æœ‰åŠ¹
   âœ“ Require HTTPS: æœ‰åŠ¹

   ã‚³ã‚¹ãƒˆ: $0 (è¿½åŠ è²»ç”¨ãªã—)
   ```

3. **ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼**
   ```
   AWS Console â†’ OpenSearch â†’ ãƒ‰ãƒ¡ã‚¤ãƒ³é¸æŠž
   â†’ Access policies

   å®‰å…¨ãªè¨­å®šä¾‹:
   {
     "Version": "2012-10-17",
     "Statement": [{
       "Effect": "Allow",
       "Principal": {
         "AWS": "arn:aws:iam::ACCOUNT_ID:role/CISFileProcessorRole"
       },
       "Action": "es:*",
       "Resource": "arn:aws:es:ap-northeast-1:ACCOUNT_ID:domain/cis-filesearch-dev/*",
       "Condition": {
         "IpAddress": {
           "aws:SourceIp": "10.0.0.0/16"
         }
       }
     }]
   }

   âŒ å±é™ºãªè¨­å®š:
   "Principal": {"AWS": "*"}  â†’ èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
   ```

4. **Security Groupè¨­å®š**
   ```
   AWS Console â†’ EC2 â†’ Security Groups
   â†’ OpenSearchç”¨ã®SGã‚’é¸æŠž

   ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«:
   Type: HTTPS
   Port: 443
   Source: EC2 Worker Security Group ID (sg-xxxxx)
   Description: OpenSearch access from workers only

   âŒ å±é™ºãªè¨­å®š:
   Source: 0.0.0.0/0  â†’ å…¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰æŽ¥ç¶šå¯èƒ½
   Source: ::/0       â†’ IPv6ã§å…¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰æŽ¥ç¶šå¯èƒ½
   ```

#### âš ï¸ ã‚ˆãã‚ã‚‹åˆå¿ƒè€…ã®ãƒŸã‚¹

**ãƒŸã‚¹1: Publicã‚¢ã‚¯ã‚»ã‚¹ã‚’ONã«ã™ã‚‹**
```
ç†ç”±: ã€Œè‡ªåˆ†ã®PCã‹ã‚‰OpenSearchã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã€
ãƒªã‚¹ã‚¯: ä¸–ç•Œä¸­ã®æ”»æ’ƒè€…ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«
æ­£ã—ã„æ–¹æ³•: AWS Systems Manager Session Managerã‚’ä½¿ç”¨
```

**ãƒŸã‚¹2: Security Groupã§0.0.0.0/0ã‚’è¨±å¯**
```
ç†ç”±: ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‹ã‚‰ã¨ã‚Šã‚ãˆãšå…¨é–‹æ”¾ã€
ãƒªã‚¹ã‚¯: ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³ã€DDoSæ”»æ’ƒã®æ¨™çš„ã«
æ­£ã—ã„æ–¹æ³•: å¿…è¦ãªé€ä¿¡å…ƒIPã®ã¿è¨±å¯
```

**ãƒŸã‚¹3: æš—å·åŒ–ã‚’OFFã«ã™ã‚‹**
```
ç†ç”±: ã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒå¿ƒé…ã€
ãƒªã‚¹ã‚¯: ãƒ‡ãƒ¼ã‚¿ç›—è´ã€GDPR/å€‹äººæƒ…å ±ä¿è­·æ³•é•å
çœŸå®Ÿ: æš—å·åŒ–ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å½±éŸ¿ã¯1%æœªæº€
```

---

### 2. S3ãƒã‚±ãƒƒãƒˆ (Landing & Thumbnail) - å„ªå…ˆåº¦: ðŸ”´ P0 (Critical)

**è„…å¨ã‚·ãƒŠãƒªã‚ª**:
- å…¬é–‹è¨­å®šãƒŸã‚¹ã§æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä»¶æµå‡º
- CVSS 9.1 (Critical) - å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã®å¤§é‡æ¼æ´©

**å¿…é ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š:**

#### âœ… Consoleç¢ºèªé …ç›®

1. **Block Public Access**
   ```
   AWS Console â†’ S3 â†’ ãƒã‚±ãƒƒãƒˆé¸æŠž
   â†’ Permissions â†’ Block public access

   å¿…é ˆè¨­å®š (ã™ã¹ã¦ON):
   âœ“ Block all public access: ON
     âœ“ Block public access to buckets and objects granted through new access control lists (ACLs)
     âœ“ Block public access to buckets and objects granted through any access control lists (ACLs)
     âœ“ Block public access to buckets and objects granted through new public bucket or access point policies
     âœ“ Block public and cross-account access to buckets and objects through any public bucket or access point policies

   èª¬æ˜Ž:
   - ã“ã‚Œã‚’ONã«ã™ã‚‹ã¨ã€èª¤ã£ã¦ãƒ‘ãƒ–ãƒªãƒƒã‚¯è¨­å®šã—ã¦ã‚‚å…¬é–‹ã•ã‚Œãªã„
   - Defense in Depth (å¤šå±¤é˜²å¾¡) ã®åŸºæœ¬
   ```

2. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæš—å·åŒ–**
   ```
   AWS Console â†’ S3 â†’ ãƒã‚±ãƒƒãƒˆé¸æŠž
   â†’ Properties â†’ Default encryption

   æŽ¨å¥¨è¨­å®š:
   âœ“ Server-side encryption: Enable
   âœ“ Encryption type: SSE-S3 (AES-256)
   âœ“ Bucket Key: Enable

   ã‚³ã‚¹ãƒˆå½±éŸ¿:
   - SSE-S3: ç„¡æ–™
   - Bucket Key: KMSãƒªã‚¯ã‚¨ã‚¹ãƒˆ99%å‰Šæ¸›
   ```

3. **ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼**
   ```
   AWS Console â†’ S3 â†’ ãƒã‚±ãƒƒãƒˆé¸æŠž
   â†’ Permissions â†’ Bucket policy

   HTTPSå¼·åˆ¶ãƒãƒªã‚·ãƒ¼ (å¿…é ˆ):
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "DenyInsecureTransport",
         "Effect": "Deny",
         "Principal": "*",
         "Action": "s3:*",
         "Resource": [
           "arn:aws:s3:::cis-filesearch-landing-dev",
           "arn:aws:s3:::cis-filesearch-landing-dev/*"
         ],
         "Condition": {
           "Bool": {
             "aws:SecureTransport": "false"
           }
         }
       }
     ]
   }

   åŠ¹æžœ: HTTPé€šä¿¡ã‚’å®Œå…¨ã«ãƒ–ãƒ­ãƒƒã‚¯ (HTTPSå¿…é ˆ)
   ```

4. **ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°**
   ```
   AWS Console â†’ S3 â†’ ãƒã‚±ãƒƒãƒˆé¸æŠž
   â†’ Properties â†’ Bucket Versioning

   æŽ¨å¥¨è¨­å®š:
   âœ“ Bucket Versioning: Enable

   ãƒ¡ãƒªãƒƒãƒˆ:
   - èª¤å‰Šé™¤ã‹ã‚‰ã®å¾©æ—§
   - ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢æ”»æ’ƒã‹ã‚‰ã®ä¿è­·
   - å¤‰æ›´å±¥æ­´ã®è¿½è·¡

   ã‚³ã‚¹ãƒˆ:
   - æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ†ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸èª²é‡‘
   - Lifecycle policyã§90æ—¥å¾Œã«å‰Šé™¤æŽ¨å¥¨
   ```

5. **ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°**
   ```
   AWS Console â†’ S3 â†’ ãƒã‚±ãƒƒãƒˆé¸æŠž
   â†’ Properties â†’ Server access logging

   æŽ¨å¥¨è¨­å®š:
   âœ“ Server access logging: Enable
   âœ“ Target bucket: cis-filesearch-logs-dev
   âœ“ Target prefix: s3-access-logs/

   ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œã‚‹æƒ…å ±:
   - ã‚¢ã‚¯ã‚»ã‚¹å…ƒIP
   - ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚åˆ»
   - æ“ä½œå†…å®¹ (GET, PUT, DELETE)
   - HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰

   ã‚³ã‚¹ãƒˆ: ãƒ­ã‚°ä¿å­˜åˆ†ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã¿ (~$1/æœˆ)
   ```

#### âš ï¸ å±é™ºãªè¨­å®šä¾‹

**å±é™ºè¨­å®š1: Block Public AccessãŒOFF**
```
AWS Console â†’ S3 â†’ ãƒã‚±ãƒƒãƒˆé¸æŠž â†’ Permissions

âŒ å±é™º:
Block all public access: OFF

éŽåŽ»ã®äº‹æ•…ä¾‹:
- 2019å¹´ Capital One: 1å„„ä»¶ã®é¡§å®¢æƒ…å ±æµå‡º
- 2019å¹´ GoDaddy: 2400ä¸‡ä»¶ã®é¡§å®¢è¨˜éŒ²æ¼æ´©
- 2017å¹´ Dow Jones: 220ä¸‡ä»¶ã®é¡§å®¢è¨˜éŒ²éœ²å‡º

å¯¾ç­–: å¿…ãšå…¨é …ç›®ONã«ã™ã‚‹
```

**å±é™ºè¨­å®š2: æš—å·åŒ–ãªã—**
```
âŒ å±é™º:
Default encryption: Disabled

ãƒªã‚¹ã‚¯:
- GDPR Article 32é•å (æœ€å¤§2000ä¸‡ãƒ¦ãƒ¼ãƒ­ç½°é‡‘)
- æ—¥æœ¬ã®å€‹äººæƒ…å ±ä¿è­·æ³•é•å
- PCI-DSSè¦ä»¶3.4é•å

å¯¾ç­–: SSE-S3ã‚’æœ‰åŠ¹åŒ– (ç„¡æ–™)
```

**å±é™ºè¨­å®š3: èª°ã§ã‚‚èª­ã¿å–ã‚Šå¯èƒ½ãªACL**
```
AWS Console â†’ S3 â†’ ãƒã‚±ãƒƒãƒˆé¸æŠž â†’ Permissions â†’ ACL

âŒ å±é™º:
Grantee: Everyone (public access)
Access: Read

ãƒªã‚¹ã‚¯: å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå…¬é–‹

ç¢ºèªæ–¹æ³•:
aws s3api get-bucket-acl --bucket ãƒã‚±ãƒƒãƒˆå

å®‰å…¨ãªå‡ºåŠ›ä¾‹:
"Grantee": {"Type": "CanonicalUser"}  â† ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ‰€æœ‰è€…ã®ã¿
```

---

### 3. SQS Queue - å„ªå…ˆåº¦: ðŸŸ¡ P1 (High)

**è„…å¨ã‚·ãƒŠãƒªã‚ª**:
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›—è´ã§ãƒ•ã‚¡ã‚¤ãƒ«åãƒ»ãƒ‘ã‚¹æµå‡º
- CVSS 7.5 (High)

**å¿…é ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š:**

#### âœ… Consoleç¢ºèªé …ç›®

1. **æš—å·åŒ–**
   ```
   AWS Console â†’ SQS â†’ ã‚­ãƒ¥ãƒ¼é¸æŠž
   â†’ Encryption

   æŽ¨å¥¨è¨­å®š:
   âœ“ Server-side encryption: Enable
   âœ“ Encryption key type: AWS managed key (aws/sqs)

   ã‚³ã‚¹ãƒˆ:
   - AWS managed key: ç„¡æ–™
   - Customer managed key (KMS): $1/æœˆ + APIèª²é‡‘

   åˆå¿ƒè€…å‘ã‘æŽ¨å¥¨: AWS managed key
   ```

2. **ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼**
   ```
   AWS Console â†’ SQS â†’ ã‚­ãƒ¥ãƒ¼é¸æŠž
   â†’ Access policy

   å®‰å…¨ãªãƒãƒªã‚·ãƒ¼ä¾‹:
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "Service": "events.amazonaws.com"
         },
         "Action": "sqs:SendMessage",
         "Resource": "arn:aws:sqs:ap-northeast-1:ACCOUNT_ID:cis-filesearch-queue-dev",
         "Condition": {
           "ArnEquals": {
             "aws:SourceArn": "arn:aws:events:ap-northeast-1:ACCOUNT_ID:rule/cis-s3-to-sqs-dev"
           }
         }
       },
       {
         "Effect": "Allow",
         "Principal": {
           "AWS": "arn:aws:iam::ACCOUNT_ID:role/CISFileProcessorRole"
         },
         "Action": [
           "sqs:ReceiveMessage",
           "sqs:DeleteMessage",
           "sqs:GetQueueAttributes"
         ],
         "Resource": "arn:aws:sqs:ap-northeast-1:ACCOUNT_ID:cis-filesearch-queue-dev"
       }
     ]
   }

   é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
   - EventBridgeã¯é€ä¿¡ã®ã¿
   - EC2 Workerã¯å—ä¿¡ãƒ»å‰Šé™¤ã®ã¿
   - æœ€å°æ¨©é™ã®åŽŸå‰‡
   ```

3. **Dead Letter Queueè¨­å®š**
   ```
   AWS Console â†’ SQS â†’ ã‚­ãƒ¥ãƒ¼é¸æŠž
   â†’ Dead-letter queue

   æŽ¨å¥¨è¨­å®š:
   âœ“ Dead-letter queue: Enable
   âœ“ Queue: cis-filesearch-dlq-dev
   âœ“ Maximum receives: 3

   ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®åˆ©ç‚¹:
   - å‡¦ç†å¤±æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨¼è·¡ä¿å­˜
   - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆèª¿æŸ»ã«å¿…é ˆ
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–ªå¤±ã®é˜²æ­¢
   ```

#### âš ï¸ ã‚ˆãã‚ã‚‹åˆå¿ƒè€…ã®ãƒŸã‚¹

**ãƒŸã‚¹1: ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã§"Principal": "*"**
```
âŒ å±é™º:
{
  "Principal": "*",
  "Action": "sqs:*"
}

ãƒªã‚¹ã‚¯: èª°ã§ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸èª­ã¿å–ã‚Šãƒ»å‰Šé™¤å¯èƒ½

æ­£ã—ã„è¨­å®š:
ç‰¹å®šã®IAMãƒ­ãƒ¼ãƒ«ã®ã¿ã«æ¨©é™ä»˜ä¸Ž
```

**ãƒŸã‚¹2: æš—å·åŒ–ãªã—**
```
âŒ å±é™º:
Server-side encryption: Disabled

ãƒªã‚¹ã‚¯:
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç›—è´
- ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•å

å¯¾ç­–: AWS managed keyã§æš—å·åŒ– (ç„¡æ–™)
```

---

### 4. EC2 Auto Scaling (Spot Instances) - å„ªå…ˆåº¦: ðŸŸ¡ P1 (High)

**è„…å¨ã‚·ãƒŠãƒªã‚ª**:
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¹—ã£å–ã‚Šã§å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¾µå…¥
- CVSS 8.8 (High)

**å¿…é ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š:**

#### âœ… Consoleç¢ºèªé …ç›®

1. **Launch Template - IAMãƒ­ãƒ¼ãƒ«**
   ```
   AWS Console â†’ EC2 â†’ Launch Templates
   â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠž â†’ Actions â†’ Modify template

   ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
   âœ“ IAM instance profile: CISFileProcessorRole

   âŒ å±é™ºãªè¨­å®š:
   Ã— IAM instance profile: (ãªã—)
   â†’ ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«åŸ‹ã‚è¾¼ã‚€å¿…è¦ãŒç”Ÿã˜ã‚‹

   Ã— IAM instance profile: EC2FullAccess
   â†’ éŽå‰°ãªæ¨©é™ã€æ¨ªå±•é–‹æ”»æ’ƒã®ãƒªã‚¹ã‚¯
   ```

2. **Security Group**
   ```
   AWS Console â†’ EC2 â†’ Security Groups
   â†’ Workerç”¨SGã‚’é¸æŠž

   ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ« (åŽ³æ ¼ã«):
   âŒ å±é™º: SSH (22) ã‹ã‚‰ 0.0.0.0/0
   âœ“ å®‰å…¨: ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ãªã—

   ç†ç”±:
   - Private subnetã®Workerã¯ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ä¸è¦
   - SSHã¯Systems Manager Session ManagerçµŒç”±

   ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«:
   âœ“ HTTPS (443) to 0.0.0.0/0
   â†’ S3, SQS, OpenSearch, Bedrock, Secrets Managerç”¨

   âœ“ PostgreSQL (5432) to OpenSearch SG
   â†’ OpenSearchæŽ¥ç¶šç”¨
   ```

3. **IMDSv2å¼·åˆ¶**
   ```
   AWS Console â†’ EC2 â†’ Launch Templates
   â†’ Advanced details â†’ Metadata

   å¿…é ˆè¨­å®š:
   âœ“ Metadata version: V2 only (IMDSv2)
   âœ“ Metadata response hop limit: 1

   IMDSv2ã¨ã¯:
   - Instance Metadata Service version 2
   - SSRFæ”»æ’ƒã‹ã‚‰ã®ä¿è­·
   - ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼

   AWS Configè¦å‰‡:
   ec2-imdsv2-check
   ```

4. **User Data (èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ)**
   ```
   AWS Console â†’ EC2 â†’ Launch Templates
   â†’ Advanced details â†’ User data

   ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯:
   âŒ å±é™º: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰
   export DB_PASSWORD="MyPassword123"

   âœ“ å®‰å…¨: Secrets Managerã‹ã‚‰å–å¾—
   DB_PASSWORD=$(aws secretsmanager get-secret-value \
     --secret-id cis-db-password \
     --query SecretString \
     --output text)

   âŒ å±é™º: rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œ
   ./process-files.sh

   âœ“ å®‰å…¨: å°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œ
   sudo -u cisworker ./process-files.sh
   ```

5. **Auto Scaling Groupè¨­å®š**
   ```
   AWS Console â†’ EC2 â†’ Auto Scaling Groups
   â†’ ASGé¸æŠž

   ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
   âœ“ Subnets: Private subnetsã®ã¿
   âœ“ Health check type: EC2 + ELB (æŽ¨å¥¨)
   âœ“ Health check grace period: 300ç§’

   âŒ å±é™ºãªè¨­å®š:
   Ã— Subnets: Public subnet
   â†’ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’æŒã¤
   â†’ ç›´æŽ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ”»æ’ƒã®æ¨™çš„ã«
   ```

#### âš ï¸ Spot Instancesç‰¹æœ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

**è€ƒæ…®ç‚¹1: ä¸­æ–­æ™‚ã®ãƒ‡ãƒ¼ã‚¿ä¿è­·**
```
å•é¡Œ: Spotä¸­æ–­æ™‚ã«å‡¦ç†ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¤±ã‚ã‚Œã‚‹

å¯¾ç­–:
1. SQS Visibility Timeout: 900ç§’ (15åˆ†)
2. å‡¦ç†å®Œäº†å‰ã®DeleteMessageç¦æ­¢
3. Spotä¸­æ–­ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æˆ»ã™

ã‚³ãƒ¼ãƒ‰ä¾‹ (User Data):
#!/bin/bash
# Spotä¸­æ–­ã‚·ã‚°ãƒŠãƒ«ã‚’ãƒãƒ³ãƒ‰ãƒ«
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

while true; do
  SPOT_ACTION=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" \
    http://169.254.169.254/latest/meta-data/spot/instance-action)

  if [[ "$SPOT_ACTION" != "404 - Not Found" ]]; then
    # ä¸­æ–­2åˆ†å‰ã«é€šçŸ¥ãŒæ¥ã‚‹
    echo "Spot termination detected. Graceful shutdown..."
    pkill -SIGTERM python  # å‡¦ç†ã‚’å„ªé›…ã«åœæ­¢
    exit 0
  fi

  sleep 5
done &
```

**è€ƒæ…®ç‚¹2: ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†åˆ©ç”¨æ”»æ’ƒ**
```
ãƒªã‚¹ã‚¯:
- Spotã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯åœæ­¢å¾Œã«ä»–ã®AWSãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹
- EBSãƒœãƒªãƒ¥ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã„ã‚‹ã¨æƒ…å ±æ¼æ´©

å¯¾ç­–:
1. EBSæš—å·åŒ–ã‚’å¿…é ˆåŒ–
2. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã¯/tmpã«ä¿å­˜ (è‡ªå‹•å‰Šé™¤)
3. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çµ‚äº†æ™‚ã«EBSå‰Šé™¤

Launch Templateè¨­å®š:
Block device mappings:
âœ“ Delete on termination: Yes
âœ“ Encrypted: Yes
```

---

### 5. EventBridge Rule - å„ªå…ˆåº¦: ðŸŸ¢ P2 (Medium)

**è„…å¨ã‚·ãƒŠãƒªã‚ª**:
- ãƒ«ãƒ¼ãƒ«æ”¹ã–ã‚“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æµå‡º
- CVSS 6.5 (Medium)

**å¿…é ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š:**

#### âœ… Consoleç¢ºèªé …ç›®

1. **Event Pattern (ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³)**
   ```
   AWS Console â†’ EventBridge â†’ Rules
   â†’ ãƒ«ãƒ¼ãƒ«é¸æŠž â†’ Event pattern

   ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
   âœ“ Source: aws.s3
   âœ“ Detail type: Object Created
   âœ“ Bucket name: ç‰¹å®šãƒã‚±ãƒƒãƒˆã®ã¿

   å®‰å…¨ãªè¨­å®šä¾‹:
   {
     "source": ["aws.s3"],
     "detail-type": ["Object Created"],
     "detail": {
       "bucket": {
         "name": ["cis-filesearch-landing-dev"]
       },
       "object": {
         "key": [{
           "prefix": "files/"
         }]
       }
     }
   }

   âŒ å±é™º: ã™ã¹ã¦ã®S3ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
   â†’ æ„å›³ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
   â†’ DDoSæ”»æ’ƒã®ãƒ™ã‚¯ãƒˆãƒ«ã«
   ```

2. **Resource-based Policy**
   ```
   AWS Console â†’ EventBridge â†’ Rules
   â†’ ãƒ«ãƒ¼ãƒ«é¸æŠž

   IAM Roleã®ç¢ºèª:
   âœ“ Role: AWSServiceRoleForEvents (AWSç®¡ç†)

   æ¨©é™:
   - SQSã¸ã®SendMessage ã®ã¿
   - ä»–ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸è¦
   ```

#### âš ï¸ ã‚ˆãã‚ã‚‹åˆå¿ƒè€…ã®ãƒŸã‚¹

**ãƒŸã‚¹: ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãŒåºƒã™ãŽã‚‹**
```
âŒ å±é™º:
{
  "source": ["aws.s3"]
}

å•é¡Œ:
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå†…ã™ã¹ã¦ã®S3ãƒã‚±ãƒƒãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
- æ„å›³ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡¦ç†ã‚­ãƒ¥ãƒ¼ã«
- ã‚³ã‚¹ãƒˆå¢—å¤§ + ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯

æ­£ã—ã„è¨­å®š:
ç‰¹å®šã®ãƒã‚±ãƒƒãƒˆ+ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ã¿
```

---

### 6. Bedrock (Titan Multimodal Embeddings) - å„ªå…ˆåº¦: ðŸŸ¢ P2 (Medium)

**è„…å¨ã‚·ãƒŠãƒªã‚ª**:
- APIã‚­ãƒ¼æ¼æ´©ã§å¤§é‡ã®Bedrockå‘¼ã³å‡ºã— (ã‚³ã‚¹ãƒˆæ”»æ’ƒ)
- CVSS 6.0 (Medium)

**å¿…é ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š:**

#### âœ… Consoleç¢ºèªé …ç›®

1. **Model Access**
   ```
   AWS Console â†’ Bedrock â†’ Model access

   ç¢ºèªãƒã‚¤ãƒ³ãƒˆ:
   âœ“ Titan Multimodal Embeddings: Access granted
   âœ“ ä»–ã®ä¸è¦ãªãƒ¢ãƒ‡ãƒ«: Access denied

   ç†ç”±:
   - æœ€å°æ¨©é™ã®åŽŸå‰‡
   - ã‚³ã‚¹ãƒˆåˆ¶å¾¡
   - æ„å›³ã—ãªã„ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨ã®é˜²æ­¢
   ```

2. **IAM Policy**
   ```
   CISFileProcessorRole ã«æ·»ä»˜ã™ã‚‹ãƒãƒªã‚·ãƒ¼:

   {
     "Version": "2012-10-17",
     "Statement": [{
       "Effect": "Allow",
       "Action": [
         "bedrock:InvokeModel"
       ],
       "Resource": [
         "arn:aws:bedrock:ap-northeast-1::foundation-model/amazon.titan-embed-image-v1"
       ],
       "Condition": {
         "StringEquals": {
           "aws:RequestedRegion": "ap-northeast-1"
         }
       }
     }]
   }

   é‡è¦ãƒã‚¤ãƒ³ãƒˆ:
   - ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã®ã¿è¨±å¯
   - ç‰¹å®šã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿è¨±å¯
   - CreateModel, UpdateModel ã¯ä¸è¨±å¯
   ```

3. **CloudWatch Logs**
   ```
   AWS Console â†’ Bedrock â†’ Model invocation logging

   æŽ¨å¥¨è¨­å®š:
   âœ“ Model invocation logging: Enable
   âœ“ Log group: /aws/bedrock/model-invocations
   âœ“ Text data: Include
   âœ“ Image data: Exclude (ã‚³ã‚¹ãƒˆã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼)

   ãƒ­ã‚°ã®ä½¿ç”¨ç›®çš„:
   - ç•°å¸¸ãªAPIå‘¼ã³å‡ºã—ã®æ¤œçŸ¥
   - ã‚³ã‚¹ãƒˆç›£è¦–
   - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆèª¿æŸ»
   ```

#### âš ï¸ ã‚ˆãã‚ã‚‹åˆå¿ƒè€…ã®ãƒŸã‚¹

**ãƒŸã‚¹: bedrock:* ã®åºƒã™ãŽã‚‹æ¨©é™**
```
âŒ å±é™º:
{
  "Action": "bedrock:*",
  "Resource": "*"
}

ãƒªã‚¹ã‚¯:
- ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆãƒ»å‰Šé™¤ãŒå¯èƒ½
- ã™ã¹ã¦ã®ãƒ¢ãƒ‡ãƒ«ã®å‘¼ã³å‡ºã—å¯èƒ½
- ã‚³ã‚¹ãƒˆçˆ†ç™ºã®ãƒªã‚¹ã‚¯

æ­£ã—ã„è¨­å®š:
InvokeModel + ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®ã¿
```

---

### 7. VPC (Virtual Private Cloud) - å„ªå…ˆåº¦: ðŸ”´ P0 (Critical)

**è„…å¨ã‚·ãƒŠãƒªã‚ª**:
- Public Subneté…ç½®ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç›´æŽ¥æ”»æ’ƒ
- CVSS 8.8 (High)

**å¿…é ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š:**

#### âœ… Consoleç¢ºèªé …ç›®

1. **Subnetè¨­è¨ˆ**
   ```
   AWS Console â†’ VPC â†’ Subnets

   æŽ¨å¥¨æ§‹æˆ:
   âœ“ Public Subnets (10.0.1.0/24, 10.0.2.0/24)
     - NAT Gateway ã®ã¿é…ç½®
     - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé€šä¿¡ã®å‡ºå£

   âœ“ Private Subnets (10.0.10.0/24, 10.0.11.0/24)
     - EC2 Workersã‚’é…ç½®
     - ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPãªã—
     - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šã¯NAT GatewayçµŒç”±

   âœ“ Database Subnets (10.0.20.0/24, 10.0.21.0/24)
     - OpenSearchã‚’é…ç½®
     - å®Œå…¨ã«éš”é›¢
     - Workersã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

   âŒ å±é™ºãªè¨­å®š:
   Ã— Workersã‚’Public Subnetã«é…ç½®
   â†’ ç›´æŽ¥SSH/RDPæ”»æ’ƒã®æ¨™çš„ã«
   ```

2. **Network ACLs**
   ```
   AWS Console â†’ VPC â†’ Network ACLs

   æŽ¨å¥¨è¨­å®š (Private Subnetç”¨):

   Inbound Rules:
   Rule #  Type        Protocol  Port  Source          Allow/Deny
   100     HTTPS       TCP       443   0.0.0.0/0       ALLOW
   110     Custom TCP  TCP       5432  10.0.20.0/24    ALLOW
   *       All         All       All   0.0.0.0/0       DENY

   Outbound Rules:
   Rule #  Type        Protocol  Port  Destination     Allow/Deny
   100     HTTPS       TCP       443   0.0.0.0/0       ALLOW
   110     Custom TCP  TCP       5432  10.0.20.0/24    ALLOW
   *       All         All       All   0.0.0.0/0       DENY

   æ³¨æ„:
   - Network ACLsã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹
   - Security Groupsã‚ˆã‚Šç²—ã„åˆ¶å¾¡
   - Defense in Depthã®ä¸€éƒ¨
   ```

3. **VPC Flow Logs**
   ```
   AWS Console â†’ VPC â†’ Your VPCs
   â†’ VPCé¸æŠž â†’ Flow logs â†’ Create flow log

   æŽ¨å¥¨è¨­å®š:
   âœ“ Filter: All
   âœ“ Destination: Send to CloudWatch Logs
   âœ“ Log group: /aws/vpc/cis-filesearch-dev
   âœ“ IAM role: VPCFlowLogsRole

   ãƒ¡ãƒªãƒƒãƒˆ:
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®å¯è¦–åŒ–
   - ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹ã®æ¤œçŸ¥
   - ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆèª¿æŸ»
   - ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¨¼è·¡

   ã‚³ã‚¹ãƒˆ: ~$5/æœˆ (1TBè»¢é€æ™‚)
   ```

4. **VPC Endpoints**
   ```
   AWS Console â†’ VPC â†’ Endpoints

   æŽ¨å¥¨ä½œæˆ:
   âœ“ com.amazonaws.ap-northeast-1.s3 (Gatewayåž‹, ç„¡æ–™)
   âœ“ com.amazonaws.ap-northeast-1.sqs (Interfaceåž‹, $7/æœˆ)
   âœ“ com.amazonaws.ap-northeast-1.secretsmanager (Interfaceåž‹, $7/æœˆ)

   ãƒ¡ãƒªãƒƒãƒˆ:
   - Private Subnetã‹ã‚‰AWSã‚µãƒ¼ãƒ“ã‚¹ã¸ã®å®‰å…¨ãªæŽ¥ç¶š
   - NAT Gatewayã‚³ã‚¹ãƒˆå‰Šæ¸› (S3ã¯ç„¡æ–™åŒ–)
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å‘ä¸Š
   - ãƒ‡ãƒ¼ã‚¿ãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚’çµŒç”±ã—ãªã„

   ã‚³ã‚¹ãƒˆå‰Šæ¸›ä¾‹:
   - NAT GatewayçµŒç”±: $45/æœˆ (1TB)
   - S3 VPC EndpointçµŒç”±: $0
   - ç¯€ç´„: $45/æœˆ
   ```

---

## åˆå¿ƒè€…ãŒã‚„ã‚ŠãŒã¡ãªå±é™ºãªè¨­å®š

### ðŸš« Top 10 Security Mistakes

#### 1ä½: S3ãƒã‚±ãƒƒãƒˆã®Publicå…¬é–‹

**é–“é•ã£ãŸç†ç”±:**
```
ã€Œã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‹ã‚‰å…¨å…¬é–‹ã«ã—ãŸã€
Access Denied â†’ ã¨ã‚Šã‚ãˆãšPublicè¨­å®š
```

**ãƒªã‚¹ã‚¯:**
- CVSS 9.1 (Critical)
- å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå…¬é–‹
- Capital Oneäº‹ä»¶ã¨åŒã˜

**æ­£ã—ã„å¯¾å‡¦:**
```
1. IAM Roleã‚’ç¢ºèª
2. Bucket Policyã‚’ç¢ºèª
3. VPC Endpointã‚’ä½¿ç”¨
4. Publicè¨­å®šã¯çµ¶å¯¾ã«ã—ãªã„
```

---

#### 2ä½: Security Groupã§0.0.0.0/0ã‚’è¨±å¯

**é–“é•ã£ãŸç†ç”±:**
```
ã€ŒæŽ¥ç¶šã§ããªã„ã‹ã‚‰å…¨é–‹æ”¾ã€
Connection timeout â†’ 0.0.0.0/0ã‚’è¿½åŠ 
```

**ãƒªã‚¹ã‚¯:**
- CVSS 8.8 (High)
- ãƒãƒ¼ãƒˆã‚¹ã‚­ãƒ£ãƒ³æ”»æ’ƒ
- ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒ
- DDoSæ”»æ’ƒã®æ¨™çš„

**æ­£ã—ã„å¯¾å‡¦:**
```
1. å¿…è¦ãªé€ä¿¡å…ƒIPã®ã¿è¨±å¯
2. Private Subnetã‚’ä½¿ç”¨
3. Systems Manager Session Managerã‚’ä½¿ç”¨
4. Bastionãƒ›ã‚¹ãƒˆçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹
```

**ç¢ºèªã‚³ãƒžãƒ³ãƒ‰:**
```bash
# å±é™ºãªSecurity Groupã‚’æ¤œå‡º
aws ec2 describe-security-groups \
  --filters "Name=ip-permission.cidr,Values=0.0.0.0/0" \
  --query 'SecurityGroups[*].[GroupId,GroupName,IpPermissions]'

# ç™ºè¦‹ã•ã‚ŒãŸã‚‰å³åº§ã«ä¿®æ­£
```

---

#### 3ä½: æš—å·åŒ–ã®ç„¡åŠ¹åŒ–

**é–“é•ã£ãŸç†ç”±:**
```
ã€Œãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãŒå¿ƒé…ã€
ã€Œè¨­å®šãŒé¢å€’ã€
```

**ãƒªã‚¹ã‚¯:**
- CVSS 7.5 (High)
- GDPR Article 32é•å
- å€‹äººæƒ…å ±ä¿è­·æ³•é•å
- PCI-DSSé•å

**çœŸå®Ÿ:**
- æš—å·åŒ–ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å½±éŸ¿: 1%æœªæº€
- AES-NIã‚’ä½¿ç”¨ã—ãŸãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æš—å·åŒ–
- ç„¡æ–™ (SSE-S3, EBSæš—å·åŒ–)

**æ­£ã—ã„è¨­å®š:**
```
ã™ã¹ã¦ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§æš—å·åŒ–ã‚’æœ‰åŠ¹åŒ–:
âœ“ S3: SSE-S3 (ç„¡æ–™)
âœ“ EBS: AWS managed key (ç„¡æ–™)
âœ“ OpenSearch: At-rest encryption (ç„¡æ–™)
âœ“ SQS: AWS managed key (ç„¡æ–™)
```

---

#### 4ä½: IAMæ¨©é™ã®éŽå‰°ä»˜ä¸Ž

**é–“é•ã£ãŸç†ç”±:**
```
ã€ŒAdministratorAccessãªã‚‰å‹•ãã€
ã€Œæ¨©é™ä¸è¶³ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‹ã‚‰*ã‚’ä½¿ã†ã€
```

**ãƒªã‚¹ã‚¯:**
- CVSS 8.1 (High)
- æ¨ªå±•é–‹æ”»æ’ƒ
- æ¨©é™æ˜‡æ ¼
- ãƒ‡ãƒ¼ã‚¿ç ´å£Š

**å±é™ºãªä¾‹:**
```json
{
  "Effect": "Allow",
  "Action": "*",
  "Resource": "*"
}
```

**æ­£ã—ã„è¨­å®š (æœ€å°æ¨©é™):**
```json
{
  "Effect": "Allow",
  "Action": [
    "s3:GetObject",
    "s3:PutObject"
  ],
  "Resource": "arn:aws:s3:::cis-filesearch-landing-dev/files/*"
}
```

**ç¢ºèªæ–¹æ³•:**
```bash
# éŽå‰°æ¨©é™ã®ãƒ­ãƒ¼ãƒ«ã‚’æ¤œå‡º
aws iam list-policies \
  --scope Local \
  --query 'Policies[*].[PolicyName,Arn]' \
  --output table

# å„ãƒãƒªã‚·ãƒ¼ã®è©³ç´°ã‚’ç¢ºèª
aws iam get-policy-version \
  --policy-arn arn:aws:iam::ACCOUNT_ID:policy/PolicyName \
  --version-id v1 \
  | jq '.PolicyVersion.Document.Statement[] | select(.Action == "*")'

# "*" ãŒè¦‹ã¤ã‹ã£ãŸã‚‰å³åº§ã«ä¿®æ­£
```

---

#### 5ä½: ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰

**é–“é•ã£ãŸç†ç”±:**
```
ã€Œã¨ã‚Šã‚ãˆãšå‹•ã‹ã—ãŸã„ã€
ã€Œç’°å¢ƒå¤‰æ•°ã®è¨­å®šæ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„ã€
```

**å±é™ºãªã‚³ãƒ¼ãƒ‰ä¾‹:**
```python
# âŒ çµ¶å¯¾ã«ã‚„ã£ã¦ã¯ã„ã‘ãªã„
AWS_ACCESS_KEY_ID = "AKIAIOSFODNN7EXAMPLE"
AWS_SECRET_ACCESS_KEY = "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"

s3_client = boto3.client(
    's3',
    aws_access_key_id=AWS_ACCESS_KEY_ID,
    aws_secret_access_key=AWS_SECRET_ACCESS_KEY
)
```

**ãƒªã‚¹ã‚¯:**
- CVSS 9.8 (Critical)
- GitHubã¸ã®ã‚³ãƒŸãƒƒãƒˆã§ä¸–ç•Œä¸­ã«å…¬é–‹
- æ•°åˆ†ã§æ”»æ’ƒè€…ã«ç™ºè¦‹ã•ã‚Œã‚‹
- æš—å·é€šè²¨ãƒžã‚¤ãƒ‹ãƒ³ã‚° ($æ•°ä¸‡ã®è¢«å®³)

**æ­£ã—ã„æ–¹æ³•:**
```python
# âœ… IAM Roleã‚’ä½¿ç”¨ (ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹)
s3_client = boto3.client('s3')  # EC2ã®IAM Roleã‚’è‡ªå‹•ä½¿ç”¨

# âœ… Secrets Managerã‚’ä½¿ç”¨
import boto3
import json

def get_secret(secret_name):
    client = boto3.client('secretsmanager')
    response = client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])

# secrets = get_secret('cis/external-api-keys')
```

**GitHubæµå‡ºæ™‚ã®å¯¾å¿œ:**
```bash
# 1. å³åº§ã«ã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ–
aws iam delete-access-key \
  --user-name UserName \
  --access-key-id AKIAIOSFODNN7EXAMPLE

# 2. æ–°ã—ã„ã‚­ãƒ¼ã‚’ç”Ÿæˆ
aws iam create-access-key --user-name UserName

# 3. CloudTrailã§ã‚­ãƒ¼ã®ä½¿ç”¨å±¥æ­´ã‚’ç¢ºèª
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=AccessKeyId,AttributeValue=AKIAIOSFODNN7EXAMPLE

# 4. ä¸æ­£ä½¿ç”¨ãŒã‚ã‚Œã°å³åº§ã«ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤
```

---

#### 6ä½: ãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç›´æŽ¥ä½¿ç”¨

**é–“é•ã£ãŸç†ç”±:**
```
ã€Œã¨ã‚Šã‚ãˆãšãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã€
ã€ŒIAMãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãŒé¢å€’ã€
```

**ãƒªã‚¹ã‚¯:**
- CVSS 9.8 (Critical)
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå®Œå…¨ä¹—ã£å–ã‚Š
- ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹å‰Šé™¤å¯èƒ½
- å¾©æ—§ä¸å¯èƒ½

**æ­£ã—ã„é‹ç”¨:**
```
ãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ:
âœ“ MFAå¿…é ˆ
âœ“ å¼·åŠ›ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (20æ–‡å­—ä»¥ä¸Š)
âœ“ ä½¿ç”¨ã¯åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨è«‹æ±‚ã®ã¿
âœ“ ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¯ä½œæˆã—ãªã„

æ—¥å¸¸é‹ç”¨:
âœ“ IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
âœ“ ç®¡ç†è€…æ¨©é™ã¯IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä»˜ä¸Ž
âœ“ ãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ãƒ­ãƒƒã‚¯

ç¢ºèªæ–¹æ³•:
AWS Console â†’ IAM â†’ Credential report
â†’ Root account ã® password_last_used ã‚’ç¢ºèª
â†’ 30æ—¥ä»¥å†…ã®ä½¿ç”¨ãŒã‚ã‚Œã°èª¿æŸ»
```

---

#### 7ä½: ãƒ­ã‚°è¨˜éŒ²ã®ç„¡åŠ¹åŒ–

**é–“é•ã£ãŸç†ç”±:**
```
ã€Œãƒ­ã‚°ã¯ä¸è¦ã€
ã€Œã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹ã€
```

**ãƒªã‚¹ã‚¯:**
- CVSS 7.5 (High)
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆèª¿æŸ»ä¸å¯èƒ½
- ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹é•å (SOC 2, ISO 27001)
- GDPR Article 32é•å

**æœ€ä½Žé™å¿…è¦ãªãƒ­ã‚°:**
```
âœ“ CloudTrail (ç®¡ç†ã‚¤ãƒ™ãƒ³ãƒˆ): å¿…é ˆã€ç„¡æ–™
âœ“ S3 Access Logs: æŽ¨å¥¨ã€~$1/æœˆ
âœ“ VPC Flow Logs: æŽ¨å¥¨ã€~$5/æœˆ
âœ“ OpenSearch Audit Logs: æŽ¨å¥¨ã€å«ã¾ã‚Œã‚‹
âœ“ Application Logs: å¿…é ˆã€~$2/æœˆ
```

**ãƒ­ã‚°ä¿æŒæœŸé–“:**
```
æœ€ä½Žé™:
- CloudTrail: 90æ—¥
- Application Logs: 30æ—¥
- VPC Flow Logs: 30æ—¥

ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹è¦ä»¶:
- SOC 2: 1å¹´
- GDPR: æœ€å¤§6å¹´
- PCI-DSS: 3ãƒ¶æœˆ (å³åº§ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½)ã€1å¹´ (ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–)
```

---

#### 8ä½: ãƒ‘ãƒƒãƒæœªé©ç”¨

**é–“é•ã£ãŸç†ç”±:**
```
ã€Œå‹•ã„ã¦ã‚‹ã‹ã‚‰è§¦ã‚‰ãªã„ã€
ã€Œãƒ‘ãƒƒãƒé©ç”¨å¾Œã®å‹•ä½œãŒä¸å®‰ã€
```

**ãƒªã‚¹ã‚¯:**
- CVSS 9.8 (Critical)
- æ—¢çŸ¥ã®è„†å¼±æ€§ã‚’çªã‹ã‚Œã‚‹
- Equifaxäº‹ä»¶ (1å„„4300ä¸‡ä»¶ã®æƒ…å ±æµå‡º)

**æ­£ã—ã„é‹ç”¨:**
```
âœ“ AWS Systems Manager Patch Managerä½¿ç”¨
âœ“ æœˆæ¬¡ã®ãƒ‘ãƒƒãƒé©ç”¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
âœ“ Devç’°å¢ƒã§å…ˆã«ãƒ†ã‚¹ãƒˆ
âœ“ è‡ªå‹•ãƒ‘ãƒƒãƒé©ç”¨ (Critical/Important)

è¨­å®šæ‰‹é †:
AWS Console â†’ Systems Manager â†’ Patch Manager
â†’ Patch baselines â†’ Create patch baseline
â†’ Approval rules:
  - Critical patches: Auto-approve after 0 days
  - Important patches: Auto-approve after 7 days
  - Moderate patches: Auto-approve after 30 days
```

---

#### 9ä½: ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆã®æœªè¨­å®š

**é–“é•ã£ãŸç†ç”±:**
```
ã€Œã¨ã‚Šã‚ãˆãšå‹•ã‘ã°ã„ã„ã€
ã€Œã‚¢ãƒ©ãƒ¼ãƒˆã®è¨­å®šæ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„ã€
```

**ãƒªã‚¹ã‚¯:**
- CVSS 6.5 (Medium)
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆæ¤œçŸ¥ã®é…å»¶
- ã‚³ã‚¹ãƒˆçˆ†ç™ºã®è¦‹é€ƒã—
- SLAé•å

**æœ€ä½Žé™å¿…è¦ãªã‚¢ãƒ©ãƒ¼ãƒˆ:**
```
âœ“ ãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½¿ç”¨ (å³åº§ã«é€šçŸ¥)
âœ“ IAMãƒãƒªã‚·ãƒ¼å¤‰æ›´ (å³åº§ã«é€šçŸ¥)
âœ“ Security Groupå¤‰æ›´ (å³åº§ã«é€šçŸ¥)
âœ“ äºˆç®—è¶…éŽ (80%, 100%)
âœ“ OpenSearchã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼Health: Red
âœ“ EC2 CPUä½¿ç”¨çŽ‡ > 80%
âœ“ SQS DLQãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ > 0
```

**è¨­å®šæ‰‹é †:**
```
AWS Console â†’ CloudWatch â†’ Alarms â†’ Create alarm

ä¾‹: ãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½¿ç”¨æ¤œçŸ¥
1. Metric: CloudTrail
2. Filter: { $.userIdentity.type = "Root" }
3. Threshold: > 0
4. Action: SNS topic â†’ security-team@company.com
```

---

#### 10ä½: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æœªå–å¾—

**é–“é•ã£ãŸç†ç”±:**
```
ã€ŒAWSã¯è‡ªå‹•ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã‚Œã‚‹ã€
ã€Œã†ã¡ã¯å°è¦æ¨¡ã ã‹ã‚‰å¤§ä¸ˆå¤«ã€
```

**ãƒªã‚¹ã‚¯:**
- CVSS 7.5 (High)
- ãƒ©ãƒ³ã‚µãƒ ã‚¦ã‚§ã‚¢æ”»æ’ƒã‹ã‚‰ã®å¾©æ—§ä¸å¯
- èª¤å‰Šé™¤ã‹ã‚‰ã®å¾©æ—§ä¸å¯
- ãƒ“ã‚¸ãƒã‚¹ç¶™ç¶šæ€§ã®å–ªå¤±

**çœŸå®Ÿ:**
```
AWSã®è²¬ä»»:
âœ“ ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®å¯ç”¨æ€§

ãŠå®¢æ§˜ã®è²¬ä»»:
âœ“ ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
âœ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ã®å¾©æ—§ãƒ†ã‚¹ãƒˆ
âœ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æš—å·åŒ–
```

**æŽ¨å¥¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥:**
```
OpenSearch:
âœ“ è‡ªå‹•ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ: æ¯Žæ—¥ 00:00 UTC
âœ“ æ‰‹å‹•ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ: é‡è¦ãªå¤‰æ›´å‰
âœ“ ä¿æŒæœŸé–“: 14æ—¥ (è‡ªå‹•)ã€90æ—¥ (æ‰‹å‹•)

S3:
âœ“ Versioning: æœ‰åŠ¹
âœ“ Object Lock: 90æ—¥ (ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰)
âœ“ Cross-Region Replication: æ¤œè¨Ž

EC2 (AMI):
âœ“ AWS Backup: æ—¥æ¬¡
âœ“ ä¿æŒæœŸé–“: 7æ—¥
```

**å¾©æ—§ãƒ†ã‚¹ãƒˆ (å¿…é ˆ):**
```
å››åŠæœŸã”ã¨:
1. ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’é¸æŠž
2. ãƒ†ã‚¹ãƒˆç’°å¢ƒã«å¾©å…ƒ
3. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ç¢ºèª
4. å¾©æ—§æ‰‹é †ã‚’æ–‡æ›¸åŒ–
5. å¾©æ—§æ™‚é–“ (RTO) ã‚’æ¸¬å®š

ç›®æ¨™:
- RTO (Recovery Time Objective): 4æ™‚é–“
- RPO (Recovery Point Objective): 24æ™‚é–“
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹

### GDPR (EUä¸€èˆ¬ãƒ‡ãƒ¼ã‚¿ä¿è­·è¦å‰‡) æº–æ‹ 

**é©ç”¨å¯¾è±¡:**
- EUã«æ‹ ç‚¹ãŒã‚ã‚‹
- EUã®å€‹äººãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã†
- EUã®å€‹äººã«ã‚µãƒ¼ãƒ“ã‚¹æä¾›

**CISã‚·ã‚¹ãƒ†ãƒ ã§ã®è€ƒæ…®äº‹é …:**

#### 1. ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã®æ¨©åˆ©

**Right to Access (ã‚¢ã‚¯ã‚»ã‚¹æ¨©) - Article 15:**
```
è¦ä»¶:
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ã‚’è¦æ±‚ã—ãŸå ´åˆã€
1ãƒ¶æœˆä»¥å†…ã«æ©Ÿæ¢°å¯èª­å½¢å¼ã§æä¾›

å®Ÿè£…:
AWS Console â†’ OpenSearch â†’ Dev Tools

GET /files/_search
{
  "query": {
    "term": {
      "user_id": "user-12345"
    }
  }
}

# çµæžœã‚’JSON/CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
```

**Right to Erasure (å‰Šé™¤æ¨©) - Article 17:**
```
è¦ä»¶:
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã‚’è¦æ±‚ã—ãŸå ´åˆã€
ä¸è¦ãªé…å»¶ãªããƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤

å®Ÿè£…:
# OpenSearchã‹ã‚‰å‰Šé™¤
POST /files/_delete_by_query
{
  "query": {
    "term": {
      "user_id": "user-12345"
    }
  }
}

# S3ã‹ã‚‰å‰Šé™¤
aws s3 rm s3://cis-filesearch-landing-dev/ \
  --recursive \
  --exclude "*" \
  --include "*user-12345*"

# ãƒ­ã‚°å‰Šé™¤
# æ³¨æ„: ç›£æŸ»ãƒ­ã‚°ã¯åˆ¥é€”ä¿æŒç¾©å‹™ãŒã‚ã‚‹å¯èƒ½æ€§
```

**Right to Rectification (è¨‚æ­£æ¨©) - Article 16:**
```
è¦ä»¶:
ä¸æ­£ç¢ºãªãƒ‡ãƒ¼ã‚¿ã®è¨‚æ­£ã‚’è¦æ±‚ã§ãã‚‹

å®Ÿè£…:
POST /files/_update/doc-id
{
  "doc": {
    "user_email": "corrected@example.com"
  }
}
```

#### 2. åŒæ„ç®¡ç†

**Consent Requirements - Article 7:**
```
è¦ä»¶:
- æ˜Žç¢ºã§è‚¯å®šçš„ãªåŒæ„
- åŒæ„ã®è¨¼è·¡ä¿å­˜
- åŒæ„æ’¤å›žã®å®¹æ˜“ã•

å®Ÿè£…:
OpenSearchã«åŒæ„è¨˜éŒ²ã‚’ä¿å­˜:
{
  "user_id": "user-12345",
  "consent_type": "data_processing",
  "consent_given": true,
  "consent_timestamp": "2025-01-15T10:00:00Z",
  "consent_version": "v1.0",
  "ip_address": "203.0.113.42"
}
```

#### 3. ãƒ‡ãƒ¼ã‚¿ä¾µå®³é€šçŸ¥ - Article 33, 34

**72æ™‚é–“ãƒ«ãƒ¼ãƒ«:**
```
ãƒ‡ãƒ¼ã‚¿ä¾µå®³ã‚’èªè­˜ã—ã¦ã‹ã‚‰72æ™‚é–“ä»¥å†…ã«
ç›£ç£æ©Ÿé–¢ã«é€šçŸ¥

é€šçŸ¥å†…å®¹:
1. ä¾µå®³ã®æ€§è³ª
2. å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ä¸»ä½“ã®æ•°
3. ãƒ‡ãƒ¼ã‚¿ä¿è­·è²¬ä»»è€…ã®é€£çµ¡å…ˆ
4. ä¾µå®³ã®å½±éŸ¿
5. è¬›ã˜ãŸå¯¾ç­–

CloudWatchã‚¢ãƒ©ãƒ¼ãƒˆã§è‡ªå‹•æ¤œçŸ¥:
- GuardDuty: Critical findings
- Config: éžæº–æ‹ ãƒªã‚½ãƒ¼ã‚¹æ¤œå‡º
- CloudTrail: ç•°å¸¸ãªAPIå‘¼ã³å‡ºã—
```

#### 4. Data Protection Impact Assessment (DPIA) - Article 35

**å®Ÿæ–½ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹:**
- å¤§è¦æ¨¡ãªå€‹äººãƒ‡ãƒ¼ã‚¿å‡¦ç†
- ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
- å…¬å…±ç©ºé–“ã®å¤§è¦æ¨¡ç›£è¦–

**CISã‚·ã‚¹ãƒ†ãƒ ã®DPIA:**
```markdown
# ãƒ‡ãƒ¼ã‚¿ä¿è­·å½±éŸ¿è©•ä¾¡ (DPIA)

## å‡¦ç†ã®æ¦‚è¦
- ç›®çš„: ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ 
- ãƒ‡ãƒ¼ã‚¿: ãƒ•ã‚¡ã‚¤ãƒ«åã€ãƒ‘ã‚¹ã€ä½œæˆè€…ã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
- ãƒ‡ãƒ¼ã‚¿ä¸»ä½“: å¾“æ¥­å“¡ (50å)
- å‡¦ç†è¦æ¨¡: 100,000ãƒ•ã‚¡ã‚¤ãƒ«

## ãƒªã‚¹ã‚¯è©•ä¾¡
| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | ç™ºç”Ÿç¢ºçŽ‡ | å¯¾ç­– |
|--------|--------|----------|------|
| ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ | High | Low | VPCéš”é›¢ã€MFAã€æš—å·åŒ– |
| ãƒ‡ãƒ¼ã‚¿æ¼æ´© | High | Very Low | S3 Block Public Access |
| å†…éƒ¨ä¸æ­£ | Medium | Low | CloudTrailç›£æŸ»ãƒ­ã‚° |

## çµè«–
ãƒªã‚¹ã‚¯ã¯è¨±å®¹ç¯„å›²å†…ã€‚å¯¾ç­–å®Ÿæ–½ã«ã‚ˆã‚Šé©æ³•ã€‚
```

---

### æ—¥æœ¬ã®å€‹äººæƒ…å ±ä¿è­·æ³• æº–æ‹ 

**æ”¹æ­£å€‹äººæƒ…å ±ä¿è­·æ³• (2022å¹´4æœˆæ–½è¡Œ) å¯¾å¿œ:**

#### 1. åˆ©ç”¨ç›®çš„ã®æ˜Žç¤º

**è¦ä»¶:**
```
å€‹äººæƒ…å ±å–å¾—æ™‚ã«åˆ©ç”¨ç›®çš„ã‚’é€šçŸ¥ã¾ãŸã¯å…¬è¡¨

å®Ÿè£…:
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«è¨˜è¼‰:

ã€å€‹äººæƒ…å ±ã®åˆ©ç”¨ç›®çš„ã€‘
1. ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã‚µãƒ¼ãƒ“ã‚¹ã®æä¾›
2. ã‚·ã‚¹ãƒ†ãƒ æ”¹å–„ã®ãŸã‚ã®çµ±è¨ˆåˆ†æž
3. å•ã„åˆã‚ã›å¯¾å¿œ
4. æ³•ä»¤éµå®ˆ
```

#### 2. å®‰å…¨ç®¡ç†æŽªç½®

**æŠ€è¡“çš„å®‰å…¨ç®¡ç†æŽªç½®:**
```
âœ“ ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡: IAM Roles, Security Groups
âœ“ ã‚¢ã‚¯ã‚»ã‚¹è€…ã®è­˜åˆ¥ã¨èªè¨¼: Cognito, MFA
âœ“ å¤–éƒ¨ã‹ã‚‰ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢: VPC, WAF
âœ“ æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ ã®ä½¿ç”¨ã«ä¼´ã†æ¼æ´©é˜²æ­¢: æš—å·åŒ–
```

**çµ„ç¹”çš„å®‰å…¨ç®¡ç†æŽªç½®:**
```
âœ“ çµ„ç¹”ä½“åˆ¶ã®æ•´å‚™: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è²¬ä»»è€…ã®ä»»å‘½
âœ“ è¦ç¨‹ã®æ•´å‚™: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼æ–‡æ›¸åŒ–
âœ“ å–æ‰±çŠ¶æ³ã®è¨˜éŒ²: CloudTrailç›£æŸ»ãƒ­ã‚°
âœ“ æ¼æ´©ç­‰äº‹æ¡ˆã¸ã®å¯¾å¿œ: ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œè¨ˆç”»
```

#### 3. ç¬¬ä¸‰è€…æä¾›ã®è¨˜éŒ²

**AWS (ãƒ‡ãƒ¼ã‚¿å‡¦ç†è€…) ã¸ã®å§”è¨—:**
```
è¦ä»¶:
å§”è¨—å…ˆã®ç›£ç£ç¾©å‹™

å®Ÿè£…:
1. AWS BAA (Business Associate Agreement) ç· çµ
2. AWS SOC 2ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
3. å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼
4. å§”è¨—å¥‘ç´„æ›¸ã«å®‰å…¨ç®¡ç†æŽªç½®ã‚’æ˜Žè¨˜
```

---

### PCI-DSS (Payment Card Industry Data Security Standard)

**æ³¨æ„: CISã‚·ã‚¹ãƒ†ãƒ ã¯ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’æ‰±ã‚ãªã„ãŒã€
å°†æ¥çš„ãªæ‹¡å¼µã‚’è€ƒæ…®**

**ä¸»è¦è¦ä»¶:**

#### Requirement 1: Firewallè¨­å®š

```
âœ“ Security Groupsã§æœ€å°æ¨©é™ã‚¢ã‚¯ã‚»ã‚¹
âœ“ Network ACLsã§è¿½åŠ ã®é˜²å¾¡å±¤
âœ“ ä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã®ç„¡åŠ¹åŒ–
```

#### Requirement 2: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã®å¤‰æ›´

```
âœ“ OpenSearchã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
âœ“ EC2ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç„¡åŠ¹åŒ–
âœ“ ä¸è¦ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤
```

#### Requirement 3: ä¿å­˜ã‚«ãƒ¼ãƒ‰ä¼šå“¡ãƒ‡ãƒ¼ã‚¿ã®ä¿è­·

```
è©²å½“ãªã— (ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ä¿å­˜ã—ãªã„)
```

#### Requirement 4: å…¬è¡†ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã®ã‚«ãƒ¼ãƒ‰ä¼šå“¡ãƒ‡ãƒ¼ã‚¿é€ä¿¡ã®æš—å·åŒ–

```
âœ“ TLS 1.2ä»¥ä¸Šã®ä½¿ç”¨
âœ“ HTTPé€šä¿¡ã®å®Œå…¨ç¦æ­¢
âœ“ VPCå†…éƒ¨é€šä¿¡ã®æš—å·åŒ–
```

#### Requirement 10: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹è¿½è·¡ãƒ»ç›£è¦–

```
âœ“ CloudTrail: ã™ã¹ã¦ã®APIå‘¼ã³å‡ºã—è¨˜éŒ²
âœ“ VPC Flow Logs: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯è¨˜éŒ²
âœ“ OpenSearch Audit Logs: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹è¨˜éŒ²
âœ“ ãƒ­ã‚°ä¿æŒ: 3ãƒ¶æœˆå³åº§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã€1å¹´ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
```

---

## ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### VPCè¨­è¨ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### æŽ¨å¥¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPC: 10.0.0.0/16                                                â”‚
â”‚                                                                 â”‚
â”‚  Internet Gateway                                               â”‚
â”‚         â”‚                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Public Subnet 1a        â”‚  â”‚ Public Subnet 1c     â”‚        â”‚
â”‚  â”‚ 10.0.1.0/24             â”‚  â”‚ 10.0.2.0/24          â”‚        â”‚
â”‚  â”‚                         â”‚  â”‚                      â”‚        â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚ â”‚ NAT Gateway     â”‚    â”‚  â”‚ â”‚ NAT Gateway     â”‚ â”‚        â”‚
â”‚  â”‚ â”‚ Elastic IP      â”‚    â”‚  â”‚ â”‚ Elastic IP      â”‚ â”‚        â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚             â”‚                            â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Private Subnet 1a       â”‚  â”‚ Private Subnet 1c    â”‚        â”‚
â”‚  â”‚ 10.0.10.0/24            â”‚  â”‚ 10.0.11.0/24         â”‚        â”‚
â”‚  â”‚                         â”‚  â”‚                      â”‚        â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚ â”‚ EC2 Workers     â”‚    â”‚  â”‚ â”‚ EC2 Workers     â”‚ â”‚        â”‚
â”‚  â”‚ â”‚ Auto Scaling    â”‚    â”‚  â”‚ â”‚ Auto Scaling    â”‚ â”‚        â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚             â”‚                            â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Database Subnet 1a      â”‚  â”‚ Database Subnet 1c   â”‚        â”‚
â”‚  â”‚ 10.0.20.0/24            â”‚  â”‚ 10.0.21.0/24         â”‚        â”‚
â”‚  â”‚                         â”‚  â”‚                      â”‚        â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚ â”‚ OpenSearch      â”‚    â”‚  â”‚ â”‚ (Reserved)      â”‚ â”‚        â”‚
â”‚  â”‚ â”‚ t3.small.search â”‚    â”‚  â”‚ â”‚                 â”‚ â”‚        â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                 â”‚
â”‚  VPC Endpoints (PrivateLink):                                  â”‚
â”‚  - com.amazonaws.ap-northeast-1.s3 (Gateway, FREE)             â”‚
â”‚  - com.amazonaws.ap-northeast-1.sqs (Interface, $7/mo)         â”‚
â”‚  - com.amazonaws.ap-northeast-1.secretsmanager (Interface)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Route Tableè¨­è¨ˆ

**Public Subnet Route Table:**
```
Destination         Target
10.0.0.0/16         local
0.0.0.0/0           Internet Gateway
```

**Private Subnet Route Table:**
```
Destination         Target
10.0.0.0/16         local
0.0.0.0/0           NAT Gateway (same AZ)
s3.amazonaws.com    VPC Endpoint (vpce-xxxxx)
```

**Database Subnet Route Table:**
```
Destination         Target
10.0.0.0/16         local
(ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæŽ¥ç¶šãªã—)
```

---

### Security Groupè¨­è¨ˆ

#### 1. EC2 Workers Security Group

```
Name: cis-filesearch-workers-sg
Description: Security group for file processor workers

Inbound Rules:
(ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ãªã— - å¤–éƒ¨ã‹ã‚‰ã®æŽ¥ç¶šä¸è¦)

Outbound Rules:
Type        Protocol  Port  Destination              Description
HTTPS       TCP       443   0.0.0.0/0                S3, SQS, Bedrock, Secrets Manager
PostgreSQL  TCP       5432  sg-opensearch-xxxxx      OpenSearch cluster
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚¤ãƒ³ãƒˆ:**
- ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ãƒ«ãƒ¼ãƒ«ãªã— (SSHã¯Systems ManagerçµŒç”±)
- ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ã¯å¿…è¦æœ€å°é™
- OpenSearchã¸ã¯ç‰¹å®šSGã®ã¿è¨±å¯

#### 2. OpenSearch Security Group

```
Name: cis-filesearch-opensearch-sg
Description: Security group for OpenSearch domain

Inbound Rules:
Type   Protocol  Port  Source                   Description
HTTPS  TCP       443   sg-workers-xxxxx         Workers only
HTTPS  TCP       443   sg-bastion-xxxxx         Bastion (admin access)

Outbound Rules:
Type  Protocol  Port  Destination  Description
All   All       All   0.0.0.0/0    (Default)
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚¤ãƒ³ãƒˆ:**
- EC2 Workersã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹å®Œå…¨ãƒ–ãƒ­ãƒƒã‚¯
- ç·Šæ€¥æ™‚ã®Bastionã‚¢ã‚¯ã‚»ã‚¹ã®ã¿è¨±å¯

#### 3. NAT Gateway Security

**æ³¨æ„: NAT Gatewayã¯è‡ªå‹•çš„ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒç®¡ç†ã•ã‚Œã‚‹**
```
- Security Groupè¨­å®šä¸è¦
- AWSç®¡ç†ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- ã‚¹ãƒ†ãƒ¼ãƒˆãƒ•ãƒ«ãªæŽ¥ç¶šè¿½è·¡
```

---

### Network ACLs (Defense in Depth)

**Private Subnet NACL:**

**Inbound Rules:**
```
Rule #  Type        Protocol  Port Range  Source          Allow/Deny
100     HTTPS       TCP       443         0.0.0.0/0       ALLOW
110     Custom TCP  TCP       1024-65535  10.0.0.0/16     ALLOW  (Return traffic)
120     PostgreSQL  TCP       5432        10.0.20.0/23    ALLOW
*       All         All       All         0.0.0.0/0       DENY
```

**Outbound Rules:**
```
Rule #  Type        Protocol  Port Range  Destination     Allow/Deny
100     HTTPS       TCP       443         0.0.0.0/0       ALLOW
110     Custom TCP  TCP       1024-65535  0.0.0.0/0       ALLOW  (Return traffic)
120     PostgreSQL  TCP       5432        10.0.20.0/23    ALLOW
*       All         All       All         0.0.0.0/0       DENY
```

**æ³¨æ„ç‚¹:**
```
- NACLsã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ (æˆ»ã‚Šãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚‚æ˜Žç¤ºçš„ã«è¨±å¯)
- ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ«ãƒãƒ¼ãƒˆ (1024-65535) ã®è¨±å¯ãŒå¿…è¦
- Security Groupsã‚ˆã‚Šç²—ã„åˆ¶å¾¡ (ã‚µãƒ–ãƒãƒƒãƒˆå˜ä½)
```

---

### VPC Flow Logs è¨­å®š

**è¨­å®šæ‰‹é †:**

```bash
# 1. CloudWatch Logs ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
aws logs create-log-group \
  --log-group-name /aws/vpc/cis-filesearch-dev

# 2. IAM Roleä½œæˆ
cat > vpc-flow-logs-trust-policy.json <<'EOF'
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Principal": {
      "Service": "vpc-flow-logs.amazonaws.com"
    },
    "Action": "sts:AssumeRole"
  }]
}
EOF

aws iam create-role \
  --role-name VPCFlowLogsRole \
  --assume-role-policy-document file://vpc-flow-logs-trust-policy.json

# 3. VPC Flow Logsæœ‰åŠ¹åŒ–
aws ec2 create-flow-logs \
  --resource-type VPC \
  --resource-ids vpc-xxxxx \
  --traffic-type ALL \
  --log-destination-type cloud-watch-logs \
  --log-group-name /aws/vpc/cis-filesearch-dev \
  --deliver-logs-permission-arn arn:aws:iam::ACCOUNT_ID:role/VPCFlowLogsRole
```

**ãƒ­ã‚°ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ:**
```
version account-id interface-id srcaddr dstaddr srcport dstport protocol packets bytes start end action log-status

ä¾‹:
2 123456789012 eni-abc123 10.0.10.25 54.239.2.5 49152 443 6 10 5200 1642248367 1642248427 ACCEPT OK

è§£èª¬:
- srcaddr: 10.0.10.25 (EC2 Worker)
- dstaddr: 54.239.2.5 (S3 endpoint)
- srcport: 49152 (ã‚¨ãƒ•ã‚§ãƒ¡ãƒ©ãƒ«ãƒãƒ¼ãƒˆ)
- dstport: 443 (HTTPS)
- action: ACCEPT (è¨±å¯)
```

**ä¸å¯©ãªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®æ¤œçŸ¥:**

```bash
# REJECT ã•ã‚ŒãŸãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æ¤œç´¢
aws logs filter-log-events \
  --log-group-name /aws/vpc/cis-filesearch-dev \
  --filter-pattern '[version, account, eni, source, destination, srcport, destport, protocol, packets, bytes, windowstart, windowend, action="REJECT", flowlogstatus]' \
  --start-time $(date -u -d '1 hour ago' +%s)000

# å¤–éƒ¨IPã¸ã®ç•°å¸¸ãªæŽ¥ç¶šã‚’æ¤œå‡º
aws logs filter-log-events \
  --log-group-name /aws/vpc/cis-filesearch-dev \
  --filter-pattern '[version, account, eni, source="10.0.*", destination!="10.0.*", srcport, destport!="443" && destport!="80", protocol, packets, bytes, windowstart, windowend, action, flowlogstatus]'
```

---

## IAMãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### æœ€å°æ¨©é™ã®åŽŸå‰‡ (Principle of Least Privilege)

**CISFileProcessorRole ã®æŽ¨å¥¨ãƒãƒªã‚·ãƒ¼è¨­è¨ˆ:**

#### 1. S3ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ReadFromLandingBucket",
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:GetObjectVersion"
      ],
      "Resource": "arn:aws:s3:::cis-filesearch-landing-dev/files/*",
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": "ap-northeast-1"
        }
      }
    },
    {
      "Sid": "WriteThumbnailBucket",
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl"
      ],
      "Resource": "arn:aws:s3:::cis-filesearch-thumbnails-dev/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-server-side-encryption": "AES256",
          "aws:RequestedRegion": "ap-northeast-1"
        }
      }
    },
    {
      "Sid": "DenyUnencryptedObjectUploads",
      "Effect": "Deny",
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::cis-filesearch-thumbnails-dev/*",
      "Condition": {
        "StringNotEquals": {
          "s3:x-amz-server-side-encryption": "AES256"
        }
      }
    }
  ]
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- èª­ã¿å–ã‚Šã¨æ›¸ãè¾¼ã¿ã‚’åˆ†é›¢
- ç‰¹å®šã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ã¿è¨±å¯
- æš—å·åŒ–ã•ã‚Œã¦ã„ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’æ‹’å¦
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™

---

#### 2. SQSã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ReceiveAndDeleteMessages",
      "Effect": "Allow",
      "Action": [
        "sqs:ReceiveMessage",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes",
        "sqs:ChangeMessageVisibility"
      ],
      "Resource": "arn:aws:sqs:ap-northeast-1:ACCOUNT_ID:cis-filesearch-queue-dev",
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": "ap-northeast-1"
        }
      }
    },
    {
      "Sid": "DenySendMessage",
      "Effect": "Deny",
      "Action": "sqs:SendMessage",
      "Resource": "*"
    }
  ]
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- å—ä¿¡ãƒ»å‰Šé™¤ã®ã¿è¨±å¯
- é€ä¿¡ã¯æ˜Žç¤ºçš„ã«æ‹’å¦ (Defense in Depth)
- DLQã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯åˆ¥ãƒãƒªã‚·ãƒ¼

---

#### 3. OpenSearchã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "OpenSearchDataAccess",
      "Effect": "Allow",
      "Action": [
        "es:ESHttpGet",
        "es:ESHttpPost",
        "es:ESHttpPut",
        "es:ESHttpDelete"
      ],
      "Resource": [
        "arn:aws:es:ap-northeast-1:ACCOUNT_ID:domain/cis-filesearch-dev",
        "arn:aws:es:ap-northeast-1:ACCOUNT_ID:domain/cis-filesearch-dev/*"
      ]
    },
    {
      "Sid": "DenyOpenSearchConfig",
      "Effect": "Deny",
      "Action": [
        "es:CreateDomain",
        "es:DeleteDomain",
        "es:UpdateDomainConfig"
      ],
      "Resource": "*"
    }
  ]
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- ãƒ‡ãƒ¼ã‚¿æ“ä½œã®ã¿è¨±å¯
- ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šå¤‰æ›´ã¯æ‹’å¦
- ç®¡ç†è€…ã®ã¿ãŒãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šå¤‰æ›´å¯èƒ½

---

#### 4. Bedrockã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "InvokeTitanEmbeddingsOnly",
      "Effect": "Allow",
      "Action": "bedrock:InvokeModel",
      "Resource": "arn:aws:bedrock:ap-northeast-1::foundation-model/amazon.titan-embed-image-v1",
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": "ap-northeast-1"
        }
      }
    },
    {
      "Sid": "DenyAllOtherBedrockActions",
      "Effect": "Deny",
      "Action": [
        "bedrock:CreateModelCustomizationJob",
        "bedrock:DeleteModelInvocationLoggingConfiguration",
        "bedrock:PutModelInvocationLoggingConfiguration"
      ],
      "Resource": "*"
    }
  ]
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- ç‰¹å®šã®ãƒ¢ãƒ‡ãƒ«ã®ã¿å‘¼ã³å‡ºã—å¯èƒ½
- ãƒ¢ãƒ‡ãƒ«ä½œæˆãƒ»å‰Šé™¤ã¯æ‹’å¦
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™

---

#### 5. Secrets Managerã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "GetSecretValue",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret"
      ],
      "Resource": "arn:aws:secretsmanager:ap-northeast-1:ACCOUNT_ID:secret:cis/*",
      "Condition": {
        "StringEquals": {
          "aws:RequestedRegion": "ap-northeast-1"
        }
      }
    },
    {
      "Sid": "DenySecretModification",
      "Effect": "Deny",
      "Action": [
        "secretsmanager:CreateSecret",
        "secretsmanager:DeleteSecret",
        "secretsmanager:PutSecretValue",
        "secretsmanager:UpdateSecret"
      ],
      "Resource": "*"
    }
  ]
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**
- èª­ã¿å–ã‚Šå°‚ç”¨
- ç‰¹å®šã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ (cis/*) ã®ã¿
- ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå¤‰æ›´ã¯ç®¡ç†è€…ã®ã¿

---

### IAMãƒ­ãƒ¼ãƒ« vs IAMãƒ¦ãƒ¼ã‚¶ãƒ¼

**æŽ¨å¥¨: IAMãƒ­ãƒ¼ãƒ«**

| è¦³ç‚¹ | IAMãƒ­ãƒ¼ãƒ« | IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ |
|------|-----------|-------------|
| ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ | ä¸è¦ | å¿…è¦ (æ¼æ´©ãƒªã‚¹ã‚¯) |
| èªè¨¼æƒ…å ±ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ | è‡ªå‹• (15åˆ†-1æ™‚é–“) | æ‰‹å‹• (90æ—¥ã”ã¨æŽ¨å¥¨) |
| æ¨©é™ç®¡ç† | ä¸€å…ƒç®¡ç† | å€‹åˆ¥ç®¡ç† |
| ç›£æŸ» | CloudTrailã§è¿½è·¡å®¹æ˜“ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ç¢ºèªå¿…è¦ |
| **æŽ¨å¥¨åº¦** | âœ… **æœ€æŽ¨å¥¨** | âš ï¸ äººé–“ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ |

**EC2ã§IAMãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ä¾‹:**

```python
# âŒ IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ (éžæŽ¨å¥¨)
import boto3

s3 = boto3.client(
    's3',
    aws_access_key_id='AKIAIOSFODNN7EXAMPLE',  # æ¼æ´©ãƒªã‚¹ã‚¯
    aws_secret_access_key='wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'
)

# âœ… IAMãƒ­ãƒ¼ãƒ« (æŽ¨å¥¨)
import boto3

s3 = boto3.client('s3')  # EC2ã®IAMãƒ­ãƒ¼ãƒ«ã‚’è‡ªå‹•ä½¿ç”¨
# èªè¨¼æƒ…å ±ã¯ä¸€åˆ‡ã‚³ãƒ¼ãƒ‰ã«å«ã¾ã‚Œãªã„
```

---

### MFA (å¤šè¦ç´ èªè¨¼) å¿…é ˆåŒ–

**è¨­å®šæ‰‹é †:**

#### 1. ãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®MFA

```
AWS Console â†’ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå (å³ä¸Š)
â†’ Security credentials
â†’ Multi-factor authentication (MFA)
â†’ Activate MFA

æŽ¨å¥¨ãƒ‡ãƒã‚¤ã‚¹:
âœ“ Virtual MFA (Google Authenticator, Authy)
âœ“ Hardware MFA (YubiKey)
âŒ SMS MFA (SIMã‚¹ãƒ¯ãƒƒãƒ”ãƒ³ã‚°æ”»æ’ƒã®ãƒªã‚¹ã‚¯)
```

#### 2. IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®MFAå¼·åˆ¶

**IAMãƒãƒªã‚·ãƒ¼ã§MFAãªã—ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒ–ãƒ­ãƒƒã‚¯:**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowViewAccountInfo",
      "Effect": "Allow",
      "Action": [
        "iam:GetAccountPasswordPolicy",
        "iam:ListVirtualMFADevices",
        "iam:ListUsers"
      ],
      "Resource": "*"
    },
    {
      "Sid": "AllowManageOwnVirtualMFADevice",
      "Effect": "Allow",
      "Action": [
        "iam:CreateVirtualMFADevice",
        "iam:DeleteVirtualMFADevice"
      ],
      "Resource": "arn:aws:iam::*:mfa/${aws:username}"
    },
    {
      "Sid": "AllowManageOwnUserMFA",
      "Effect": "Allow",
      "Action": [
        "iam:DeactivateMFADevice",
        "iam:EnableMFADevice",
        "iam:ListMFADevices",
        "iam:ResyncMFADevice"
      ],
      "Resource": "arn:aws:iam::*:user/${aws:username}"
    },
    {
      "Sid": "DenyAllExceptListedIfNoMFA",
      "Effect": "Deny",
      "NotAction": [
        "iam:CreateVirtualMFADevice",
        "iam:EnableMFADevice",
        "iam:GetUser",
        "iam:ListMFADevices",
        "iam:ListVirtualMFADevices",
        "iam:ResyncMFADevice",
        "sts:GetSessionToken"
      ],
      "Resource": "*",
      "Condition": {
        "BoolIfExists": {
          "aws:MultiFactorAuthPresent": "false"
        }
      }
    }
  ]
}
```

**åŠ¹æžœ:**
- MFAæœªè¨­å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯MFAè¨­å®šä»¥å¤–ã®æ“ä½œä¸å¯
- MFAè¨­å®šå¾Œã€å…¨æ©Ÿèƒ½ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

---

### ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

**è‡ªå‹•æ¤œå‡ºã‚¹ã‚¯ãƒªãƒ—ãƒˆ:**

```bash
#!/bin/bash
# 90æ—¥ä»¥ä¸Šä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’æ¤œå‡º

# Credential Reportã‚’ç”Ÿæˆ
aws iam generate-credential-report

# ãƒ¬ãƒãƒ¼ãƒˆå–å¾—
aws iam get-credential-report --query Content --output text | base64 -d > credential-report.csv

# 90æ—¥ä»¥ä¸Šã®ã‚­ãƒ¼ã‚’æ¤œå‡º
awk -F',' 'NR>1 {
  if ($11 != "N/A" && $11 != "no_information") {
    cmd = "date -d \"" $11 "\" +%s"
    cmd | getline key1_date
    close(cmd)

    current_date = systime()
    days_old = (current_date - key1_date) / 86400

    if (days_old > 90) {
      print "âš ï¸ WARNING: User", $1, "- Access Key 1 is", int(days_old), "days old"
      print "   Created:", $11
      print "   Last Used:", $15
      print "   Action: Rotate immediately"
      print ""
    }
  }
}' credential-report.csv
```

**ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †:**

```bash
# 1. æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ä½œæˆ
aws iam create-access-key --user-name UserName

# 2. æ–°ã—ã„ã‚­ãƒ¼ã§å‹•ä½œç¢ºèª
export AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
export AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
aws s3 ls  # ãƒ†ã‚¹ãƒˆ

# 3. æ—§ã‚­ãƒ¼ã‚’ç„¡åŠ¹åŒ– (å‰Šé™¤å‰ã«ä¸€æ™‚ç„¡åŠ¹åŒ–)
aws iam update-access-key \
  --user-name UserName \
  --access-key-id AKIAI44QH8DHBEXAMPLE \
  --status Inactive

# 4. å•é¡Œãªã‘ã‚Œã°æ—§ã‚­ãƒ¼ã‚’å‰Šé™¤
aws iam delete-access-key \
  --user-name UserName \
  --access-key-id AKIAI44QH8DHBEXAMPLE
```

---

## ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

### å¿…é ˆã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§

#### P0 (Critical) - å³åº§ã«å¯¾å¿œãŒå¿…è¦

**1. ãƒ«ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½¿ç”¨æ¤œçŸ¥**

```
ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:
{ $.userIdentity.type = "Root" && $.userIdentity.invokedBy NOT EXISTS && $.eventType != "AwsServiceEvent" }

ã‚¢ãƒ©ãƒ¼ãƒ æ¡ä»¶:
> 0 (1å›žã§ã‚‚ä½¿ç”¨ã•ã‚ŒãŸã‚‰å³åº§ã«é€šçŸ¥)

é€šçŸ¥å…ˆ:
- SMS: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è²¬ä»»è€…
- Email: security-team@company.com
- Slack: #security-alerts

æƒ³å®šå¯¾å¿œæ™‚é–“:
15åˆ†ä»¥å†…ã«èª¿æŸ»é–‹å§‹
```

**CloudWatchè¨­å®š:**

```bash
# ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œæˆ
aws logs put-metric-filter \
  --log-group-name /aws/cloudtrail/cis-file-scanner \
  --filter-name RootAccountUsage \
  --filter-pattern '{ $.userIdentity.type = "Root" && $.userIdentity.invokedBy NOT EXISTS && $.eventType != "AwsServiceEvent" }' \
  --metric-transformations \
    metricName=RootAccountUsageCount,metricNamespace=CISSecurityMetrics,metricValue=1

# ã‚¢ãƒ©ãƒ¼ãƒ ä½œæˆ
aws cloudwatch put-metric-alarm \
  --alarm-name P0-RootAccountUsage \
  --alarm-description "Root account was used - INVESTIGATE IMMEDIATELY" \
  --metric-name RootAccountUsageCount \
  --namespace CISSecurityMetrics \
  --statistic Sum \
  --period 60 \
  --evaluation-periods 1 \
  --threshold 1 \
  --comparison-operator GreaterThanOrEqualToThreshold \
  --treat-missing-data notBreaching \
  --actions-enabled \
  --alarm-actions arn:aws:sns:ap-northeast-1:ACCOUNT_ID:SecurityAlerts-P0
```

---

**2. IAMãƒãƒªã‚·ãƒ¼å¤‰æ›´æ¤œçŸ¥**

```
ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:
{ ($.eventName = DeleteGroupPolicy) || ($.eventName = DeleteRolePolicy) || ($.eventName = DeleteUserPolicy) || ($.eventName = PutGroupPolicy) || ($.eventName = PutRolePolicy) || ($.eventName = PutUserPolicy) || ($.eventName = CreatePolicy) || ($.eventName = DeletePolicy) || ($.eventName = CreatePolicyVersion) || ($.eventName = DeletePolicyVersion) || ($.eventName = AttachRolePolicy) || ($.eventName = DetachRolePolicy) || ($.eventName = AttachUserPolicy) || ($.eventName = DetachUserPolicy) || ($.eventName = AttachGroupPolicy) || ($.eventName = DetachGroupPolicy) }

ã‚¢ãƒ©ãƒ¼ãƒ æ¡ä»¶:
> 0

é€šçŸ¥:
Email + Slack

æƒ³å®šå¯¾å¿œæ™‚é–“:
30åˆ†ä»¥å†…ã«å¤‰æ›´å†…å®¹ç¢ºèª
```

---

**3. Security Groupå¤‰æ›´ (0.0.0.0/0è¨±å¯)**

```
ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:
{ ($.eventName = AuthorizeSecurityGroupIngress) && (($.requestParameters.ipPermissions.items[0].ipRanges.items[0].cidrIp = "0.0.0.0/0") || ($.requestParameters.ipPermissions.items[0].ipv6Ranges.items[0].cidrIpv6 = "::/0")) }

ã‚¢ãƒ©ãƒ¼ãƒ æ¡ä»¶:
> 0

é€šçŸ¥:
Email + SMS + Slack

æƒ³å®šå¯¾å¿œæ™‚é–“:
15åˆ†ä»¥å†…ã«å¤‰æ›´ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
```

---

**4. S3ãƒã‚±ãƒƒãƒˆãƒãƒªã‚·ãƒ¼å¤‰æ›´**

```
ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:
{ ($.eventSource = s3.amazonaws.com) && (($.eventName = PutBucketAcl) || ($.eventName = PutBucketPolicy) || ($.eventName = PutBucketCors) || ($.eventName = DeleteBucketPolicy)) }

ã‚¢ãƒ©ãƒ¼ãƒ æ¡ä»¶:
> 0

é€šçŸ¥:
Email + Slack

æƒ³å®šå¯¾å¿œæ™‚é–“:
30åˆ†ä»¥å†…ã«å¤‰æ›´å†…å®¹ç¢ºèª
```

---

**5. GuardDuty Critical Finding**

```
EventBridgeãƒ«ãƒ¼ãƒ«:
{
  "source": ["aws.guardduty"],
  "detail-type": ["GuardDuty Finding"],
  "detail": {
    "severity": [{"numeric": [">=", 7]}]
  }
}

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
1. SNSé€šçŸ¥
2. Lambdaè‡ªå‹•å¯¾å¿œ (EC2éš”é›¢)
3. Slackã‚¢ãƒ©ãƒ¼ãƒˆ

æƒ³å®šå¯¾å¿œæ™‚é–“:
å³åº§ (è‡ªå‹•å¯¾å¿œ)ã€1æ™‚é–“ä»¥å†…ã«èª¿æŸ»
```

---

#### P1 (High) - æ•°æ™‚é–“ä»¥å†…ã«å¯¾å¿œ

**6. OpenSearch Cluster Health: Red**

```
AWS Console â†’ CloudWatch â†’ Alarms â†’ Create alarm

ãƒ¡ãƒˆãƒªã‚¯ã‚¹:
- Namespace: AWS/ES
- Metric: ClusterStatus.red
- Domain: cis-filesearch-dev

æ¡ä»¶:
Maximum >= 1 for 5 minutes

é€šçŸ¥:
Email

æƒ³å®šå¯¾å¿œæ™‚é–“:
2æ™‚é–“ä»¥å†…ã«èª¿æŸ»ãƒ»å¾©æ—§é–‹å§‹
```

---

**7. SQS DLQãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œçŸ¥**

```
ãƒ¡ãƒˆãƒªã‚¯ã‚¹:
- Namespace: AWS/SQS
- Metric: ApproximateNumberOfMessagesVisible
- Queue: cis-filesearch-dlq-dev

æ¡ä»¶:
> 0

é€šçŸ¥:
Email

æƒ³å®šå¯¾å¿œæ™‚é–“:
4æ™‚é–“ä»¥å†…ã«å¤±æ•—åŽŸå› èª¿æŸ»
```

---

**8. äºˆç®—è¶…éŽã‚¢ãƒ©ãƒ¼ãƒˆ**

```
AWS Console â†’ Billing â†’ Budgets â†’ Create budget

è¨­å®š:
- Budget type: Cost budget
- Budget amount: $200/æœˆ
- Alert thresholds:
  - 80% ($160): Email
  - 100% ($200): Email + SMS
  - 120% ($240): Email + SMS + ç·Šæ€¥ä¼šè­°

é€šçŸ¥:
Email + SMS (100%ä»¥ä¸Š)

æƒ³å®šå¯¾å¿œæ™‚é–“:
80%æ™‚ç‚¹ã§åŽŸå› èª¿æŸ»ã€100%ã§ãƒªã‚½ãƒ¼ã‚¹å‰Šæ¸›
```

---

### CloudWatch Dashboardã®ä½œæˆ

**æŽ¨å¥¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ§‹æˆ:**

```json
{
  "widgets": [
    {
      "type": "metric",
      "properties": {
        "title": "OpenSearch Cluster Health",
        "metrics": [
          ["AWS/ES", "ClusterStatus.green", {"stat": "Maximum"}],
          [".", "ClusterStatus.yellow", {"stat": "Maximum"}],
          [".", "ClusterStatus.red", {"stat": "Maximum"}]
        ],
        "period": 300,
        "region": "ap-northeast-1"
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "SQS Queue Depth",
        "metrics": [
          ["AWS/SQS", "ApproximateNumberOfMessagesVisible", {"stat": "Average"}],
          [".", "ApproximateAgeOfOldestMessage", {"stat": "Maximum"}]
        ],
        "period": 300
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "EC2 Auto Scaling",
        "metrics": [
          ["AWS/AutoScaling", "GroupDesiredCapacity"],
          [".", "GroupInServiceInstances"],
          [".", "GroupPendingInstances"]
        ],
        "period": 300
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "S3 Bucket Requests",
        "metrics": [
          ["AWS/S3", "AllRequests", {"stat": "Sum"}],
          [".", "4xxErrors", {"stat": "Sum"}],
          [".", "5xxErrors", {"stat": "Sum"}]
        ],
        "period": 3600
      }
    },
    {
      "type": "log",
      "properties": {
        "title": "Recent Security Events",
        "query": "SOURCE '/aws/cloudtrail/cis-file-scanner'\n| fields @timestamp, userIdentity.principalId, eventName, sourceIPAddress\n| filter eventName like /Delete|Put|Create|Attach|Detach/\n| sort @timestamp desc\n| limit 20",
        "region": "ap-northeast-1"
      }
    },
    {
      "type": "metric",
      "properties": {
        "title": "Estimated Monthly Cost",
        "metrics": [
          ["AWS/Billing", "EstimatedCharges", {"stat": "Maximum"}]
        ],
        "period": 21600
      }
    }
  ]
}
```

---

## ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œæ‰‹é †

### ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¤œçŸ¥ãƒ»é€šçŸ¥     â”‚ CloudWatch, GuardDuty, Manual Report
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆå‹•å¯¾å¿œ       â”‚ â† 15åˆ†ä»¥å†…
â”‚  (Triage)       â”‚
â”‚  - å½±éŸ¿ç¯„å›²ç¢ºèª â”‚
â”‚  - ç·Šæ€¥åº¦åˆ¤å®š   â”‚
â”‚  - åˆæœŸå°ã˜è¾¼ã‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å°ã˜è¾¼ã‚       â”‚ â† 1æ™‚é–“ä»¥å†…
â”‚  (Containment)  â”‚
â”‚  - ãƒªã‚½ãƒ¼ã‚¹éš”é›¢ â”‚
â”‚  - ã‚¢ã‚¯ã‚»ã‚¹é®æ–­ â”‚
â”‚  - è¨¼è·¡ä¿å…¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ ¹çµ¶           â”‚ â† 4æ™‚é–“ä»¥å†…
â”‚  (Eradication)  â”‚
â”‚  - è„†å¼±æ€§ä¿®æ­£   â”‚
â”‚  - ãƒžãƒ«ã‚¦ã‚§ã‚¢é™¤åŽ»â”‚
â”‚  - èªè¨¼æƒ…å ±å¤‰æ›´ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¾©æ—§           â”‚ â† 24æ™‚é–“ä»¥å†…
â”‚  (Recovery)     â”‚
â”‚  - ã‚µãƒ¼ãƒ“ã‚¹å†é–‹ â”‚
â”‚  - ç›£è¦–å¼·åŒ–     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  äº‹å¾Œå¯¾å¿œ       â”‚ â† 1é€±é–“ä»¥å†…
â”‚  (Post-Incident)â”‚
â”‚  - æ ¹æœ¬åŽŸå› åˆ†æž â”‚
â”‚  - å†ç™ºé˜²æ­¢ç­–   â”‚
â”‚  - å ±å‘Šæ›¸ä½œæˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ã‚·ãƒŠãƒªã‚ªåˆ¥å¯¾å¿œæ‰‹é †

#### ã‚·ãƒŠãƒªã‚ª1: ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥ (GuardDuty Alert)

**Alertå†…å®¹:**
```
Finding Type: UnauthorizedAccess:EC2/TorClient
Severity: High (8.0)
Description: EC2 instance i-0abc123 is communicating with Tor network
```

**å¯¾å¿œæ‰‹é †:**

**Step 1: åˆå‹•å¯¾å¿œ (0-15åˆ†)**
```bash
# 1. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å³åº§ã«éš”é›¢
INSTANCE_ID="i-0abc123"
ISOLATION_SG="sg-isolation-quarantine"

aws ec2 modify-instance-attribute \
  --instance-id $INSTANCE_ID \
  --groups $ISOLATION_SG

# 2. ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—
aws ec2 describe-instances --instance-ids $INSTANCE_ID > incident-instance-metadata.json

# 3. é–¢é€£ã™ã‚‹IAMãƒ­ãƒ¼ãƒ«ç¢ºèª
aws iam get-role --role-name CISFileProcessorRole > incident-iam-role.json

# 4. CloudTrailãƒ­ã‚°å–å¾— (éŽåŽ»24æ™‚é–“)
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=ResourceName,AttributeValue=$INSTANCE_ID \
  --start-time $(date -u -d '24 hours ago' --iso-8601=seconds) \
  > incident-cloudtrail.json

# 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ ã«é€šçŸ¥
aws sns publish \
  --topic-arn arn:aws:sns:ap-northeast-1:ACCOUNT_ID:SecurityAlerts-P0 \
  --subject "ðŸš¨ P0 INCIDENT: Unauthorized Access Detected" \
  --message "EC2 instance $INSTANCE_ID communicating with Tor network. Instance isolated. Investigate immediately."
```

**Step 2: è¨¼è·¡ä¿å…¨ (15-30åˆ†)**
```bash
# 1. EBSã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆ (ãƒ•ã‚©ãƒ¬ãƒ³ã‚¸ãƒƒã‚¯ç”¨)
VOLUME_ID=$(aws ec2 describe-instances \
  --instance-ids $INSTANCE_ID \
  --query 'Reservations[0].Instances[0].BlockDeviceMappings[0].Ebs.VolumeId' \
  --output text)

aws ec2 create-snapshot \
  --volume-id $VOLUME_ID \
  --description "Forensic snapshot for incident $(date +%Y%m%d-%H%M%S)" \
  --tag-specifications 'ResourceType=snapshot,Tags=[{Key=Incident,Value=TorClient},{Key=Date,Value='$(date --iso-8601)'}]'

# 2. ãƒ¡ãƒ¢ãƒªãƒ€ãƒ³ãƒ—å–å¾— (å¯èƒ½ãªå ´åˆ)
# Systems ManagerçµŒç”±ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹
aws ssm send-command \
  --instance-ids $INSTANCE_ID \
  --document-name "AWS-RunShellScript" \
  --parameters 'commands=["sudo yum install -y volatility","sudo volatility -f /proc/kcore --profile=LinuxAMI2023x64 linux_pslist > /tmp/memory-dump.txt","aws s3 cp /tmp/memory-dump.txt s3://cis-incident-evidence/"]'

# 3. VPC Flow Logsã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
aws ec2 create-flow-logs \
  --resource-type NetworkInterface \
  --resource-ids $(aws ec2 describe-instances \
    --instance-ids $INSTANCE_ID \
    --query 'Reservations[0].Instances[0].NetworkInterfaces[0].NetworkInterfaceId' \
    --output text) \
  --traffic-type ALL \
  --log-destination-type s3 \
  --log-destination arn:aws:s3:::cis-incident-evidence/flow-logs/
```

**Step 3: èª¿æŸ» (30åˆ†-2æ™‚é–“)**
```bash
# 1. èµ·å‹•æ™‚åˆ»ã¨æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ç¢ºèª
aws ec2 describe-instances \
  --instance-ids $INSTANCE_ID \
  --query 'Reservations[0].Instances[0].[LaunchTime,State.Name]'

# 2. CloudTrailã§ç•°å¸¸ãªAPIå‘¼ã³å‡ºã—ç¢ºèª
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=Username,AttributeValue=i-0abc123 \
  --max-results 100 \
  | jq '.Events[] | {Time: .EventTime, Name: .EventName, IP: .SourceIPAddress}'

# 3. S3ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ç¢ºèª
aws s3api select-object-content \
  --bucket cis-filesearch-logs-dev \
  --key s3-access-logs/$(date +%Y-%m-%d)* \
  --expression "SELECT * FROM s3object s WHERE s.requester = 'i-0abc123'" \
  --expression-type SQL \
  --input-serialization '{"CSV": {}}' \
  --output-serialization '{"CSV": {}}' \
  incident-s3-access.csv

# 4. å¤–éƒ¨IPã¸ã®é€šä¿¡ç¢ºèª (VPC Flow Logs)
aws logs filter-log-events \
  --log-group-name /aws/vpc/cis-filesearch-dev \
  --filter-pattern '[version, account, eni, source, destination!="10.0.*" && destination!="172.*" && destination!="192.168.*", srcport, destport, protocol, packets, bytes, start, end, action="ACCEPT", flowlogstatus]' \
  --start-time $(date -u -d '24 hours ago' +%s)000
```

**Step 4: æ ¹çµ¶ã¨å¾©æ—§ (2-4æ™‚é–“)**
```bash
# 1. ä¾µå®³ã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’çµ‚äº†
aws ec2 terminate-instances --instance-ids $INSTANCE_ID

# 2. IAMãƒ­ãƒ¼ãƒ«ã®èªè¨¼æƒ…å ±ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
# (ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–)
aws iam update-assume-role-policy \
  --role-name CISFileProcessorRole \
  --policy-document '{
    "Version": "2012-10-17",
    "Statement": [{
      "Effect": "Deny",
      "Principal": {"Service": "ec2.amazonaws.com"},
      "Action": "sts:AssumeRole"
    }]
  }'

# æ•°åˆ†å¾…ã£ã¦ã‹ã‚‰å…ƒã«æˆ»ã™ (æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–)
aws iam update-assume-role-policy \
  --role-name CISFileProcessorRole \
  --policy-document file://original-trust-policy.json

# 3. æ–°ã—ã„Launch Templateã‚’ä½œæˆ (ãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿)
# 4. Auto Scaling Groupã‚’æ–°ã—ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§æ›´æ–°
# 5. ã™ã¹ã¦ã®Workerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…¥ã‚Œæ›¿ãˆ

# 6. Security Groupè¦‹ç›´ã—
# 7. Network ACLå¼·åŒ–
```

**Step 5: äº‹å¾Œå¯¾å¿œ (4æ™‚é–“-1é€±é–“)**
```markdown
# ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå ±å‘Šæ›¸

## ã‚µãƒžãƒªãƒ¼
- æ—¥æ™‚: 2025-01-XX 14:32 UTC
- ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆ: Tor networké€šä¿¡æ¤œçŸ¥
- å½±éŸ¿: EC2 Worker 1å°ãŒä¾µå®³
- ãƒ‡ãƒ¼ã‚¿æ¼æ´©: ãªã— (èª¿æŸ»ä¸­)
- å¾©æ—§æ™‚é–“: 3æ™‚é–“15åˆ†

## ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
14:32 - GuardDutyã‚¢ãƒ©ãƒ¼ãƒˆç™ºå ±
14:35 - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ èª¿æŸ»é–‹å§‹
14:40 - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹éš”é›¢
15:00 - è¨¼è·¡ä¿å…¨å®Œäº†
16:30 - æ ¹æœ¬åŽŸå› ç‰¹å®š (å¤ã„Node.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è„†å¼±æ€§)
17:00 - ä¾µå®³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çµ‚äº†
17:30 - ãƒ‘ãƒƒãƒé©ç”¨æ¸ˆã¿æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•
17:45 - ã‚µãƒ¼ãƒ“ã‚¹å®Œå…¨å¾©æ—§

## æ ¹æœ¬åŽŸå› 
- Node.js 14.x (EOL) ã®ä½¿ç”¨
- CVE-2023-XXXXX ã®è„†å¼±æ€§ã‚’æ‚ªç”¨

## å†ç™ºé˜²æ­¢ç­–
1. Auto Scalingãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æœ€æ–°AMIã«æ›´æ–°
2. Systems Manager Patch Managerã§è‡ªå‹•ãƒ‘ãƒƒãƒé©ç”¨
3. GuardDuty Malware Protectionã‚’æœ‰åŠ¹åŒ–
4. å®šæœŸçš„ãªè„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ (é€±æ¬¡)
5. WAFè¿½åŠ ã§L7æ”»æ’ƒå¯¾ç­–

## æ•™è¨“
- ãƒ‘ãƒƒãƒé©ç”¨ã®é‡è¦æ€§ã‚’å†èªè­˜
- è‡ªå‹•åŒ–ã®å¿…è¦æ€§
```

---

#### ã‚·ãƒŠãƒªã‚ª2: S3ãƒã‚±ãƒƒãƒˆã®èª¤å…¬é–‹æ¤œçŸ¥

**Alertå†…å®¹:**
```
AWS Config Rule: s3-bucket-public-read-prohibited
Compliance: NON_COMPLIANT
Resource: cis-filesearch-landing-dev
```

**å¯¾å¿œæ‰‹é † (å³åº§):**

```bash
# 1. å³åº§ã«Block Public Accessã‚’æœ‰åŠ¹åŒ–
aws s3api put-public-access-block \
  --bucket cis-filesearch-landing-dev \
  --public-access-block-configuration \
    "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

# 2. èª°ãŒã„ã¤Publicè¨­å®šã—ãŸã‹ç¢ºèª
aws cloudtrail lookup-events \
  --lookup-attributes AttributeKey=ResourceName,AttributeValue=cis-filesearch-landing-dev \
  --start-time $(date -u -d '7 days ago' --iso-8601=seconds) \
  | jq '.Events[] | select(.EventName | contains("PutBucket"))'

# 3. å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ç¢ºèª
aws s3api select-object-content \
  --bucket cis-filesearch-logs-dev \
  --key s3-access-logs/$(date +%Y-%m-%d)* \
  --expression "SELECT * FROM s3object s WHERE s.requester NOT LIKE 'arn:aws:iam::%'" \
  --expression-type SQL \
  --input-serialization '{"CSV": {}}' \
  --output-serialization '{"CSV": {}}' \
  external-access.csv

# 4. ãƒ‡ãƒ¼ã‚¿æ¼æ´©ã®å¯èƒ½æ€§ã‚’è©•ä¾¡
# - å¤–éƒ¨IPã‹ã‚‰ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒã‚ã£ãŸã‹?
# - ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ã‚¯ã‚»ã‚¹ã•ã‚ŒãŸã‹?
# - æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãŸã‹?

# 5. å¿…è¦ã«å¿œã˜ã¦GDPRä¾µå®³é€šçŸ¥ (72æ™‚é–“ä»¥å†…)
```

---

#### ã‚·ãƒŠãƒªã‚ª3: äºˆç®—è¶…éŽ (ã‚³ã‚¹ãƒˆæ”»æ’ƒ)

**Alertå†…å®¹:**
```
AWS Budgets Alert: Monthly cost exceeded 120% ($240)
Current spend: $252.34
Primary driver: EC2 (Spot instances)
```

**å¯¾å¿œæ‰‹é †:**

```bash
# 1. å³åº§ã«ç•°å¸¸ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ç‰¹å®š
aws ce get-cost-and-usage \
  --time-period Start=$(date -d '7 days ago' +%Y-%m-%d),End=$(date +%Y-%m-%d) \
  --granularity DAILY \
  --metrics BlendedCost \
  --group-by Type=SERVICE

# 2. EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°ç¢ºèª
aws ec2 describe-instances \
  --filters "Name=instance-state-name,Values=running" \
  --query 'Reservations[*].Instances[*].[InstanceId,InstanceType,LaunchTime]' \
  --output table

# ç•°å¸¸ã«å¤šã„å ´åˆã€Auto Scalingã®æš´èµ°ã‚’ç–‘ã†

# 3. Auto Scaling Groupã‚’ä¸€æ™‚åœæ­¢
aws autoscaling suspend-processes \
  --auto-scaling-group-name cis-file-processor-asg-dev \
  --scaling-processes Launch

# 4. ä¸è¦ãªã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’çµ‚äº†
aws ec2 terminate-instances \
  --instance-ids $(aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=cis-worker-*" "Name=instance-state-name,Values=running" \
    --query 'Reservations[*].Instances[*].InstanceId' \
    --output text)

# 5. SQSã‚­ãƒ¥ãƒ¼ã‚’ç¢ºèª (å¤§é‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®åŽŸå› èª¿æŸ»)
aws sqs get-queue-attributes \
  --queue-url https://sqs.ap-northeast-1.amazonaws.com/ACCOUNT_ID/cis-filesearch-queue-dev \
  --attribute-names All

# 6. EventBridgeãƒ«ãƒ¼ãƒ«ã‚’ä¸€æ™‚ç„¡åŠ¹åŒ– (å¿…è¦ã«å¿œã˜ã¦)
aws events disable-rule --name cis-s3-to-sqs-dev

# 7. æ ¹æœ¬åŽŸå› èª¿æŸ»
# - ç„¡é™ãƒ«ãƒ¼ãƒ—ã®ãƒˆãƒªã‚¬ãƒ¼?
# - DDoSæ”»æ’ƒ?
# - è¨­å®šãƒŸã‚¹?
```

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ç¢ºèªæ–¹æ³•

### AWS Configè¦å‰‡ã«ã‚ˆã‚‹è‡ªå‹•ãƒã‚§ãƒƒã‚¯

**æŽ¨å¥¨Configè¦å‰‡:**

```bash
# 1. S3æš—å·åŒ–ãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "s3-bucket-server-side-encryption-enabled",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "S3_BUCKET_SERVER_SIDE_ENCRYPTION_ENABLED"
    }
  }'

# 2. S3ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "s3-bucket-public-read-prohibited",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "S3_BUCKET_PUBLIC_READ_PROHIBITED"
    }
  }'

# 3. IAM MFAãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "iam-user-mfa-enabled",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "IAM_USER_MFA_ENABLED"
    }
  }'

# 4. Root MFAãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "root-account-mfa-enabled",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "ROOT_ACCOUNT_MFA_ENABLED"
    }
  }'

# 5. EC2 IMDSv2ãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "ec2-imdsv2-check",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "EC2_IMDSV2_CHECK"
    }
  }'

# 6. CloudTrailæœ‰åŠ¹åŒ–ãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "cloudtrail-enabled",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "CLOUD_TRAIL_ENABLED"
    }
  }'

# 7. VPC Flow Logsãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "vpc-flow-logs-enabled",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "VPC_FLOW_LOGS_ENABLED"
    }
  }'

# 8. OpenSearchæš—å·åŒ–ãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "elasticsearch-encrypted-at-rest",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "ELASTICSEARCH_ENCRYPTED_AT_REST"
    }
  }'

# 9. Security Group 0.0.0.0/0ãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "restricted-ssh",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "INCOMING_SSH_DISABLED"
    }
  }'

# 10. SQSæš—å·åŒ–ãƒã‚§ãƒƒã‚¯
aws configservice put-config-rule \
  --config-rule '{
    "ConfigRuleName": "sqs-queue-encrypted",
    "Source": {
      "Owner": "AWS",
      "SourceIdentifier": "SQS_QUEUE_ENCRYPTED"
    }
  }'
```

**ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ç¢ºèª:**

```bash
# å…¨ä½“ã®ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ã‚µãƒžãƒªãƒ¼
aws configservice describe-compliance-by-config-rule \
  --query 'ComplianceByConfigRules[*].[ConfigRuleName,Compliance.ComplianceType]' \
  --output table

# éžæº–æ‹ ãƒªã‚½ãƒ¼ã‚¹ã®è©³ç´°
aws configservice describe-compliance-by-resource \
  --compliance-types NON_COMPLIANT \
  --query 'ComplianceByResources[*].[ResourceType,ResourceId]' \
  --output table
```

---

### æ‰‹å‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
#!/bin/bash
# CIS File Search - Security Audit Script
# å®Ÿè¡Œ: ./security-audit.sh

echo "ðŸ” CIS File Search - Security Audit"
echo "======================================"
echo ""

# 1. S3ãƒã‚±ãƒƒãƒˆã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯
echo "1ï¸âƒ£ Checking S3 Public Access..."
aws s3api list-buckets --query 'Buckets[?starts_with(Name, `cis-filesearch`)].Name' --output text | while read bucket; do
  public_access=$(aws s3api get-public-access-block --bucket $bucket 2>/dev/null || echo "NOT_SET")

  if [[ "$public_access" == "NOT_SET" ]]; then
    echo "  âŒ CRITICAL: $bucket - Block Public Access NOT configured"
  else
    block_all=$(echo $public_access | jq '.PublicAccessBlockConfiguration | .BlockPublicAcls and .IgnorePublicAcls and .BlockPublicPolicy and .RestrictPublicBuckets')
    if [[ "$block_all" == "true" ]]; then
      echo "  âœ… $bucket - Block Public Access: Enabled"
    else
      echo "  âš ï¸  WARNING: $bucket - Block Public Access: Partially enabled"
    fi
  fi

  # æš—å·åŒ–ãƒã‚§ãƒƒã‚¯
  encryption=$(aws s3api get-bucket-encryption --bucket $bucket 2>/dev/null || echo "NOT_SET")
  if [[ "$encryption" == "NOT_SET" ]]; then
    echo "  âŒ CRITICAL: $bucket - Encryption NOT enabled"
  else
    echo "  âœ… $bucket - Encryption: Enabled"
  fi
done

echo ""

# 2. Security Groupsã®0.0.0.0/0ãƒã‚§ãƒƒã‚¯
echo "2ï¸âƒ£ Checking Security Groups for 0.0.0.0/0..."
aws ec2 describe-security-groups \
  --filters "Name=group-name,Values=cis-*" \
  --query 'SecurityGroups[*].[GroupId,GroupName,IpPermissions]' \
  --output json | jq -r '.[] |
    select(.[2] | length > 0) |
    .[2][] |
    select(.IpRanges[]?.CidrIp == "0.0.0.0/0" or .Ipv6Ranges[]?.CidrIpv6 == "::/0") |
    "âŒ CRITICAL: \(.[0]) \(.[1]) allows 0.0.0.0/0 on port \(.FromPort // "All")"'

echo ""

# 3. IAM Usersã®MFAãƒã‚§ãƒƒã‚¯
echo "3ï¸âƒ£ Checking IAM Users for MFA..."
aws iam list-users --query 'Users[*].UserName' --output text | while read user; do
  mfa_devices=$(aws iam list-mfa-devices --user-name $user --query 'MFADevices' --output text)

  if [[ -z "$mfa_devices" ]]; then
    echo "  âŒ WARNING: $user - MFA NOT enabled"
  else
    echo "  âœ… $user - MFA enabled"
  fi
done

echo ""

# 4. Root Accountã®MFAãƒã‚§ãƒƒã‚¯
echo "4ï¸âƒ£ Checking Root Account MFA..."
root_mfa=$(aws iam get-account-summary --query 'SummaryMap.AccountMFAEnabled' --output text)
if [[ "$root_mfa" == "1" ]]; then
  echo "  âœ… Root Account - MFA enabled"
else
  echo "  âŒ CRITICAL: Root Account - MFA NOT enabled"
fi

echo ""

# 5. OpenSearchã®VPCã‚¢ã‚¯ã‚»ã‚¹ãƒã‚§ãƒƒã‚¯
echo "5ï¸âƒ£ Checking OpenSearch Domain Security..."
aws opensearch list-domain-names --query 'DomainNames[?starts_with(DomainName, `cis-filesearch`)].DomainName' --output text | while read domain; do
  vpc_options=$(aws opensearch describe-domain --domain-name $domain --query 'DomainStatus.VPCOptions.VPCId' --output text)

  if [[ "$vpc_options" == "None" ]] || [[ -z "$vpc_options" ]]; then
    echo "  âŒ CRITICAL: $domain - Public access (not in VPC)"
  else
    echo "  âœ… $domain - VPC access: $vpc_options"
  fi

  # æš—å·åŒ–ãƒã‚§ãƒƒã‚¯
  encryption=$(aws opensearch describe-domain --domain-name $domain --query 'DomainStatus.EncryptionAtRestOptions.Enabled' --output text)
  if [[ "$encryption" == "True" ]]; then
    echo "  âœ… $domain - Encryption at rest: Enabled"
  else
    echo "  âŒ CRITICAL: $domain - Encryption at rest: NOT enabled"
  fi
done

echo ""

# 6. CloudTrailã®ãƒã‚§ãƒƒã‚¯
echo "6ï¸âƒ£ Checking CloudTrail..."
trails=$(aws cloudtrail list-trails --query 'Trails[*].Name' --output text)
if [[ -z "$trails" ]]; then
  echo "  âŒ CRITICAL: CloudTrail NOT enabled"
else
  echo "  âœ… CloudTrail enabled: $trails"

  for trail in $trails; do
    logging=$(aws cloudtrail get-trail-status --name $trail --query 'IsLogging' --output text)
    if [[ "$logging" == "True" ]]; then
      echo "  âœ… $trail - Logging: Active"
    else
      echo "  âš ï¸  WARNING: $trail - Logging: Inactive"
    fi
  done
fi

echo ""

# 7. EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®IMDSv2ãƒã‚§ãƒƒã‚¯
echo "7ï¸âƒ£ Checking EC2 Instances for IMDSv2..."
aws ec2 describe-instances \
  --filters "Name=tag:Project,Values=CISFileSearch" "Name=instance-state-name,Values=running" \
  --query 'Reservations[*].Instances[*].[InstanceId,MetadataOptions.HttpTokens]' \
  --output text | while read instance_id imdsv2; do

  if [[ "$imdsv2" == "required" ]]; then
    echo "  âœ… $instance_id - IMDSv2: Required"
  else
    echo "  âš ï¸  WARNING: $instance_id - IMDSv2: Optional (vulnerable to SSRF)"
  fi
done

echo ""

# 8. ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã®å¤ã•ãƒã‚§ãƒƒã‚¯
echo "8ï¸âƒ£ Checking IAM Access Keys age..."
aws iam generate-credential-report > /dev/null 2>&1
sleep 5
aws iam get-credential-report --query Content --output text | base64 -d > /tmp/credential-report.csv

awk -F',' 'NR>1 {
  if ($11 != "N/A" && $11 != "no_information") {
    split($11, created, "T")
    cmd = "date -d \"" created[1] "\" +%s"
    cmd | getline key1_date
    close(cmd)

    current_date = systime()
    days_old = int((current_date - key1_date) / 86400)

    if (days_old > 90) {
      print "  âš ï¸  WARNING: " $1 " - Access Key 1 is " days_old " days old (rotate)"
    }
  }
}' /tmp/credential-report.csv

echo ""
echo "âœ… Security Audit Complete"
echo "======================================"
```

**å®Ÿè¡Œ:**
```bash
chmod +x security-audit.sh
./security-audit.sh
```

---

## æœ€å¾Œã«

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€AWSåˆå¿ƒè€…ã®æ–¹ãŒCIS File Search Applicationã‚’å®‰å…¨ã«é‹ç”¨ã™ã‚‹ãŸã‚ã®åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚

**é‡è¦ãªåŽŸå‰‡:**

1. **Defense in Depth (å¤šå±¤é˜²å¾¡)**: 1ã¤ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã«é ¼ã‚‰ãªã„
2. **Least Privilege (æœ€å°æ¨©é™)**: å¿…è¦æœ€å°é™ã®æ¨©é™ã®ã¿ä»˜ä¸Ž
3. **Assume Breach (ä¾µå®³å‰æ)**: ä¾µå®³ã•ã‚Œã‚‹ã“ã¨ã‚’å‰æã«è¨­è¨ˆ
4. **Continuous Monitoring (ç¶™ç¶šçš„ç›£è¦–)**: å¸¸ã«ç›£è¦–ã—ã€ç•°å¸¸ã‚’æ—©æœŸæ¤œçŸ¥

**æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**

- âœ… ã“ã®ã‚¬ã‚¤ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ã™ã¹ã¦å®Ÿæ–½
- âœ… AWS Configã§è‡ªå‹•ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
- âœ… é€±æ¬¡ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
- âœ… å››åŠæœŸã”ã¨ã«ãƒšãƒãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
- âœ… å¹´æ¬¡ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

**è³ªå•ã‚„ä¸æ˜Žç‚¹ãŒã‚ã‚Œã°:**
- AWS Support (ã‚µãƒãƒ¼ãƒˆãƒ—ãƒ©ãƒ³åŠ å…¥æ™‚)
- AWS Security Hub
- AWS Well-Architected Tool

---

**Document Version**: 1.0
**Last Updated**: 2025-01-18
**Classification**: Internal - Security Sensitive
**Author**: Security & Compliance Expert
