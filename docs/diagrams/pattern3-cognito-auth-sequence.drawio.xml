<mxfile host="app.diagrams.net" modified="2025-10-20T00:00:00.000Z" agent="Claude Code" version="24.0.0" type="device">
  <diagram name="Pattern3-Cognito-Auth-Sequence" id="cognito-auth-seq">
    <mxGraphModel dx="3200" dy="1800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="3600" pageHeight="2800" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="CIS File Search - Cognito認証フロー詳細シーケンス&#xa;OAuth 2.0 Authorization Code Grant with PKCE" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=18;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="800" y="20" width="1000" height="80" as="geometry" />
        </mxCell>

        <!-- Swimlane Headers -->
        <mxCell id="swimlane-user" value="ユーザー (Browser)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FE;strokeColor=#01579B;verticalAlign=top;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="100" y="120" width="400" height="2600" as="geometry" />
        </mxCell>

        <mxCell id="swimlane-cloudfront" value="CloudFront" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FE;strokeColor=#01579B;verticalAlign=top;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="540" y="120" width="300" height="2600" as="geometry" />
        </mxCell>

        <mxCell id="swimlane-s3" value="S3 Static (Next.js)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1F5FE;strokeColor=#01579B;verticalAlign=top;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="880" y="120" width="380" height="2600" as="geometry" />
        </mxCell>

        <mxCell id="swimlane-cognito" value="Cognito User Pool" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#4A148C;verticalAlign=top;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="1300" y="120" width="400" height="2600" as="geometry" />
        </mxCell>

        <mxCell id="swimlane-apigw" value="API Gateway" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;verticalAlign=top;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="1740" y="120" width="400" height="2600" as="geometry" />
        </mxCell>

        <mxCell id="swimlane-lambda" value="Lambda (SearchAPI)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;verticalAlign=top;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="2180" y="120" width="400" height="2600" as="geometry" />
        </mxCell>

        <!-- Lifelines -->
        <mxCell id="lifeline-user" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="300" y="180" as="sourcePoint" />
            <mxPoint x="300" y="2680" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="lifeline-cf" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="690" y="180" as="sourcePoint" />
            <mxPoint x="690" y="2680" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="lifeline-s3" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1070" y="180" as="sourcePoint" />
            <mxPoint x="1070" y="2680" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="lifeline-cognito" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1500" y="180" as="sourcePoint" />
            <mxPoint x="1500" y="2680" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="lifeline-apigw" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="1940" y="180" as="sourcePoint" />
            <mxPoint x="1940" y="2680" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="lifeline-lambda" value="" style="endArrow=none;dashed=1;html=1;strokeColor=#666666;strokeWidth=2;" edge="1" parent="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="2380" y="180" as="sourcePoint" />
            <mxPoint x="2380" y="2680" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Phase Header: Initial Access -->
        <mxCell id="phase1-header" value="初回アクセス（未認証）" style="text;html=1;strokeColor=#000000;fillColor=#FFEB3B;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="100" y="200" width="2480" height="40" as="geometry" />
        </mxCell>

        <!-- Step 1-8: Initial Access -->
        <mxCell id="step1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9C27B0;strokeWidth=2;endArrow=classic;endFill=1;" edge="1" parent="1" source="lifeline-user" target="lifeline-cf">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="300" y="260" as="sourcePoint" />
            <mxPoint x="690" y="260" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step1-label" value="① アクセス&#xa;https://filesearch.company.com" style="edgeLabel;html=1;align=center;verticalAlign=top;resizable=0;points=[];fontSize=11;fontColor=#9C27B0;fontStyle=1" vertex="1" connectable="0" parent="step1">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint x="20" y="-15" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9C27B0;strokeWidth=2;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="690" y="300" as="sourcePoint" />
            <mxPoint x="1070" y="300" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step2-label" value="② GET / HTTP/2" style="edgeLabel;html=1;align=center;verticalAlign=top;resizable=0;points=[];fontSize=11;fontColor=#9C27B0;fontStyle=1" vertex="1" connectable="0" parent="step2">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint y="-15" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9C27B0;strokeWidth=2;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1070" y="340" as="sourcePoint" />
            <mxPoint x="690" y="340" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step3-label" value="③ GetObject index.html (OAC)" style="edgeLabel;html=1;align=center;verticalAlign=top;resizable=0;points=[];fontSize=11;fontColor=#9C27B0;fontStyle=1" vertex="1" connectable="0" parent="step3">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint y="-15" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#00AA00;strokeWidth=2;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="690" y="380" as="sourcePoint" />
            <mxPoint x="300" y="380" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step4-label" value="④ 200 OK - index.html (gzip)" style="edgeLabel;html=1;align=center;verticalAlign=top;resizable=0;points=[];fontSize=11;fontColor=#00AA00;fontStyle=1" vertex="1" connectable="0" parent="step4">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint y="-15" as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-loop for localStorage check -->
        <mxCell id="step5-box" value="⑥ Next.js SPA起動&#xa;localStorageチェック&#xa;→ トークンなし" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="140" y="420" width="320" height="80" as="geometry" />
        </mxCell>

        <!-- Code block annotation -->
        <mxCell id="code-block-1" value="const idToken = localStorage.getItem('id_token');&#xa;const accessToken = localStorage.getItem('access_token');&#xa;const refreshToken = localStorage.getItem('refresh_token');&#xa;&#xa;if (!idToken || !accessToken) {&#xa;  redirectToLogin();&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#CCCCCC;align=left;verticalAlign=top;fontSize=10;fontFamily=Courier New" vertex="1" parent="1">
          <mxGeometry x="2700" y="420" width="500" height="120" as="geometry" />
        </mxCell>

        <!-- Phase Header: PKCE Preparation -->
        <mxCell id="phase2-header" value="PKCE準備" style="text;html=1;strokeColor=#000000;fillColor=#FFEB3B;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="100" y="540" width="2480" height="40" as="geometry" />
        </mxCell>

        <mxCell id="step7-box" value="⑦ PKCE Code Verifier生成&#xa;(43-128文字のランダム文字列)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#6A1B9A;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="140" y="600" width="320" height="60" as="geometry" />
        </mxCell>

        <mxCell id="code-block-2" value="// PKCE Code Verifier生成&#xa;const codeVerifier = generateCodeVerifier();&#xa;// 例: &quot;dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk&quot;&#xa;&#xa;const codeChallenge = await generateCodeChallenge(codeVerifier);&#xa;// SHA-256ハッシュのBase64URL&#xa;// 例: &quot;E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM&quot;&#xa;&#xa;sessionStorage.setItem('pkce_code_verifier', codeVerifier);" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#CCCCCC;align=left;verticalAlign=top;fontSize=10;fontFamily=Courier New" vertex="1" parent="1">
          <mxGeometry x="2700" y="600" width="620" height="160" as="geometry" />
        </mxCell>

        <mxCell id="step8-box" value="⑧ Code Challenge生成&#xa;(Code VerifierのSHA-256)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#6A1B9A;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="140" y="700" width="320" height="60" as="geometry" />
        </mxCell>

        <!-- Phase Header: Login Flow -->
        <mxCell id="phase3-header" value="ユーザー認証" style="text;html=1;strokeColor=#000000;fillColor=#FFEB3B;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="100" y="800" width="2480" height="40" as="geometry" />
        </mxCell>

        <mxCell id="step9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9C27B0;strokeWidth=2;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="300" y="860" as="sourcePoint" />
            <mxPoint x="1500" y="860" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step9-label" value="⑨ Redirect to Login&#xa;GET /oauth2/authorize?&#xa;response_type=code&amp;client_id=xxx&amp;&#xa;redirect_uri=https://filesearch.company.com/callback&amp;&#xa;code_challenge_method=S256&amp;&#xa;code_challenge=E9Melhoa2..." style="edgeLabel;html=1;align=left;verticalAlign=top;resizable=0;points=[];fontSize=10;fontColor=#9C27B0;fontStyle=1" vertex="1" connectable="0" parent="step9">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint x="100" y="-80" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#00AA00;strokeWidth=2;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1500" y="940" as="sourcePoint" />
            <mxPoint x="300" y="940" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step10-label" value="⑩ ログイン画面表示" style="edgeLabel;html=1;align=center;verticalAlign=top;resizable=0;points=[];fontSize=11;fontColor=#00AA00;fontStyle=1" vertex="1" connectable="0" parent="step10">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint y="-15" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9C27B0;strokeWidth=2;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="300" y="1000" as="sourcePoint" />
            <mxPoint x="1500" y="1000" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step11-label" value="⑪ 認証情報入力&#xa;username: user@company.com&#xa;password: ************" style="edgeLabel;html=1;align=left;verticalAlign=top;resizable=0;points=[];fontSize=10;fontColor=#9C27B0;fontStyle=1" vertex="1" connectable="0" parent="step11">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint x="100" y="-50" as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Self-loop for password validation -->
        <mxCell id="step12-box" value="⑬ パスワード検証&#xa;- 最小12文字&#xa;- 大文字/小文字/数字/記号&#xa;- アカウントロックアウトチェック&#xa;- Advanced Security" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#4A148C;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="1340" y="1080" width="320" height="100" as="geometry" />
        </mxCell>

        <!-- MFA Optional Flow -->
        <mxCell id="mfa-box" value="MFA有効時" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#E65100;fontSize=12;fontStyle=1;dashed=1;dashPattern=8 8" vertex="1" parent="1">
          <mxGeometry x="1200" y="1220" width="600" height="240" as="geometry" />
        </mxCell>

        <mxCell id="step14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#FF6F00;strokeWidth=2;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1500" y="1260" as="sourcePoint" />
            <mxPoint x="300" y="1260" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step14-label" value="⑭ MFAチャレンジ&#xa;ChallengeName: SMS_MFA" style="edgeLabel;html=1;align=center;verticalAlign=top;resizable=0;points=[];fontSize=10;fontColor=#FF6F00;fontStyle=1" vertex="1" connectable="0" parent="step14">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint y="-30" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step16" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#FF6F00;strokeWidth=2;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="300" y="1340" as="sourcePoint" />
            <mxPoint x="1500" y="1340" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step16-label" value="⑯ MFAコード入力: 123456" style="edgeLabel;html=1;align=center;verticalAlign=top;resizable=0;points=[];fontSize=10;fontColor=#FF6F00;fontStyle=1" vertex="1" connectable="0" parent="step16">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint y="-15" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step18-box" value="⑱ MFAコード検証" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#4A148C;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="1380" y="1400" width="240" height="40" as="geometry" />
        </mxCell>

        <!-- Authorization Code Generation -->
        <mxCell id="step19-box" value="⑲ Authorization Code生成&#xa;(有効期限: 5分)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#4A148C;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="1340" y="1500" width="320" height="60" as="geometry" />
        </mxCell>

        <mxCell id="step20" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#00AA00;strokeWidth=2;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1500" y="1600" as="sourcePoint" />
            <mxPoint x="300" y="1600" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step20-label" value="⑳ 302 Redirect&#xa;Location: https://filesearch.company.com/callback?code=xxx" style="edgeLabel;html=1;align=center;verticalAlign=top;resizable=0;points=[];fontSize=10;fontColor=#00AA00;fontStyle=1" vertex="1" connectable="0" parent="step20">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint y="-30" as="offset" />
          </mxGeometry>
        </mxCell>

        <!-- Phase Header: Token Exchange -->
        <mxCell id="phase4-header" value="トークン交換" style="text;html=1;strokeColor=#000000;fillColor=#FFEB3B;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="100" y="1660" width="2480" height="40" as="geometry" />
        </mxCell>

        <mxCell id="step22-box" value="㉒ Callback URLパース&#xa;code = urlParams.get('code')" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#6A1B9A;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="140" y="1720" width="320" height="60" as="geometry" />
        </mxCell>

        <mxCell id="step23-box" value="㉓ PKCE Code Verifier取得&#xa;sessionStorage.getItem('pkce_code_verifier')" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#6A1B9A;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="140" y="1800" width="320" height="60" as="geometry" />
        </mxCell>

        <mxCell id="step24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#9C27B0;strokeWidth=2;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="300" y="1900" as="sourcePoint" />
            <mxPoint x="1500" y="1900" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step24-label" value="㉔ POST /oauth2/token&#xa;grant_type=authorization_code&amp;&#xa;client_id=xxx&amp;code=xxx&amp;&#xa;redirect_uri=https://filesearch.company.com/callback&amp;&#xa;code_verifier=dBjftJeZ4CVP-mB92K27..." style="edgeLabel;html=1;align=left;verticalAlign=top;resizable=0;points=[];fontSize=9;fontColor=#9C27B0;fontStyle=1" vertex="1" connectable="0" parent="step24">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint x="60" y="-70" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step25-box" value="㉕ Code検証&#xa;- Code有効期限チェック&#xa;- Redirect URI一致チェック&#xa;- PKCE検証:&#xa;  SHA256(code_verifier) == code_challenge" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#4A148C;fontSize=10;fontStyle=1;align=left" vertex="1" parent="1">
          <mxGeometry x="1340" y="2000" width="320" height="100" as="geometry" />
        </mxCell>

        <mxCell id="code-block-3" value="// PKCE検証&#xa;received_code_challenge = SHA256(code_verifier);&#xa;if (received_code_challenge == stored_code_challenge) {&#xa;  // 検証成功&#xa;  issue_tokens();&#xa;} else {&#xa;  // 検証失敗&#xa;  return 400 Bad Request;&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F5F5F5;strokeColor=#CCCCCC;align=left;verticalAlign=top;fontSize=10;fontFamily=Courier New" vertex="1" parent="1">
          <mxGeometry x="2700" y="2000" width="480" height="140" as="geometry" />
        </mxCell>

        <mxCell id="step26-box" value="㉖ JWT生成&#xa;- ID Token (RS256署名)&#xa;- Access Token (RS256署名)&#xa;- Refresh Token" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#F3E5F5;strokeColor=#4A148C;fontSize=10;fontStyle=1;align=left" vertex="1" parent="1">
          <mxGeometry x="1340" y="2140" width="320" height="80" as="geometry" />
        </mxCell>

        <mxCell id="step27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=#00AA00;strokeWidth=2;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1500" y="2260" as="sourcePoint" />
            <mxPoint x="300" y="2260" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="step27-label" value="㉗ 200 OK&#xa;{&#xa;  &quot;id_token&quot;: &quot;eyJraWQiOiJxxx...&quot;,&#xa;  &quot;access_token&quot;: &quot;eyJraWQiOiJxxx...&quot;,&#xa;  &quot;refresh_token&quot;: &quot;eyJjdHkiOiJKV1Q...&quot;,&#xa;  &quot;expires_in&quot;: 3600,&#xa;  &quot;token_type&quot;: &quot;Bearer&quot;&#xa;}" style="edgeLabel;html=1;align=left;verticalAlign=top;resizable=0;points=[];fontSize=9;fontColor=#00AA00;fontStyle=1;fontFamily=Courier New" vertex="1" connectable="0" parent="step27">
          <mxGeometry x="-0.1" y="2" relative="1" as="geometry">
            <mxPoint x="140" y="-90" as="offset" />
          </mxGeometry>
        </mxCell>

        <mxCell id="step28-box" value="㉘ トークン保存&#xa;localStorage.setItem('id_token', tokens.id_token)&#xa;localStorage.setItem('access_token', tokens.access_token)&#xa;localStorage.setItem('refresh_token', tokens.refresh_token)&#xa;localStorage.setItem('expires_at', Date.now() + 3600*1000)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=9;fontStyle=1;align=left;fontFamily=Courier New" vertex="1" parent="1">
          <mxGeometry x="140" y="2380" width="320" height="100" as="geometry" />
        </mxCell>

        <mxCell id="step29-box" value="㉙ PKCE Code Verifier削除&#xa;sessionStorage.removeItem('pkce_code_verifier')" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#6A1B9A;fontSize=10;fontStyle=1;fontFamily=Courier New" vertex="1" parent="1">
          <mxGeometry x="140" y="2500" width="320" height="60" as="geometry" />
        </mxCell>

        <mxCell id="step30-box" value="㉚ ダッシュボード表示&#xa;認証完了" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;fontSize=11;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="140" y="2580" width="320" height="60" as="geometry" />
        </mxCell>

        <!-- JWT Token Structure Annotation -->
        <mxCell id="jwt-structure" value="JWT Token構造&#xa;&#xa;Header.Payload.Signature&#xa;&#xa;Header: {&quot;alg&quot;: &quot;RS256&quot;, &quot;kid&quot;: &quot;qxx...&quot;}&#xa;Payload: {&quot;sub&quot;: &quot;user-id&quot;, &quot;email&quot;: &quot;user@company.com&quot;, &quot;exp&quot;: 1745305200}&#xa;Signature: RS256(base64(Header) + '.' + base64(Payload), privateKey)&#xa;&#xa;トークン有効期限:&#xa;• ID Token: 1時間&#xa;• Access Token: 1時間&#xa;• Refresh Token: 30日" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF9C4;strokeColor=#F57F17;align=left;verticalAlign=top;fontSize=10;fontFamily=Courier New" vertex="1" parent="1">
          <mxGeometry x="2700" y="2200" width="600" height="240" as="geometry" />
        </mxCell>

        <!-- Legend -->
        <mxCell id="legend-box-seq" value="凡例" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFFFFF;strokeColor=#000000;align=left;verticalAlign=top;fontSize=12;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="2700" y="120" width="400" height="220" as="geometry" />
        </mxCell>

        <mxCell id="legend-seq-1" value="" style="edgeStyle=none;html=1;strokeColor=#9C27B0;strokeWidth=3;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2730" y="170" as="sourcePoint" />
            <mxPoint x="2780" y="170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-seq-1-text" value="認証ステップ (Purple)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11" vertex="1" parent="1">
          <mxGeometry x="2790" y="160" width="300" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-seq-2" value="" style="edgeStyle=none;html=1;strokeColor=#00AA00;strokeWidth=3;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2730" y="200" as="sourcePoint" />
            <mxPoint x="2780" y="200" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-seq-2-text" value="成功レスポンス (Green)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11" vertex="1" parent="1">
          <mxGeometry x="2790" y="190" width="300" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-seq-3" value="" style="edgeStyle=none;html=1;strokeColor=#FF6F00;strokeWidth=3;dashed=1;endArrow=classic;endFill=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2730" y="230" as="sourcePoint" />
            <mxPoint x="2780" y="230" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend-seq-3-text" value="MFAフロー (Orange, Optional)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11" vertex="1" parent="1">
          <mxGeometry x="2790" y="220" width="300" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-seq-4" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E1BEE7;strokeColor=#6A1B9A;" vertex="1" parent="1">
          <mxGeometry x="2730" y="255" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-seq-4-text" value="PKCEセキュリティステップ" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11" vertex="1" parent="1">
          <mxGeometry x="2790" y="250" width="300" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-seq-5" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#2E7D32;" vertex="1" parent="1">
          <mxGeometry x="2730" y="285" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-seq-5-text" value="成功完了ステップ" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11" vertex="1" parent="1">
          <mxGeometry x="2790" y="280" width="300" height="20" as="geometry" />
        </mxCell>

        <mxCell id="legend-seq-6" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCDD2;strokeColor=#C62828;" vertex="1" parent="1">
          <mxGeometry x="2730" y="315" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="legend-seq-6-text" value="エラー/検証失敗" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=11" vertex="1" parent="1">
          <mxGeometry x="2790" y="310" width="300" height="20" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>