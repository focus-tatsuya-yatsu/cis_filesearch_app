@startuml CIS File Search Deployment Flow

!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist
!include AWSPuml/AWSCommon.puml
!include AWSPuml/AWSSimplified.puml

!include AWSPuml/DeveloperTools/CodeBuild.puml
!include AWSPuml/Storage/SimpleStorageService.puml
!include AWSPuml/NetworkingContentDelivery/CloudFront.puml
!include AWSPuml/NetworkingContentDelivery/Route53.puml
!include AWSPuml/ManagementGovernance/CloudWatch.puml
!include AWSPuml/General/Users.puml

skinparam rectangle {
    BackgroundColor<<Dev>> #FFF9C4
    BorderColor<<Dev>> #F57F17
    BackgroundColor<<CI>> #E1F5FE
    BorderColor<<CI>> #01579B
    BackgroundColor<<AWS>> #FFF7E6
    BorderColor<<AWS>> #FF9800
    BackgroundColor<<Success>> #C8E6C9
    BorderColor<<Success>> #2E7D32
    BackgroundColor<<Failed>> #FFCDD2
    BorderColor<<Failed>> #C62828
}

title CIS File Search - CI/CD ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼\nGitHub Actions â†’ S3 â†’ CloudFront

' ================================
' Development Environment
' ================================
rectangle "é–‹ç™ºç’°å¢ƒ" <<Dev>> {
    actor "ğŸ‘¨â€ğŸ’» é–‹ç™ºè€…" as Dev

    rectangle "ãƒ­ãƒ¼ã‚«ãƒ«ãƒªãƒã‚¸ãƒˆãƒª" as LocalRepo {
        folder "src/" as src {
            file "pages/" as pages
            file "components/" as components
            file "hooks/" as hooks
            file "services/" as services
        }

        file "package.json" as packageJson
        file "next.config.js" as nextConfig
        file ".env.local" as envLocal
    }
}

' ================================
' CI/CD Pipeline (GitHub Actions)
' ================================
rectangle "CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ (GitHub Actions)" <<CI>> {
    rectangle "1ï¸âƒ£ Trigger" as trigger {
        note right
            **ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶**
            - push to main
            - paths: src/**, public/**
            - package.jsonå¤‰æ›´
            - next.config.jså¤‰æ›´
        end note
    }

    rectangle "2ï¸âƒ£ Checkout" as checkout {
        note right: actions/checkout@v4
    }

    rectangle "3ï¸âƒ£ Setup Node.js" as setupNode {
        note right
            Node.js 20
            cache: yarn
        end note
    }

    rectangle "4ï¸âƒ£ Install Dependencies" as install {
        note right: yarn install --frozen-lockfile
    }

    rectangle "5ï¸âƒ£ Lint & Test" as test {
        note right
            yarn lint
            yarn test
            yarn type-check
        end note
    }

    rectangle "6ï¸âƒ£ Build Next.js" as build {
        note right
            **ç’°å¢ƒå¤‰æ•°**
            NEXT_PUBLIC_COGNITO_USER_POOL_ID
            NEXT_PUBLIC_COGNITO_CLIENT_ID
            NEXT_PUBLIC_API_ENDPOINT

            **ã‚³ãƒãƒ³ãƒ‰**
            yarn build

            **å‡ºåŠ›**
            .next/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
        end note
    }

    rectangle "7ï¸âƒ£ Static Export" as export {
        note right
            **ã‚³ãƒãƒ³ãƒ‰**
            yarn export

            **å‡ºåŠ›**
            out/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
            - index.html
            - _next/static/
            - assets/

            **ã‚µã‚¤ã‚º**
            ~50MB (gzipåœ§ç¸®å‰)
        end note
    }

    rectangle "8ï¸âƒ£ Configure AWS" as awsConfig {
        note right
            **AWS Credentials**
            aws-access-key-id
            aws-secret-access-key
            region: ap-northeast-1
        end note
    }

    rectangle "9ï¸âƒ£ S3 Sync" as s3Sync {
        note right
            **é™çš„ã‚¢ã‚»ãƒƒãƒˆ (é•·æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥)**
            aws s3 sync out/ s3://bucket/ \
              --exclude "*.html" \
              --exclude "*.json" \
              --cache-control "public, max-age=31536000, immutable"

            **HTMLãƒ•ã‚¡ã‚¤ãƒ« (çŸ­æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥)**
            aws s3 sync out/ s3://bucket/ \
              --exclude "*" \
              --include "*.html" \
              --cache-control "public, max-age=300, must-revalidate"

            **ã‚ªãƒ—ã‚·ãƒ§ãƒ³**
            --delete (å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤)
            --size-only (ã‚µã‚¤ã‚ºå¤‰æ›´ã®ã¿åŒæœŸ)
        end note
    }

    rectangle "ğŸ”Ÿ CloudFront Invalidation" as cfInvalidation {
        note right
            **ã‚³ãƒãƒ³ãƒ‰**
            aws cloudfront create-invalidation \
              --distribution-id E1XXXXXXXXX \
              --paths "/*"

            **å®Œäº†æ™‚é–“**
            30-60ç§’

            **ã‚³ã‚¹ãƒˆ**
            æœ€åˆã®1,000ãƒ‘ã‚¹: ç„¡æ–™/æœˆ
            ä»¥é™: $0.005/ãƒ‘ã‚¹
        end note
    }

    rectangle "1ï¸âƒ£1ï¸âƒ£ Deployment Summary" as summary {
        note right
            âœ… Deployment completed
            ğŸŒ Frontend URL
            ğŸ“¦ S3 Bucket
            â˜ï¸ CloudFront Distribution
            â±ï¸ Deploy Time
        end note
    }
}

' ================================
' AWS Infrastructure
' ================================
rectangle "AWS ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£" <<AWS>> {
    SimpleStorageService(s3, "S3 Bucket", "cis-filesearch-frontend-prod\n- Versioning: Enabled\n- Intelligent-Tiering\n- Server-Side Encryption: AES256\n- Lifecycle Policy: 90æ—¥å¾ŒArchive")

    CloudFront(cloudfront, "CloudFront Distribution", "E1XXXXXXXXX\n- Custom Domain: filesearch.company.com\n- TLS 1.3 (ACM)\n- Cache Behavior:\n  â€¢ HTML: max-age=300 (5åˆ†)\n  â€¢ JS/CSS: max-age=31536000 (1å¹´)\n- Compression: Brotli/Gzip")

    Route53(route53, "Route53", "A Record (Alias)\nfilesearch.company.com\nâ†’ CloudFront")

    CloudWatch(cloudwatch, "CloudWatch", "- Access Logs\n- Error Rate Alarms\n- Cache Hit Ratio\n- Origin Latency")
}

' ================================
' Users
' ================================
Users(users, "ãƒ¦ãƒ¼ã‚¶ãƒ¼", "50å\nHTTPS ã‚¢ã‚¯ã‚»ã‚¹")

' ================================
' Success/Failure Paths
' ================================
rectangle "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ" <<Success>> {
    note as successNote
        **æˆåŠŸæ™‚ã®é€šçŸ¥**
        ãƒ»GitHub Actionsé€šçŸ¥: âœ… Workflow succeeded
        ãƒ»Slacké€šçŸ¥: æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
        ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²: CloudWatch Custom Metrics
        ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸è¦
    end note
}

rectangle "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—" <<Failed>> {
    note as failedNote
        **å¤±æ•—æ™‚ã®å¯¾å¿œ**
        ãƒ»GitHub Actionsé€šçŸ¥: âŒ Workflow failed
        ãƒ»Slacké€šçŸ¥: ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã‚¢ãƒ©ãƒ¼ãƒˆ
        ãƒ»è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯:
          1. S3ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã§å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¾©å…ƒ
          2. CloudFront Invalidationå†å®Ÿè¡Œ
        ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°: CloudWatch Logs
    end note
}

' ================================
' Flow Connections
' ================================

' Development Flow
Dev --> LocalRepo : ã‚³ãƒ¼ãƒ‰ä½œæˆãƒ»ä¿®æ­£
LocalRepo --> trigger : git push origin main

' CI/CD Flow
trigger --> checkout
checkout --> setupNode
setupNode --> install
install --> test

test --> build : ãƒ†ã‚¹ãƒˆæˆåŠŸ
test .down.> failedNote : ãƒ†ã‚¹ãƒˆå¤±æ•—

build --> export : ãƒ“ãƒ«ãƒ‰æˆåŠŸ
build .down.> failedNote : ãƒ“ãƒ«ãƒ‰å¤±æ•—

export --> awsConfig
awsConfig --> s3Sync
s3Sync --> s3 : â‘  ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰\n(å·®åˆ†ã®ã¿)

s3Sync --> cfInvalidation : â‘¡ S3åŒæœŸå®Œäº†
cfInvalidation --> cloudfront : â‘¢ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–\nãƒ‘ã‚¹: /*

cfInvalidation --> summary : â‘£ Invalidationå®Œäº†

summary --> successNote : ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ

' AWS Infrastructure Flow
cloudfront <--> s3 : Origin Access Control\n(OAC)

route53 --> cloudfront : DNSè§£æ±º\nAlias Record

cloudfront --> users : â‘¤ é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡\nHTTPS (TLS 1.3)

' Monitoring Flow
s3 .up.> cloudwatch : S3ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥
cloudfront .up.> cloudwatch : ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°\nãƒ¡ãƒˆãƒªã‚¯ã‚¹

' Rollback Flow (Dotted)
failedNote .right.> s3 : ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯\nS3ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å¾©å…ƒ
s3 .right.> cfInvalidation : ã‚­ãƒ£ãƒƒã‚·ãƒ¥å†ç„¡åŠ¹åŒ–

' ================================
' Deployment Timing Diagram
' ================================
note as timingNote
    **ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¿ã‚¤ãƒŸãƒ³ã‚°**

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Phase                    â”‚ Duration  â”‚ Cumulative      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ 1. Checkout              â”‚ 5s        â”‚ 5s              â”‚
    â”‚ 2. Setup Node.js         â”‚ 10s       â”‚ 15s             â”‚
    â”‚ 3. Install Dependencies  â”‚ 30s       â”‚ 45s             â”‚
    â”‚ 4. Lint & Test           â”‚ 20s       â”‚ 1m 5s           â”‚
    â”‚ 5. Build Next.js         â”‚ 60s       â”‚ 2m 5s           â”‚
    â”‚ 6. Static Export         â”‚ 10s       â”‚ 2m 15s          â”‚
    â”‚ 7. Configure AWS         â”‚ 5s        â”‚ 2m 20s          â”‚
    â”‚ 8. S3 Sync               â”‚ 15s       â”‚ 2m 35s          â”‚
    â”‚ 9. CloudFront Invalidate â”‚ 45s       â”‚ 3m 20s          â”‚
    â”‚ 10. Summary              â”‚ 5s        â”‚ 3m 25s          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    **åˆè¨ˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“**: ç´„3åˆ†25ç§’

    **CloudFronté…ä¿¡é–‹å§‹**: Invalidationå®Œäº†å¾Œ30-60ç§’
    **å®Ÿè³ªãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **: 0ç§’ (Blue/Greenè‡ªå‹•åˆ‡æ›¿)
end note

' ================================
' Rollback Strategy
' ================================
note as rollbackNote
    **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥**

    **æ–¹æ³•1: S3ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å¾©å…ƒ**
    ```bash
    # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³IDã‚’ç¢ºèª
    aws s3api list-object-versions \
      --bucket cis-filesearch-frontend-prod \
      --prefix index.html

    # å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¾©å…ƒ
    aws s3api copy-object \
      --copy-source cis-filesearch-frontend-prod/index.html?versionId=xxx \
      --bucket cis-filesearch-frontend-prod \
      --key index.html

    # CloudFront ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–
    aws cloudfront create-invalidation \
      --distribution-id E1XXXXXXXXX \
      --paths "/*"
    ```

    **æ–¹æ³•2: GitHub Actions Revert**
    ```bash
    # ã‚³ãƒŸãƒƒãƒˆã‚’revert
    git revert HEAD
    git push origin main

    # è‡ªå‹•çš„ã«æ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹
    ```

    **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚é–“**: 1-2åˆ†
end note

' ================================
' Environment Variables Management
' ================================
note as envNote
    **ç’°å¢ƒå¤‰æ•°ç®¡ç†**

    **GitHub Secrets**
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - COGNITO_USER_POOL_ID
    - COGNITO_CLIENT_ID
    - CLOUDFRONT_DISTRIBUTION_ID

    **ãƒ“ãƒ«ãƒ‰æ™‚ç’°å¢ƒå¤‰æ•°**
    ```yaml
    env:
      NEXT_PUBLIC_COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
      NEXT_PUBLIC_COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
      NEXT_PUBLIC_API_ENDPOINT: https://api.filesearch.company.com
    ```

    **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
    - ç§˜å¯†éµã¯GitHub Secretsã§ç®¡ç†
    - NEXT_PUBLIC_* ã®ã¿ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å…¬é–‹
    - ãƒ“ãƒ«ãƒ‰æ™‚ã«ç’°å¢ƒå¤‰æ•°ã‚’åŸ‹ã‚è¾¼ã¿
end note

' ================================
' Cache Strategy
' ================================
note as cacheNote
    **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**

    **é™çš„ã‚¢ã‚»ãƒƒãƒˆ (JS/CSS/Images)**
    - Cache-Control: public, max-age=31536000, immutable
    - ãƒ•ã‚¡ã‚¤ãƒ«åã«ãƒãƒƒã‚·ãƒ¥å«ã‚€: main.abc123.js
    - CloudFrontã§1å¹´é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - ã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã¯æ–°ãƒãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ä¸è¦

    **HTMLãƒ•ã‚¡ã‚¤ãƒ« (index.html, 404.html)**
    - Cache-Control: public, max-age=300, must-revalidate
    - CloudFrontã§5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    - ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«Invalidationå®Ÿè¡Œ

    **API ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
    - Cache-Control: no-cache, no-store, must-revalidate
    - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„ï¼ˆå‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰

    **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡ç›®æ¨™**: 90%ä»¥ä¸Š
end note

@enduml
