@startuml CIS File Search Pattern 3 S3 CloudFront Cognito Architecture

!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist
!include AWSPuml/AWSCommon.puml
!include AWSPuml/AWSSimplified.puml

' Compute
!include AWSPuml/Compute/Lambda.puml

' Storage
!include AWSPuml/Storage/SimpleStorageService.puml

' Database
!include AWSPuml/Database/DynamoDB.puml

' Analytics
!include AWSPuml/Analytics/OpenSearchService.puml

' Application Integration
!include AWSPuml/ApplicationIntegration/StepFunctions.puml
!include AWSPuml/ApplicationIntegration/EventBridge.puml
!include AWSPuml/ApplicationIntegration/SimpleNotificationService.puml

' Management & Governance
!include AWSPuml/ManagementGovernance/CloudWatch.puml

' Migration & Transfer
!include AWSPuml/MigrationTransfer/DataSync.puml

' Networking & Content Delivery
!include AWSPuml/NetworkingContentDelivery/VPNConnection.puml
!include AWSPuml/NetworkingContentDelivery/VPC.puml
!include AWSPuml/NetworkingContentDelivery/Route53.puml
!include AWSPuml/NetworkingContentDelivery/APIGateway.puml
!include AWSPuml/NetworkingContentDelivery/CloudFront.puml

' Security, Identity & Compliance
!include AWSPuml/SecurityIdentityCompliance/CertificateManager.puml
!include AWSPuml/SecurityIdentityCompliance/Cognito.puml

' General
!include AWSPuml/General/Users.puml
!include AWSPuml/General/TraditionalServer.puml
!include AWSPuml/General/Client.puml

' Define custom colors
!define BATCH_COLOR #0066CC
!define SEARCH_COLOR #00AA00
!define MONITOR_COLOR #00BCD4
!define TRANSFER_COLOR #FF9900
!define AUTH_COLOR #9C27B0

' Define groups
skinparam rectangle {
    BackgroundColor<<OnPremise>> #F5F5F5
    BorderColor<<OnPremise>> #CCCCCC
    BackgroundColor<<AWS>> #FFF7E6
    BorderColor<<AWS>> #FF9800
    BackgroundColor<<VPC>> #E8F4F8
    BorderColor<<VPC>> #0277BD
    BackgroundColor<<PublicSubnet>> #BBDEFB
    BorderColor<<PublicSubnet>> #1976D2
    BackgroundColor<<PrivateSubnet>> #FCE4EC
    BorderColor<<PrivateSubnet>> #C2185B
    BackgroundColor<<Lambda>> #FFFDE7
    BorderColor<<Lambda>> #FBC02D
    BackgroundColor<<Managed>> #FFF9C4
    BorderColor<<Managed>> #F57F17
    BackgroundColor<<Frontend>> #E1F5FE
    BorderColor<<Frontend>> #01579B
    BackgroundColor<<Auth>> #F3E5F5
    BorderColor<<Auth>> #4A148C
}

title CIS File Search - Pattern 3 Architecture\n月次バッチ同期アーキテクチャ (S3静的ホスティング + Cognito認証)\n月額コスト: $51.79/月 | ECS Fargate比: -26.3% ($18.45/月削減)

' ================================
' User Layer
' ================================
Users(user, "ユーザー", "社内50名\nブラウザアクセス")

' ================================
' Frontend & CDN Layer
' ================================
rectangle "フロントエンド配信層（CDN）" <<Frontend>> {
    Route53(route53, "Route53", "filesearch.company.com\nHosted Zone\n$0.50/月")

    CloudFront(cloudfront, "CloudFront", "Custom Domain\n- TLS 1.3 (ACM証明書 無料)\n- Edge Cache: 24h\n- Brotli/Gzip圧縮\n- 10GB転送/月\n- 500K リクエスト/月\n$2.05/月")

    CertificateManager(acm, "ACM Certificate", "*.company.com\nDNS検証\n自動更新\n無料")

    SimpleStorageService(s3frontend, "S3 Frontend Bucket", "cis-filesearch-frontend-prod\nIntelligent-Tiering\n- Next.js Static: 50MB\n- バージョニング有効\n- OAC (Origin Access Control)\n$0.01/月")
}

' ================================
' Authentication Layer
' ================================
rectangle "認証・認可層" <<Auth>> {
    Cognito(cognitoUserPool, "Cognito User Pool", "cis-filesearch-users\n- ユーザー: 50名\n- パスワード: 12+文字\n- MFA: OPTIONAL (TOTP)\n- Advanced Security\n$2.50/月 (50 MAU)")

    rectangle "Cognito Hosted UI" as hostedUI {
        note right: OAuth 2.0 PKCE\ncis-filesearch.auth\n.ap-northeast-1\n.amazoncognito.com
    }

    rectangle "Identity Pool" as identityPool {
        note right: IAM Roles\nS3/API Access
    }
}

' ================================
' On-Premise Infrastructure
' ================================
rectangle "オンプレミス環境" <<OnPremise>> {
    TraditionalServer(nas, "NAS Server", "SMB/NFS\n500GB\n1,000,000 files")

    rectangle "DataSync Agent" as dsAgent {
        note right: 増分検出エージェント\nversion: 1.0.52
    }

    rectangle "VPN Router" as vpnRouter {
        note right: Customer Gateway\nCisco ASA 5506
    }

    nas --> dsAgent
    dsAgent --> vpnRouter
}

' ================================
' AWS Cloud Infrastructure
' ================================
rectangle "AWS Cloud (ap-northeast-1)" <<AWS>> {
    ' VPC Container
    rectangle "VPC: 10.0.0.0/16" <<VPC>> {
        ' Internet Gateway (VPC-level)
        rectangle "Internet Gateway" as igw {
            note right: インターネット接続
        }

        ' Virtual Private Gateway (VPC-level)
        VPNConnection(vpg, "Virtual Private Gateway", "Site-to-Site VPN\n⏰ 月4時間のみ接続\n2:00-6:00 (月1日)")

        ' Public Subnet
        rectangle "Public Subnet: 10.0.0.0/24 (AZ-a)" <<PublicSubnet>> {
            rectangle "NAT Gateway" as natGW {
                note right: Elastic IP\nインターネット経由\nアクセス制御
            }
        }

        ' Private Subnet 1
        rectangle "Private Subnet 1: 10.0.1.0/24 (AZ-a)" <<PrivateSubnet>> {
            ' Batch Processing Layer
            Lambda(vpnMgr, "VPNManager", "Python 3.11\n512MB ARM64\n- VPN接続制御\n- 接続監視")

            Lambda(fileScanner, "FileScanner", "Node.js 20\n1024MB ARM64\n- S3全スキャン\n- メタデータ収集")

            Lambda(textExt, "TextExtractor", "Python 3.11\n2048MB ARM64\n- PDF解析\n月5,000実行")

            Lambda(imgExt, "ImageFeatureExtractor", "Python 3.11\n2048MB ARM64\n- ResNet-50\n月2,000実行")

            Lambda(bulkIdx, "BulkIndexer", "Node.js 20\n1024MB ARM64\n- Bulk API\n- DynamoDB更新")

            ' Search Engine in Private Subnet
            OpenSearchService(opensearch, "OpenSearch Service", "t3.small.search\nvCPU: 2, RAM: 2GB\n50GB gp3\n- kuromoji (日本語)\n- k-NN (画像類似)\n$31.57/月")
        }

        ' Private Subnet 2
        rectangle "Private Subnet 2: 10.0.2.0/24 (AZ-b)" <<PrivateSubnet>> {
            ' API Layer in Private Subnet 2
            Lambda(searchAPI, "SearchAPI", "Node.js 20\n512MB ARM64\nPOST /api/search\n月10,000実行\nMulti-AZ冗長性\nCognito JWT検証")
        }
    }

    ' API Gateway Layer
    APIGateway(apiGateway, "API Gateway", "api.filesearch.company.com\n- Cognito Authorizer\n- Custom Domain\n- ACM証明書 (無料)\n- CORS設定\n- IPアドレス制限\n- Throttling: 100req/秒\n$0.20/月")

    ' Managed Services (Outside VPC)
    rectangle "マネージドサービス層（VPC外）" <<Managed>> {
        ' Data Transfer Layer
        DataSync(dataSync, "AWS DataSync", "増分同期: 20GB/月\n転送レート: 100Mbps\n転送時間: 約3時間\n$5.00/月")

        ' Storage Layer
        SimpleStorageService(s3backend, "S3 Backend Bucket", "Intelligent-Tiering\n100GB\n- 抽出テキスト: 40GB\n- 画像特徴量: 10GB\n- サムネイル: 30GB\n- ログ: 20GB\n$2.13/月")

        ' Database Layer
        DynamoDB(dynamodb, "DynamoDB", "On-Demand\n- file_metadata: 5GB\n- sync_jobs: 100MB\n$0.99/月")
    }

    ' Orchestration Layer (Outside VPC)
    rectangle "オーケストレーション層" <<Managed>> {
        StepFunctions(stepFunc, "Step Functions", "MonthlyBatchSyncWorkflow\n実行頻度: 月1回\n実行時間: 5-6時間")

        EventBridge(eventBridge, "EventBridge", "cron(0 2 1 * ? *)\n毎月1日 深夜2時")

        SimpleNotificationService(sns, "SNS", "BatchNotifications\n管理者メール × 5")
    }

    ' Monitoring Layer (Outside VPC)
    CloudWatch(cloudwatch, "CloudWatch", "Logs: 2GB/月\nMetrics: 10個\nAlarms: 5個\n$4.00/月")
}

' ================================
' VPN Connection (Dashed - 月4時間のみ)
' ================================
vpnRouter .up.> vpg : <color:#0066CC>VPN接続\n<color:#0066CC>月4時間のみ\n<color:#0066CC>暗号化通信

' ================================
' User Authentication Flow (Purple)
' ================================
user -[#9C27B0,thickness=3]-> route53 : <color:#9C27B0>① HTTPS\n<color:#9C27B0>filesearch.company.com

route53 -[#9C27B0,thickness=3]-> cloudfront : <color:#9C27B0>② DNS解決

cloudfront -[#9C27B0,thickness=2]-> acm : <color:#9C27B0>③ TLS 1.3検証

cloudfront <-[#9C27B0,thickness=3]-> s3frontend : <color:#9C27B0>④ 静的コンテンツ配信\n<color:#9C27B0>Next.js Static Export

user <.[#9C27B0,thickness=2].> hostedUI : <color:#9C27B0>⑤ 未認証時\n<color:#9C27B0>Redirect to Login

hostedUI -[#9C27B0,thickness=3]-> cognitoUserPool : <color:#9C27B0>⑥ 認証\n<color:#9C27B0>(username + password)\n<color:#9C27B0>+ MFA (Optional)

cognitoUserPool -[#9C27B0,thickness=3]-> hostedUI : <color:#9C27B0>⑦ Authorization Code

hostedUI -[#9C27B0,thickness=3]-> user : <color:#9C27B0>⑧ Callback\n<color:#9C27B0>?code=xxx

user -[#9C27B0,thickness=3]-> cognitoUserPool : <color:#9C27B0>⑨ POST /oauth2/token\n<color:#9C27B0>PKCE Code Verifier

cognitoUserPool -[#9C27B0,thickness=3]-> user : <color:#9C27B0>⑩ JWT Tokens\n<color:#9C27B0>(id_token, access_token,\n<color:#9C27B0>refresh_token)

' ================================
' User Search Flow (Green)
' ================================
user -[#00AA00,thickness=3]-> route53 : <color:#00AA00>⑪ POST /api/search\n<color:#00AA00>Authorization: Bearer {token}

route53 -[#00AA00,thickness=2]-> apiGateway : <color:#00AA00>⑫ DNS解決\n<color:#00AA00>api.filesearch.company.com

apiGateway -[#00AA00,thickness=3]-> cognitoUserPool : <color:#00AA00>⑬ JWT検証\n<color:#00AA00>Cognito Authorizer

cognitoUserPool -[#00AA00,thickness=3]-> apiGateway : <color:#00AA00>⑭ 認可OK\n<color:#00AA00>{sub, email}

apiGateway -[#00AA00,thickness=3]-> searchAPI : <color:#00AA00>⑮ Invoke\n<color:#00AA00>(認証済みコンテキスト)

searchAPI <-[#00AA00,thickness=2]-> opensearch : <color:#00AA00>⑯ 全文検索\n<color:#00AA00>kuromoji tokenizer

searchAPI <-[#00AA00,thickness=2]-> dynamodb : <color:#00AA00>⑰ GetItem\n<color:#00AA00>file_metadata

searchAPI <-[#00AA00,thickness=2]-> s3backend : <color:#00AA00>⑱ GetObject\n<color:#00AA00>ハイライト用

searchAPI -[#00AA00,thickness=3]-> user : <color:#00AA00>⑲ 検索結果JSON

' ================================
' Batch Synchronization Flow (Blue)
' ================================
eventBridge -[#0066CC,thickness=3]-> stepFunc : <color:#0066CC>⑳ 月1回トリガー

stepFunc -[#0066CC,thickness=3]-> vpnMgr : <color:#0066CC>㉑ VPN接続開始

vpnMgr .[#0066CC,thickness=2].> vpg : <color:#0066CC>㉒ VPN接続確立

vpnMgr -[#0066CC,thickness=3]-> dataSync : <color:#0066CC>㉓ DataSync起動

' Data Transfer Flow (Orange)
nas -[#FF9900,thickness=4]-> dsAgent
dsAgent -[#FF9900,thickness=4]-> vpnRouter
vpnRouter -[#FF9900,thickness=4]-> vpg
vpg -[#FF9900,thickness=4]-> dataSync : <color:#FF9900>㉔ 増分データ転送\n<color:#FF9900>20GB/月, 3時間
dataSync -[#FF9900,thickness=4]-> s3backend

stepFunc -[#0066CC,thickness=3]-> vpnMgr : <color:#0066CC>㉕ VPN切断\n<color:#0066CC>同期完了後

stepFunc -[#0066CC,thickness=3]-> fileScanner : <color:#0066CC>㉖ S3スキャン開始\n<color:#0066CC>VPN切断後

fileScanner <-[#00AA00,thickness=2]-> s3backend : <color:#00AA00>㉗ メタデータ取得

fileScanner -[#0066CC,thickness=3]-> textExt : <color:#0066CC>㉘ テキスト抽出\n<color:#0066CC>5,000 PDFs\n<color:#0066CC>最大100並列

fileScanner -[#0066CC,thickness=3]-> imgExt : <color:#0066CC>㉘ 画像特徴抽出\n<color:#0066CC>2,000 Images\n<color:#0066CC>最大50並列

textExt <-[#00AA00,thickness=2]-> s3backend : <color:#00AA00>㉙ 抽出テキスト保存

imgExt <-[#00AA00,thickness=2]-> s3backend : <color:#00AA00>㉙ 特徴ベクトル保存\n<color:#00AA00>512次元

textExt -[#0066CC,thickness=3]-> bulkIdx : <color:#0066CC>㉚ 処理完了通知
imgExt -[#0066CC,thickness=3]-> bulkIdx

bulkIdx -[#00AA00,thickness=2]-> s3backend : <color:#00AA00>㉛ 全データ取得

bulkIdx -[#0066CC,thickness=3]-> opensearch : <color:#0066CC>㉜ Bulk API\n<color:#0066CC>kuromoji + k-NN\n<color:#0066CC>バッチサイズ: 1,000

bulkIdx -[#0066CC,thickness=3]-> dynamodb : <color:#0066CC>㉝ メタデータ更新\n<color:#0066CC>BatchWriteItem

bulkIdx -[#0066CC,thickness=3]-> sns : <color:#0066CC>㉞ 完了通知\n<color:#0066CC>成功/失敗ステータス

' ================================
' Monitoring Flow (Cyan Dotted)
' ================================
vpnMgr .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics
fileScanner .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics
textExt .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics
imgExt .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics
bulkIdx .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics
searchAPI .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics
cloudfront .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics
apiGateway .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics
cognitoUserPool .[#00BCD4,thickness=1].> cloudwatch : <color:#00BCD4>Logs/Metrics

' ================================
' Notes and Legends
' ================================
legend right
    |<color:#9C27B0>━━━━━| <color:#9C27B0>認証フロー (OAuth 2.0 PKCE)
    |<color:#00AA00>━━━━━| <color:#00AA00>検索フロー (Cognito JWT)
    |<color:#0066CC>━━━━━| <color:#0066CC>バッチ同期フロー (月1回)
    |<color:#FF9900>━━━━━| <color:#FF9900>データ転送 (増分20GB)
    |<color:#0066CC>- - - - -| <color:#0066CC>VPN接続 (月4時間のみ)
    |<color:#00BCD4>· · · · ·| <color:#00BCD4>監視ログ

    **コスト構成 ($51.79/月)**
    * OpenSearch: $31.57 (61.0%)
    * DataSync: $5.00 (9.7%)
    * CloudWatch: $4.00 (7.7%)
    * Cognito: $2.50 (4.8%)
    * S3 (backend): $2.13 (4.1%)
    * CloudFront: $2.05 (4.0%)
    * Lambda: $1.35 (2.6%)
    * DynamoDB: $0.99 (1.9%)
    * Route53: $0.50 (1.0%)
    * API Gateway: $0.20 (0.4%)
    * S3 (frontend): $0.01 (0.0%)
    * ACM: $0.00 (無料)
    * その他: $1.50 (2.9%)

    **削減率: ECS Fargate比**
    * ECS Fargate版: $70.24/月
    * S3+CloudFront版: $51.79/月
    * 削減額: $18.45/月 (26.3%削減)
end legend

note as N1
    **主要な特徴**
    ・フロントエンド: S3静的ホスティング + CloudFront
    ・認証: AWS Cognito (OAuth 2.0 PKCE)
    ・月1回の増分同期 (VPN接続: 月4時間のみ)
    ・ファイル実体はNASに保持
    ・メタデータ+テキストのみAWSで管理
    ・全文検索 (kuromoji) + 画像類似検索 (k-NN)
    ・100万ファイル対応
    ・ARM64 (Graviton2) 最適化
end note

note as N2
    **認証フロー**
    1. ユーザーがCloudFront経由でNext.js SPAアクセス
    2. 未認証時はCognito Hosted UIにリダイレクト
    3. username/password + MFA (Optional)で認証
    4. Authorization Code → JWT Tokens取得
    5. Access TokenをlocalStorageに保存
    6. API呼び出し時にBearerトークン付与
    7. API GatewayのCognito AuthorizerがJWT検証
    8. 検証成功後、SearchAPI Lambda実行
end note

note as N3
    **フロントエンド配信**
    ・Next.js Static Export (50MB)
    ・S3 Intelligent-Tiering (コスト最適化)
    ・CloudFront Edge Cache: 24時間
    ・Brotli/Gzip圧縮
    ・TLS 1.3 (ACM証明書 無料)
    ・Origin Access Control (OAC)でS3保護
    ・カスタムドメイン: filesearch.company.com
    ・TTFB: 50-150ms (ECS Fargateの3-5倍高速)
end note

note as N4
    **セキュリティ対策**
    ・Cognito MFA (TOTP/SMS)
    ・パスワードポリシー: 12+文字、複雑性要件
    ・PKCE (Proof Key for Code Exchange)
    ・JWT署名検証 (RS256)
    ・API Gateway IPアドレス制限
    ・Rate Limiting: 100 req/秒
    ・S3暗号化 (AES-256)
    ・CloudWatch監視・アラート
    ・Advanced Security Features: 不正アクセス検知
end note

note as N5
    **Cognitoトークン管理**
    ・ID Token: ユーザー情報 (60分有効)
    ・Access Token: API認可 (60分有効)
    ・Refresh Token: トークン更新 (30日有効)
    ・自動リフレッシュ: 期限切れ前に自動更新
    ・Secure Storage: localStorage (XSS対策必須)
    ・httpOnly Cookie: 推奨 (Refresh Token用)
end note

note as N6
    **デプロイフロー**
    1. GitHub Actions: yarn build
    2. Next.js Static Export: out/
    3. aws s3 sync → S3バケット
    4. CloudFront Invalidation: /*
    5. 配信開始 (30-60秒)

    **ロールバック**
    ・S3バージョニング有効
    ・過去バージョンに即座に復元可能
end note

@enduml
