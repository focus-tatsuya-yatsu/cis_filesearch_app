@startuml CIS File Search Cognito Authentication Sequence

!define AWSPuml https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist
!include AWSPuml/AWSCommon.puml
!include AWSPuml/AWSSimplified.puml

!include AWSPuml/NetworkingContentDelivery/CloudFront.puml
!include AWSPuml/Storage/SimpleStorageService.puml
!include AWSPuml/SecurityIdentityCompliance/Cognito.puml
!include AWSPuml/NetworkingContentDelivery/APIGateway.puml
!include AWSPuml/Compute/Lambda.puml
!include AWSPuml/Analytics/OpenSearchService.puml
!include AWSPuml/Database/DynamoDB.puml

skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 250
skinparam BoxPadding 10

title CIS File Search - Cognitoèªè¨¼ãƒ•ãƒ­ãƒ¼è©³ç´°ã‚·ãƒ¼ã‚±ãƒ³ã‚¹\nOAuth 2.0 Authorization Code Grant with PKCE

actor "ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼" as User
participant "ğŸŒ Browser\n(Next.js SPA)" as Browser
box "CDN Layer" #E1F5FE
    participant "â˜ï¸ CloudFront" as CF
    participant "ğŸª£ S3 Bucket\n(Static)" as S3
end box
box "Authentication Layer" #F3E5F5
    participant "ğŸ¨ Cognito\nHosted UI" as HostedUI
    participant "ğŸ” Cognito\nUser Pool" as Cognito
end box
box "API Layer" #FFF9C4
    participant "ğŸ”Œ API Gateway\n(Cognito Authorizer)" as APIGW
    participant "Î» SearchAPI\nLambda" as Lambda
end box
box "Data Layer" #BBDEFB
    participant "ğŸ” OpenSearch" as OS
    participant "ğŸ—‚ï¸ DynamoDB" as DDB
end box

== åˆå›ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæœªèªè¨¼ï¼‰ ==

User -> Browser : â‘  ã‚¢ã‚¯ã‚»ã‚¹\nhttps://filesearch.company.com
activate Browser

Browser -> CF : â‘¡ GET / HTTP/2\nHost: filesearch.company.com
activate CF

CF -> S3 : â‘¢ GetObject index.html\n(Origin Access Control)
activate S3

S3 --> CF : â‘£ 200 OK\nindex.html (gzipåœ§ç¸®)
deactivate S3

CF --> Browser : â‘¤ 200 OK\nContent-Encoding: gzip\nCache-Control: public, max-age=300
deactivate CF

Browser -> Browser : â‘¥ Next.js SPAèµ·å‹•\nlocalStorageãƒã‚§ãƒƒã‚¯\nâ†’ ãƒˆãƒ¼ã‚¯ãƒ³ãªã—

note right of Browser
    **localStorageç¢ºèª**
    ```javascript
    const idToken = localStorage.getItem('id_token');
    const accessToken = localStorage.getItem('access_token');
    const refreshToken = localStorage.getItem('refresh_token');

    if (!idToken || !accessToken) {
        redirectToLogin();
    }
    ```
end note

Browser -> Browser : â‘¦ PKCE Code Verifierç”Ÿæˆ\n(43-128æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—)

note right of Browser
    **PKCE Code Verifierç”Ÿæˆ**
    ```javascript
    const codeVerifier = generateCodeVerifier();
    // ä¾‹: "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk"

    const codeChallenge = await generateCodeChallenge(codeVerifier);
    // SHA-256ãƒãƒƒã‚·ãƒ¥ã®Base64URL: "E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM"

    localStorage.setItem('pkce_code_verifier', codeVerifier);
    ```
end note

Browser -> Browser : â‘§ Code Challengeç”Ÿæˆ\n(Code Verifierã®SHA-256)

Browser -> HostedUI : â‘¨ Redirect to Login\nGET /oauth2/authorize?\n  response_type=code&\n  client_id=xxx&\n  redirect_uri=https://filesearch.company.com/callback&\n  scope=openid+email+profile&\n  code_challenge_method=S256&\n  code_challenge=E9Melhoa2...
activate HostedUI

== ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ ==

HostedUI --> User : â‘© ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
deactivate HostedUI

User -> HostedUI : â‘ª èªè¨¼æƒ…å ±å…¥åŠ›\nusername (email): user@company.com\npassword: ************
activate HostedUI

HostedUI -> Cognito : â‘« InitiateAuth\nAuthFlow: USER_SRP_AUTH\nUsername: user@company.com\nSRP_A: (Secure Remote Password)
activate Cognito

Cognito -> Cognito : â‘¬ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼\n- æœ€å°12æ–‡å­—\n- å¤§æ–‡å­—/å°æ–‡å­—/æ•°å­—/è¨˜å·\n- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒã‚§ãƒƒã‚¯\n- Advanced Security (ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹æ¤œçŸ¥)

alt MFAæœ‰åŠ¹æ™‚
    Cognito --> HostedUI : â‘­ MFAãƒãƒ£ãƒ¬ãƒ³ã‚¸\nChallengeName: SMS_MFA or SOFTWARE_TOKEN_MFA
    HostedUI --> User : â‘® MFAã‚³ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢
    User -> HostedUI : â‘¯ MFAã‚³ãƒ¼ãƒ‰å…¥åŠ›\nä¾‹: 123456
    HostedUI -> Cognito : â‘° RespondToAuthChallenge\nMFA_CODE: 123456
    Cognito -> Cognito : â‘± MFAã‚³ãƒ¼ãƒ‰æ¤œè¨¼
end

Cognito -> Cognito : â‘² Authorization Codeç”Ÿæˆ\n(æœ‰åŠ¹æœŸé™: 5åˆ†)

Cognito --> HostedUI : â‘³ 302 Redirect\nLocation: https://filesearch.company.com/callback?code=xxx
deactivate Cognito

HostedUI --> Browser : ã‰‘ Redirect to Callback URL
deactivate HostedUI

== ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ› ==

Browser -> Browser : ã‰’ Callback URLãƒ‘ãƒ¼ã‚¹\ncode = urlParams.get('code')

Browser -> Browser : ã‰“ PKCE Code Verifierå–å¾—\nlocalStorage.getItem('pkce_code_verifier')

Browser -> Cognito : ã‰” POST /oauth2/token\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=authorization_code&\nclient_id=xxx&\ncode=xxx&\nredirect_uri=https://filesearch.company.com/callback&\ncode_verifier=dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk
activate Cognito

Cognito -> Cognito : ã‰• Codeæ¤œè¨¼\n- Codeæœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯\n- Redirect URIä¸€è‡´ãƒã‚§ãƒƒã‚¯\n- PKCE Code Challengeæ¤œè¨¼:\n  SHA256(code_verifier) == code_challenge

note right of Cognito
    **PKCEæ¤œè¨¼**
    ```
    received_code_challenge = SHA256(code_verifier)
    if (received_code_challenge == stored_code_challenge) {
        // æ¤œè¨¼æˆåŠŸ
        issue_tokens();
    } else {
        // æ¤œè¨¼å¤±æ•—
        return 400 Bad Request;
    }
    ```
end note

Cognito -> Cognito : ã‰– JWTç”Ÿæˆ\n- ID Token (RS256ç½²å)\n- Access Token (RS256ç½²å)\n- Refresh Token

Cognito --> Browser : ã‰— 200 OK\nContent-Type: application/json\n\n{\n  "id_token": "eyJraWQiOiJxxx...",\n  "access_token": "eyJraWQiOiJxxx...",\n  "refresh_token": "eyJjdHkiOiJKV1Q...",\n  "expires_in": 3600,\n  "token_type": "Bearer"\n}
deactivate Cognito

Browser -> Browser : ã‰˜ ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜\nlocalStorage.setItem('id_token', tokens.id_token)\nlocalStorage.setItem('access_token', tokens.access_token)\nlocalStorage.setItem('refresh_token', tokens.refresh_token)\nlocalStorage.setItem('expires_at', Date.now() + 3600*1000)

Browser -> Browser : ã‰™ PKCE Code Verifierå‰Šé™¤\nlocalStorage.removeItem('pkce_code_verifier')

Browser --> User : ã‰š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º\nèªè¨¼å®Œäº†
deactivate Browser

== æ¤œç´¢APIå‘¼ã³å‡ºã—ï¼ˆèªè¨¼æ¸ˆã¿ï¼‰ ==

User -> Browser : ã‰› æ¤œç´¢ã‚¯ã‚¨ãƒªå…¥åŠ›\nã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ææ¡ˆæ›¸ã€
activate Browser

Browser -> Browser : ã‰œ Access Tokenæœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯\nconst expiresAt = localStorage.getItem('expires_at')\nif (Date.now() > expiresAt) {\n  await refreshAccessToken();\n}

Browser -> APIGW : ã‰ POST /api/search HTTP/2\nHost: api.filesearch.company.com\nAuthorization: Bearer eyJraWQiOiJxxx...\nContent-Type: application/json\n\n{\n  "query": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ææ¡ˆæ›¸",\n  "filters": {"fileType": "pdf"}\n}
activate APIGW

APIGW -> APIGW : ã‰ Cognito Authorizerèµ·å‹•\nJWTæ¤œè¨¼é–‹å§‹

APIGW -> Cognito : ã‰Ÿ GET /.well-known/jwks.json\n(JSON Web Key Setå–å¾—)
activate Cognito

Cognito --> APIGW : ãŠ± 200 OK\n{\n  "keys": [\n    {\n      "kid": "qxx...",\n      "alg": "RS256",\n      "kty": "RSA",\n      "n": "xxx...",\n      "e": "AQAB"\n    }\n  ]\n}
deactivate Cognito

APIGW -> APIGW : ãŠ² JWTç½²åæ¤œè¨¼\n- Header.kid â†’ JWKSç…§åˆ\n- RS256ç½²åæ¤œè¨¼\n- exp (æœ‰åŠ¹æœŸé™)ãƒã‚§ãƒƒã‚¯\n- iss (Issuer)ãƒã‚§ãƒƒã‚¯\n- aud (Audience)ãƒã‚§ãƒƒã‚¯

note right of APIGW
    **JWTæ¤œè¨¼ã‚¹ãƒ†ãƒƒãƒ—**
    1. Header.kidã§JWKSå†…ã®å…¬é–‹éµã‚’ç‰¹å®š
    2. RS256ç½²åæ¤œè¨¼ (å…¬é–‹éµã§å¾©å·)
    3. Payloadæ¤œè¨¼:
       - exp: 1745305200 > Date.now()/1000
       - iss: https://cognito-idp.ap-northeast-1.amazonaws.com/ap-northeast-1_xxx
       - aud: client_id
       - token_use: "access"
end note

alt JWTæ¤œè¨¼å¤±æ•—
    APIGW --> Browser : ãŠ³ 401 Unauthorized\nWWW-Authenticate: Bearer error="invalid_token"
    Browser -> Browser : Refresh Tokenä½¿ç”¨
    Browser -> Cognito : POST /oauth2/token\ngrant_type=refresh_token&\nrefresh_token=xxx
    Cognito --> Browser : æ–°ã—ã„Access Token
    Browser -> APIGW : ãƒªãƒˆãƒ©ã‚¤ (æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³)
end

APIGW -> APIGW : ãŠ´ èªå¯ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ\n{\n  "sub": "a1b2c3d4-...",\n  "email": "user@company.com",\n  "cognito:username": "user@company.com"\n}

APIGW -> Lambda : ãŠµ Invoke\nevent.requestContext.authorizer = {\n  claims: {\n    sub: "a1b2c3d4-...",\n    email: "user@company.com"\n  }\n}
activate Lambda

Lambda -> Lambda : ãŠ¶ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå–å¾—\nconst userId = event.requestContext.authorizer.claims.sub\nconst userEmail = event.requestContext.authorizer.claims.email

Lambda -> OS : ãŠ· Search Query\nPOST /files/_search\n{\n  "query": {\n    "bool": {\n      "must": [\n        {"match": {"content": "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ææ¡ˆæ›¸"}}\n      ],\n      "filter": [\n        {"term": {"fileType": "pdf"}}\n      ]\n    }\n  }\n}
activate OS

OS --> Lambda : ãŠ¸ Search Results\n{\n  "hits": {\n    "total": 42,\n    "hits": [...]\n  }\n}
deactivate OS

Lambda -> DDB : ãŠ¹ BatchGetItem\nKeys: [file_id_1, file_id_2, ...]
activate DDB

DDB --> Lambda : ãŠº File Metadata\n{\n  "file_id_1": {...},\n  "file_id_2": {...}\n}
deactivate DDB

Lambda -> Lambda : ãŠ» æ¤œç´¢çµæœãƒãƒ¼ã‚¸\n- OpenSearchæ¤œç´¢çµæœ\n- DynamoDBãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿\n- ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨˜éŒ²

Lambda --> APIGW : ãŠ¼ 200 OK\n{\n  "success": true,\n  "data": {\n    "total": 42,\n    "results": [...]\n  }\n}
deactivate Lambda

APIGW --> Browser : ãŠ½ 200 OK\nContent-Type: application/json\nAccess-Control-Allow-Origin: https://filesearch.company.com
deactivate APIGW

Browser --> User : ãŠ¾ æ¤œç´¢çµæœè¡¨ç¤º\n42ä»¶ã®æ¤œç´¢çµæœ
deactivate Browser

== ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆ1æ™‚é–“å¾Œï¼‰ ==

User -> Browser : ãŠ¿ æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆ\n(Access TokenæœŸé™åˆ‡ã‚Œ)
activate Browser

Browser -> Browser : Access TokenæœŸé™ãƒã‚§ãƒƒã‚¯\nDate.now() > expiresAt â†’ true

Browser -> Cognito : POST /oauth2/token\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=refresh_token&\nclient_id=xxx&\nrefresh_token=eyJjdHkiOiJKV1Q...
activate Cognito

Cognito -> Cognito : Refresh Tokenæ¤œè¨¼\n- æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ (30æ—¥)\n- Revocationãƒã‚§ãƒƒã‚¯

Cognito --> Browser : 200 OK\n{\n  "id_token": "eyJraWQiOiJxxx...",\n  "access_token": "eyJraWQiOiJxxx...",\n  "expires_in": 3600,\n  "token_type": "Bearer"\n}
deactivate Cognito

Browser -> Browser : æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜\nlocalStorage.setItem('id_token', tokens.id_token)\nlocalStorage.setItem('access_token', tokens.access_token)\nlocalStorage.setItem('expires_at', Date.now() + 3600*1000)

Browser -> APIGW : æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†é€\nAuthorization: Bearer {new_access_token}

APIGW -> Lambda : æ­£å¸¸å‡¦ç†
Lambda --> Browser : æ¤œç´¢çµæœ
Browser --> User : æ¤œç´¢çµæœè¡¨ç¤º
deactivate Browser

@enduml
