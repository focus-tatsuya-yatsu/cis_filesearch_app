# AWS Event Flow Diagram

**ç†è§£ã‚’æ·±ã‚ã‚‹ãŸã‚ã®è¦–è¦šçš„ã‚¬ã‚¤ãƒ‰**

---

## ðŸ”„ ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆè¨­å®šå¾Œï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Windows Scanner PC                          â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ NASãƒ•ã‚¡ã‚¤ãƒ«  â”‚                                               â”‚
â”‚  â”‚  ã‚¹ã‚­ãƒ£ãƒ³    â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â”‚ DataSync                                               â”‚
â”‚         â–¼                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ AWS DataSync (æ¯Ž30åˆ†è‡ªå‹•åŒæœŸ)
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AWS Cloud                               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚         S3 Bucket                          â”‚                 â”‚
â”‚  â”‚    cis-filesearch-s3-landing               â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚  files/                                    â”‚                 â”‚
â”‚  â”‚  â”œâ”€â”€ 2025/                                 â”‚                 â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ 01/                               â”‚                 â”‚
â”‚  â”‚  â”‚   â”‚   â”œâ”€â”€ document1.pdf  â—„â”€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â”‚                 â”‚
â”‚  â”‚  â”‚   â”‚   â””â”€â”€ image.jpg                     â”‚                 â”‚
â”‚  â”‚  â”‚   â””â”€â”€ 02/                               â”‚                 â”‚
â”‚  â”‚  â””â”€â”€ test/  â—„â”€ ã“ã‚Œã¯ç„¡è¦–ã•ã‚Œã‚‹            â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚  â˜‘ï¸ EventBridgeé€šçŸ¥: æœ‰åŠ¹                 â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                   â”‚                                              â”‚
â”‚                   â”‚ è‡ªå‹•ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡                             â”‚
â”‚                   â”‚                                              â”‚
â”‚                   â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚        Amazon EventBridge                  â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚  ãƒ«ãƒ¼ãƒ«: cis-s3-to-sqs-file-upload        â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚  Event Pattern:                            â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                 â”‚
â”‚  â”‚  â”‚ source: aws.s3                       â”‚ â”‚                 â”‚
â”‚  â”‚  â”‚ detail-type: Object Created          â”‚ â”‚                 â”‚
â”‚  â”‚  â”‚ bucket: cis-filesearch-s3-landing    â”‚ â”‚                 â”‚
â”‚  â”‚  â”‚ key.prefix: files/  â—„â”€ ãƒ•ã‚£ãƒ«ã‚¿      â”‚ â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚  Input Transformer:                        â”‚                 â”‚
â”‚  â”‚  å¤§ããªã‚¤ãƒ™ãƒ³ãƒˆ â†’ å°ã•ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›  â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                   â”‚                                              â”‚
â”‚                   â”‚ ãƒžãƒƒãƒã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®ã¿é€ä¿¡                   â”‚
â”‚                   â”‚                                              â”‚
â”‚                   â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚         Amazon SQS Queue                   â”‚                 â”‚
â”‚  â”‚    cis-filesearch-index-queue              â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¾‹:                             â”‚                 â”‚
â”‚  â”‚  {                                         â”‚                 â”‚
â”‚  â”‚    "eventType": "S3_OBJECT_CREATED",       â”‚                 â”‚
â”‚  â”‚    "s3Bucket": "cis-filesearch-...",       â”‚                 â”‚
â”‚  â”‚    "s3Key": "files/2025/01/doc.pdf",       â”‚                 â”‚
â”‚  â”‚    "fileSize": 1048576,                    â”‚                 â”‚
â”‚  â”‚    "etag": "...",                          â”‚                 â”‚
â”‚  â”‚    "eventTime": "2025-01-19T10:30:00Z",    â”‚                 â”‚
â”‚  â”‚    "processingRequired": true              â”‚                 â”‚
â”‚  â”‚  }                                         â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚  âš™ï¸ Retention: 7æ—¥é–“                       â”‚                 â”‚
â”‚  â”‚  âš™ï¸ Visibility Timeout: 5åˆ†                â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                   â”‚                                              â”‚
â”‚                   â”‚ Long Polling (20ç§’)                          â”‚
â”‚                   â”‚                                              â”‚
â”‚                   â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚      EC2 Auto Scaling Group                â”‚                 â”‚
â”‚  â”‚                                            â”‚                 â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                 â”‚
â”‚  â”‚  â”‚ Worker 1 â”‚  â”‚ Worker 2 â”‚  â”‚ Worker 3 â”‚ â”‚                 â”‚
â”‚  â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚ â”‚                 â”‚
â”‚  â”‚  â”‚ Python   â”‚  â”‚ Python   â”‚  â”‚ Python   â”‚ â”‚                 â”‚
â”‚  â”‚  â”‚ Worker   â”‚  â”‚ Worker   â”‚  â”‚ Worker   â”‚ â”‚                 â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚                 â”‚
â”‚  â”‚        â”‚             â”‚             â”‚       â”‚                 â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                 â”‚
â”‚  â”‚                     â”‚                       â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â”‚ ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†                             â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚         å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³                      â”‚               â”‚
â”‚  â”‚                                              â”‚               â”‚
â”‚  â”‚  1. S3ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰                â”‚               â”‚
â”‚  â”‚  2. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º                            â”‚               â”‚
â”‚  â”‚  3. Bedrockï¼ˆç”»åƒã®å ´åˆã®ã¿ãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼‰       â”‚               â”‚
â”‚  â”‚  4. OpenSearchã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹                 â”‚               â”‚
â”‚  â”‚  5. PostgreSQL RDSã«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ä¿å­˜           â”‚               â”‚
â”‚  â”‚  6. ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ â†’ S3ä¿å­˜                  â”‚               â”‚
â”‚  â”‚  7. SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ï¼ˆå®Œäº†é€šçŸ¥ï¼‰            â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ” ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ•ãƒ­ãƒ¼

### 1. S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ

```json
{
  "version": "0",
  "id": "c6c5a3f4-d8d0-4b88-9e2a-5e6f7g8h9i0j",
  "detail-type": "Object Created",
  "source": "aws.s3",
  "account": "123456789012",
  "time": "2025-01-19T10:30:00Z",
  "region": "ap-northeast-1",
  "resources": [
    "arn:aws:s3:::cis-filesearch-s3-landing"
  ],
  "detail": {
    "version": "0",
    "bucket": {
      "name": "cis-filesearch-s3-landing"
    },
    "object": {
      "key": "files/2025/01/document.pdf",
      "size": 1048576,
      "etag": "686897696a7c876b7e",
      "sequencer": "0061E5C3D1234567890"
    },
    "request-id": "1234567890ABCDEF",
    "requester": "123456789012",
    "source-ip-address": "10.0.1.100",
    "reason": "PutObject"
  }
}
```

### 2. EventBridge Event Patternï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰

```json
{
  "source": ["aws.s3"],              // âœ… ãƒžãƒƒãƒ
  "detail-type": ["Object Created"], // âœ… ãƒžãƒƒãƒ
  "detail": {
    "bucket": {
      "name": ["cis-filesearch-s3-landing"] // âœ… ãƒžãƒƒãƒ
    },
    "object": {
      "key": [{
        "prefix": "files/"  // âœ… ãƒžãƒƒãƒï¼ˆfiles/2025/01/document.pdfï¼‰
      }]
    }
  }
}
```

**çµæžœ**: âœ… ã‚¤ãƒ™ãƒ³ãƒˆé€šéŽ â†’ SQSã¸é€ä¿¡

### 3. Input Transformerï¼ˆå¤‰æ›å¾Œï¼‰

**å…ƒã®ã‚¤ãƒ™ãƒ³ãƒˆ**: 5KB
**å¤‰æ›å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: 0.3KB

```json
{
  "eventType": "S3_OBJECT_CREATED",
  "s3Bucket": "cis-filesearch-s3-landing",
  "s3Key": "files/2025/01/document.pdf",
  "fileSize": 1048576,
  "etag": "686897696a7c876b7e",
  "eventTime": "2025-01-19T10:30:00Z",
  "processingRequired": true
}
```

### 4. SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆPython Workerï¼‰

```python
import boto3
import json

sqs = boto3.client('sqs', region_name='ap-northeast-1')
queue_url = 'https://sqs.ap-northeast-1.amazonaws.com/.../cis-filesearch-index-queue'

# Long polling
response = sqs.receive_message(
    QueueUrl=queue_url,
    MaxNumberOfMessages=10,  # ä¸€åº¦ã«10ä»¶å–å¾—
    WaitTimeSeconds=20,      # 20ç§’å¾…æ©Ÿ
    MessageAttributeNames=['All']
)

for message in response.get('Messages', []):
    body = json.loads(message['Body'])

    # ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
    s3_key = body['s3Key']
    bucket = body['s3Bucket']

    # S3ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    file_data = download_from_s3(bucket, s3_key)

    # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
    metadata = extract_metadata(file_data)

    # OpenSearchã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    index_to_opensearch(metadata)

    # RDSã«ä¿å­˜
    save_to_database(metadata)

    # æˆåŠŸã—ãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
    sqs.delete_message(
        QueueUrl=queue_url,
        ReceiptHandle=message['ReceiptHandle']
    )
```

---

## ðŸŽ¯ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®å‹•ä½œä¾‹

### âœ… å‡¦ç†ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

| S3 Key | EventBridge | SQS | ç†ç”± |
|--------|-------------|-----|------|
| `files/2025/01/doc.pdf` | âœ… | âœ… | `files/` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ |
| `files/project/image.jpg` | âœ… | âœ… | `files/` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ |
| `files/a/b/c/deep.txt` | âœ… | âœ… | `files/` ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ |

### âŒ ç„¡è¦–ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

| S3 Key | EventBridge | SQS | ç†ç”± |
|--------|-------------|-----|------|
| `test/debug.txt` | âŒ | âŒ | ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä¸ä¸€è‡´ |
| `temp/cache.dat` | âŒ | âŒ | ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä¸ä¸€è‡´ |
| `backup/old.zip` | âŒ | âŒ | ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä¸ä¸€è‡´ |

---

## â±ï¸ ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ€ã‚¤ã‚¢ã‚°ãƒ©ãƒ 

```
æ™‚é–“è»¸ â†’  0s     1s     2s     3s     4s     5s     ...    300s
          â”‚      â”‚      â”‚      â”‚      â”‚      â”‚             â”‚
S3        â—â”€â”€â”€â”€â”€â”€â”˜
Upload    â”‚
          â”‚
Event     â”€â”€â”€â”€â—â”€â”˜
Bridge    â†‘   â”‚
(é€ä¿¡)    0.5s â”‚
              â”‚
SQS           â”€â”€â”€â—â”˜
(åˆ°ç€)        â†‘  â”‚
          ç´„1s   â”‚
                 â”‚
Worker          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”˜
(å‡¦ç†)          â†‘             â†‘                      â†‘
            ãƒãƒ¼ãƒªãƒ³ã‚°    ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰         å®Œäº†ãƒ»å‰Šé™¤
            (20så¾…æ©Ÿ)    ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º       (285sä»¥å†…)
                        ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹


Visibility              â—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—
Timeout                 â†‘                        â†‘
(ä»–ã®Worker             å—ä¿¡æ™‚                  300så¾Œ
ã‹ã‚‰è¦‹ãˆãªã„)           (5åˆ†é–“ä¸å¯è¦–)            (å†è¡¨ç¤º)
```

---

## ðŸ’¡ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### å¤±æ•—æ™‚ã®ãƒ•ãƒ­ãƒ¼

```
Workerå‡¦ç†å¤±æ•—
     â”‚
     â”‚ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ã›ãš
     â”‚
     â–¼
Visibility Timeoutæº€äº†ï¼ˆ300ç§’å¾Œï¼‰
     â”‚
     â”‚ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå†è¡¨ç¤º
     â”‚
     â–¼
åˆ¥ã®WorkerãŒå†å–å¾—
     â”‚
     â”œâ”€ æˆåŠŸ â†’ å‰Šé™¤
     â”‚
     â””â”€ å¤±æ•— â†’ Retry
            â”‚
            â”œâ”€ 2å›žç›®å¤±æ•—
            â”‚
            â”œâ”€ 3å›žç›®å¤±æ•—
            â”‚
            â””â”€ maxReceiveCount=3åˆ°é”
                   â”‚
                   â–¼
               Dead Letter Queue
               (cis-filesearch-dlq)
                   â”‚
                   â”‚ æ‰‹å‹•èª¿æŸ»ãƒ»å†å‡¦ç†
                   â”‚
                   â””â”€ ä¿®æ­£å¾Œã€ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ã«æˆ»ã™
```

---

## ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  IAMèªè¨¼                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S3 Bucket  â”‚  â”‚ EventBridge â”‚  â”‚  SQS Queue  â”‚
â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
â”‚ Bucket      â”‚  â”‚ Rule: ONLY  â”‚  â”‚ Queue       â”‚
â”‚ Policy:     â”‚  â”‚ allowed to  â”‚  â”‚ Policy:     â”‚
â”‚ - Allow     â”‚  â”‚ invoke SQS  â”‚  â”‚ - Allow     â”‚
â”‚   DataSync  â”‚  â”‚             â”‚  â”‚   EventBridgeâ”‚
â”‚   to PUT    â”‚  â”‚ Source ARN  â”‚  â”‚   to SendMsgâ”‚
â”‚             â”‚  â”‚ verificationâ”‚  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚               â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  EC2 Worker â”‚
                â”‚             â”‚
                â”‚ IAM Role:   â”‚
                â”‚ - S3 Read   â”‚
                â”‚ - SQS Recv  â”‚
                â”‚ - SQS Del   â”‚
                â”‚ - OpenSearchâ”‚
                â”‚ - RDS Write â”‚
                â”‚ - Bedrock   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š ç›£è¦–ãƒã‚¤ãƒ³ãƒˆ

### CloudWatch Metrics

```
EventBridge
  â”œâ”€ Invocations          (ãƒ«ãƒ¼ãƒ«å®Ÿè¡Œå›žæ•°)
  â”œâ”€ MatchedEvents        (ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒžãƒƒãƒæ•°)
  â”œâ”€ FailedInvocations    (SQSé€ä¿¡å¤±æ•—)
  â””â”€ TriggeredRules       (ãƒ«ãƒ¼ãƒ«èµ·å‹•)

SQS
  â”œâ”€ ApproximateNumberOfMessagesVisible      (å¾…æ©Ÿä¸­)
  â”œâ”€ ApproximateNumberOfMessagesNotVisible   (å‡¦ç†ä¸­)
  â”œâ”€ ApproximateAgeOfOldestMessage           (æœ€å¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¹´é½¢)
  â”œâ”€ NumberOfMessagesSent                    (é€ä¿¡æ•°)
  â”œâ”€ NumberOfMessagesReceived                (å—ä¿¡æ•°)
  â””â”€ NumberOfMessagesDeleted                 (å‰Šé™¤æ•°=æˆåŠŸæ•°)

EC2 Auto Scaling
  â”œâ”€ GroupDesiredCapacity  (ç›®æ¨™ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ•°)
  â”œâ”€ GroupInServiceInstances (ç¨¼åƒä¸­)
  â””â”€ GroupPendingInstances   (èµ·å‹•ä¸­)
```

---

## ðŸš¨ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šä¾‹

```yaml
Alarm 1: SQS Backlog
  Metric: ApproximateNumberOfMessagesVisible
  Threshold: > 1000
  Action: Scale Out EC2 Workers

Alarm 2: Old Messages
  Metric: ApproximateAgeOfOldestMessage
  Threshold: > 1800s (30åˆ†)
  Action: SNS Alert to Admin

Alarm 3: EventBridge Failed Invocations
  Metric: FailedInvocations
  Threshold: > 5
  Action: SNS Alert to Admin

Alarm 4: DLQ Has Messages
  Metric: ApproximateNumberOfMessagesVisible (DLQ)
  Threshold: >= 1
  Action: SNS Critical Alert
```

---

## ðŸ“ˆ ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆè¨ˆç®—

### æƒ³å®šãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰

- **1æ—¥ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: 10,000ãƒ•ã‚¡ã‚¤ãƒ«
- **ãƒ”ãƒ¼ã‚¯æ™‚é–“å¸¯**: 9:00-18:00ï¼ˆ9æ™‚é–“ï¼‰
- **ãƒ”ãƒ¼ã‚¯æ™‚ãƒ¬ãƒ¼ãƒˆ**: 10,000 / (9 Ã— 3600) â‰ˆ **0.3ãƒ•ã‚¡ã‚¤ãƒ«/ç§’**

### å¿…è¦ãªWorkeræ•°

- **1ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†æ™‚é–“**: å¹³å‡60ç§’
- **1 Workerã®ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ**: 1 / 60 = **0.017ãƒ•ã‚¡ã‚¤ãƒ«/ç§’**
- **å¿…è¦Workeræ•°**: 0.3 / 0.017 â‰ˆ **18å°**

### Auto Scalingè¨­å®š

```
Min: 0å°  ï¼ˆæ·±å¤œã¯ä¸è¦ï¼‰
Max: 30å° ï¼ˆãƒ”ãƒ¼ã‚¯æ™‚å¯¾å¿œï¼‰
Desired: 20å° ï¼ˆé€šå¸¸æ™‚ï¼‰

Target Tracking:
  - Metric: SQS ApproximateNumberOfMessagesVisible
  - Target: 100ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - Scale Out: > 100ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - Scale In: < 50ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```

---

## ðŸ”„ å®Œå…¨ãªE2Eãƒ•ãƒ­ãƒ¼ä¾‹

### ã‚·ãƒŠãƒªã‚ª: PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

```
00:00.000  DataSyncãŒNASãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
00:00.500  S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
00:02.000  S3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ˆ2ç§’ï¼‰
00:02.100  S3ãŒEventBridgeã«ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
00:02.200  EventBridge Event Patternè©•ä¾¡
00:02.250  âœ… ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒžãƒƒãƒ
00:02.300  Input Transformerå®Ÿè¡Œ
00:02.350  SQSã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
00:02.400  SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸åˆ°ç€

--- Workerå´ ---
00:03.000  Worker Long Pollingä¸­ï¼ˆ20ç§’ï¼‰
00:03.100  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
00:03.200  Visibility Timeouté–‹å§‹ï¼ˆ300ç§’ï¼‰
00:03.500  S3ã‹ã‚‰PDFãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆ5MBã€10ç§’ï¼‰
00:13.500  ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆ20ç§’ï¼‰
00:33.500  OpenSearchã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ5ç§’ï¼‰
00:38.500  RDSã«ä¿å­˜ï¼ˆ2ç§’ï¼‰
00:40.500  ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆï¼ˆ15ç§’ï¼‰
00:55.500  ã‚µãƒ ãƒã‚¤ãƒ«S3ä¿å­˜ï¼ˆ3ç§’ï¼‰
00:58.500  SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
00:58.600  âœ… å‡¦ç†å®Œäº†

Total: ç´„56ç§’
```

---

**ä½œæˆæ—¥**: 2025-01-19
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
**ç”¨é€”**: AWS Event-Driven Architectureã®ç†è§£ä¿ƒé€²
