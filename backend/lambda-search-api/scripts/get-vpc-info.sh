#!/bin/bash

###############################################################################
# VPCæƒ…å ±å–å¾—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# Terraformãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦ãªVPCé–¢é€£æƒ…å ±ã‚’è‡ªå‹•å–å¾—
###############################################################################

set -e

REGION="${AWS_REGION:-ap-northeast-1}"

echo "=========================================="
echo "VPCæƒ…å ±ã‚’å–å¾—ä¸­..."
echo "Region: $REGION"
echo "=========================================="
echo ""

# VPC IDã‚’å–å¾—
echo "ğŸ“Œ VPCä¸€è¦§:"
aws ec2 describe-vpcs --region "$REGION" \
  --query 'Vpcs[].[VpcId,Tags[?Key==`Name`].Value|[0],CidrBlock]' \
  --output table

echo ""
read -p "ä½¿ç”¨ã™ã‚‹VPC IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: " VPC_ID

# ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã‚’å–å¾—
echo ""
echo "ğŸ“Œ ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆä¸€è¦§ (VPC: $VPC_ID):"
aws ec2 describe-subnets --region "$REGION" \
  --filters "Name=vpc-id,Values=$VPC_ID" \
  --query 'Subnets[?MapPublicIpOnLaunch==`false`].[SubnetId,AvailabilityZone,CidrBlock,Tags[?Key==`Name`].Value|[0]]' \
  --output table

echo ""
echo "æœ€ä½2ã¤ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆç•°ãªã‚‹AZï¼‰"
read -p "1ã¤ç›®ã®ã‚µãƒ–ãƒãƒƒãƒˆID: " SUBNET_1
read -p "2ã¤ç›®ã®ã‚µãƒ–ãƒãƒƒãƒˆID: " SUBNET_2

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å–å¾—
echo ""
echo "ğŸ“Œ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§ (VPC: $VPC_ID):"
aws ec2 describe-security-groups --region "$REGION" \
  --filters "Name=vpc-id,Values=$VPC_ID" \
  --query 'SecurityGroups[].[GroupId,GroupName,Description]' \
  --output table

echo ""
read -p "OpenSearchã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ID: " OPENSEARCH_SG_ID

# Cognitoãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ã‚’å–å¾—
echo ""
echo "ğŸ“Œ Cognito User Poolä¸€è¦§:"
aws cognito-idp list-user-pools --region "$REGION" --max-results 20 \
  --query 'UserPools[].[Id,Name]' \
  --output table

echo ""
read -p "ä½¿ç”¨ã™ã‚‹User Pool ID: " COGNITO_POOL_ID

# User Pool ARNã‚’å–å¾—
COGNITO_ARN=$(aws cognito-idp describe-user-pool --region "$REGION" \
  --user-pool-id "$COGNITO_POOL_ID" \
  --query 'UserPool.Arn' \
  --output text)

# OpenSearchãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—
echo ""
echo "ğŸ“Œ OpenSearchãƒ‰ãƒ¡ã‚¤ãƒ³ä¸€è¦§:"
aws opensearch list-domain-names --region "$REGION" \
  --query 'DomainNames[].[DomainName]' \
  --output table

echo ""
read -p "ä½¿ç”¨ã™ã‚‹OpenSearchãƒ‰ãƒ¡ã‚¤ãƒ³å: " OPENSEARCH_DOMAIN

OPENSEARCH_ENDPOINT=$(aws opensearch describe-domain --region "$REGION" \
  --domain-name "$OPENSEARCH_DOMAIN" \
  --query 'DomainStatus.Endpoint' \
  --output text)

# VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å ´åˆ
if [[ $OPENSEARCH_ENDPOINT == "" ]]; then
  OPENSEARCH_ENDPOINT=$(aws opensearch describe-domain --region "$REGION" \
    --domain-name "$OPENSEARCH_DOMAIN" \
    --query 'DomainStatus.Endpoints.vpc' \
    --output text)
fi

# HTTPSãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
OPENSEARCH_ENDPOINT="https://$OPENSEARCH_ENDPOINT"

# terraform.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
echo ""
echo "=========================================="
echo "terraform.tfvars ã‚’ç”Ÿæˆä¸­..."
echo "=========================================="

cat > ../terraform/terraform.tfvars <<EOF
# Terraform Variables for Lambda Search API
# Auto-generated by get-vpc-info.sh

# AWS Configuration
aws_region  = "$REGION"
environment = "prod"

# OpenSearch Configuration
opensearch_domain_endpoint = "$OPENSEARCH_ENDPOINT"
opensearch_index_name      = "file-index"

# Cognito Configuration
cognito_user_pool_id  = "$COGNITO_POOL_ID"
cognito_user_pool_arn = "$COGNITO_ARN"

# VPC Configuration
vpc_id                       = "$VPC_ID"
private_subnet_ids           = ["$SUBNET_1", "$SUBNET_2"]
opensearch_security_group_id = "$OPENSEARCH_SG_ID"
EOF

echo ""
echo "âœ… terraform.tfvars ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
echo ""
cat ../terraform/terraform.tfvars

echo ""
echo "=========================================="
echo "ğŸ‰ å®Œäº†ï¼"
echo "=========================================="
echo ""
echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "1. cd ../terraform"
echo "2. terraform init"
echo "3. terraform plan"
echo "4. terraform apply"
echo ""
