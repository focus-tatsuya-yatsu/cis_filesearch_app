# ===================================================================
# CIS File Processor Worker - OPTIMIZED CONFIGURATION
# Target: 500-1000 messages/minute on t3.medium (2vCPU, 4GB RAM)
# ===================================================================

# AWS Configuration
AWS_REGION=ap-northeast-1
# ✅ SECURITY: DO NOT set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY
# On EC2, use IAM Instance Role instead of hardcoded credentials

# S3 Buckets
S3_LANDING_BUCKET=cis-landing-bucket
S3_THUMBNAIL_BUCKET=cis-thumbnail-bucket

# ===================================================================
# ✅ OPTIMIZATION 1: SQS Settings
# ===================================================================
SQS_QUEUE_URL=https://sqs.ap-northeast-1.amazonaws.com/YOUR_ACCOUNT_ID/cis-file-processing-queue

# VisibilityTimeout: 処理時間に応じて調整
# - 短縮: 120秒（以前は300秒）
# - 理由: 平均処理時間が短い場合、長すぎるとメッセージの再試行が遅れる
# - 処理時間が長い場合は 180-240 に調整
SQS_VISIBILITY_TIMEOUT=120

# MaxMessages: SQS から一度に取得するメッセージ数
# - 最大値の 10 を維持（これ以上は増やせない）
SQS_MAX_MESSAGES=10

# ✅ NEW: 並列受信リクエスト数
# - 3リクエスト並列実行 = 最大30メッセージ同時取得
# - メモリに余裕がある場合は 5 まで増やせる（最大50メッセージ）
SQS_PARALLEL_FETCH=3

# ===================================================================
# ✅ OPTIMIZATION 2: Worker Settings
# ===================================================================
# スレッド数: t3.medium での最適値
# - 2vCPU の場合: 8-12 スレッド推奨（I/O bound処理のためCPU数 x 4-6）
# - メモリ制限: 4GB / 300MB per thread ≈ 13 スレッド可能
# - 推奨: 10 スレッド（安全マージン）
WORKER_THREADS=10

# バッチサイズ: 一度に処理するメッセージ数
# - 並列受信で最大30メッセージ取得するため、それに合わせる
WORKER_BATCH_SIZE=30

# ポーリング間隔: メッセージがない場合の待機時間
# - 1秒に短縮（メッセージがある限り即座に次の処理へ）
# - キューが空の場合は自動的に Long Polling (20秒) になる
WORKER_POLL_INTERVAL=1

# スレッド数の自動調整を有効化
# - システムリソースに応じて動的に調整
WORKER_AUTO_SCALE=true

# ===================================================================
# ✅ OPTIMIZATION 3: Performance Monitoring
# ===================================================================
# 目標処理速度（メッセージ/分）
TARGET_MSG_PER_MIN=500

# 統計ログ出力間隔（秒）
STATS_LOG_INTERVAL=30

# メモリ使用量チェック間隔（秒）
MEMORY_CHECK_INTERVAL=60

# メモリ使用率警告閾値（%）
MEMORY_WARNING_THRESHOLD=80

# 処理タイムアウトの動的調整を有効化
DYNAMIC_TIMEOUT=true

# バッチ処理の最大待機時間（秒）
MAX_BATCH_WAIT_TIME=2

# ===================================================================
# OpenSearch Settings
# ===================================================================
OPENSEARCH_ENDPOINT=https://your-domain.ap-northeast-1.es.amazonaws.com
OPENSEARCH_INDEX_NAME=cis-files
OPENSEARCH_USERNAME=admin
OPENSEARCH_PASSWORD=your_password_here
OPENSEARCH_USE_AWS_AUTH=true

# ===================================================================
# Bedrock Settings
# ===================================================================
BEDROCK_MODEL_ID=amazon.titan-embed-image-v1

# ===================================================================
# ✅ OPTIMIZATION 4: Feature Flags - Disable heavy features for speed
# ===================================================================
# OCR: テキスト抽出（重い処理）
# - 速度優先の場合: false に設定
# - 精度優先の場合: true を維持
ENABLE_OCR=false

# Thumbnail: サムネイル生成（中程度の処理）
# - 速度優先の場合: false に設定
# - UI/UX優先の場合: true を維持
ENABLE_THUMBNAIL=false

# Vector Search: ベクトル埋め込み生成（非常に重い処理）
# - 速度優先の場合: false に設定
# - AI検索機能が必要な場合: true を維持
ENABLE_VECTOR_SEARCH=false

# ===================================================================
# ✅ SPEED vs QUALITY Trade-off Guide:
# ===================================================================
# 【最速設定】 約800-1000 msg/min
# ENABLE_OCR=false
# ENABLE_THUMBNAIL=false
# ENABLE_VECTOR_SEARCH=false
# WORKER_THREADS=12
#
# 【バランス設定】 約400-600 msg/min
# ENABLE_OCR=false
# ENABLE_THUMBNAIL=true
# ENABLE_VECTOR_SEARCH=false
# WORKER_THREADS=10
#
# 【フル機能設定】 約150-250 msg/min
# ENABLE_OCR=true
# ENABLE_THUMBNAIL=true
# ENABLE_VECTOR_SEARCH=true
# WORKER_THREADS=8

# ===================================================================
# Logging Settings
# ===================================================================
# ログレベル: パフォーマンス重視の場合は WARNING に設定
# - DEBUG: 最も詳細（遅い）
# - INFO: 標準（推奨）
# - WARNING: 警告以上のみ（速い）
LOG_LEVEL=INFO
LOG_FILE=/var/log/cis-worker/worker.log

# ===================================================================
# Tesseract OCR Settings
# ===================================================================
TESSERACT_LANG=jpn+eng
OCR_TIMEOUT=60

# ===================================================================
# Thumbnail Settings
# ===================================================================
THUMBNAIL_MAX_WIDTH=300
THUMBNAIL_MAX_HEIGHT=300
THUMBNAIL_QUALITY=85

# ===================================================================
# CloudWatch Settings
# ===================================================================
CLOUDWATCH_LOG_GROUP=/aws/ec2/cis-file-processor
CLOUDWATCH_LOG_STREAM=worker-optimized

# ===================================================================
# ✅ OPTIMIZATION NOTES:
# ===================================================================
# 1. 処理速度の測定方法:
#    - ログに30秒ごとに「📊 PERFORMANCE STATISTICS」が出力される
#    - 「🚀 Speed: XXX msg/min」を確認
#
# 2. メモリ不足でクラッシュする場合:
#    - WORKER_THREADS を 8 に減らす
#    - ENABLE_OCR=false に設定
#    - SQS_PARALLEL_FETCH を 2 に減らす
#
# 3. CPU使用率が低い場合:
#    - WORKER_THREADS を 12-15 に増やす
#    - SQS_PARALLEL_FETCH を 4-5 に増やす
#
# 4. 再起動が頻繁に発生する場合:
#    - systemd の RestartSec=5s を確認
#    - メモリ不足の可能性があるため WORKER_THREADS を減らす
#
# 5. 処理速度が目標に達しない場合:
#    - Feature Flags をすべて false に設定（最速モード）
#    - WORKER_THREADS を段階的に増やす（10 → 12 → 15）
#    - インスタンスタイプを t3.large にアップグレード検討
# ===================================================================
