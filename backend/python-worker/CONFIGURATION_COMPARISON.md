# 設定値比較表 - t3.medium 最適化

## 概要

t3.medium (2vCPU, 4GB RAM) で最大パフォーマンスを引き出すための設定値の比較。

## 環境変数設定値

### SQS設定（最重要）

| 変数名 | デフォルト | 最適化後 | 影響 | 重要度 |
|--------|-----------|---------|------|--------|
| `SQS_MAX_MESSAGES` | **1** | **10** | **処理速度10倍** | ⭐⭐⭐⭐⭐ |
| `SQS_WAIT_TIME` | 20 | 20 | ロングポーリング維持 | ⭐⭐⭐ |
| `SQS_VISIBILITY_TIMEOUT` | 300 | 300 | 処理時間に余裕 | ⭐⭐⭐ |

**説明**:
- `SQS_MAX_MESSAGES=1`: 1メッセージずつ処理 → 122 msg/分
- `SQS_MAX_MESSAGES=10`: 10メッセージずつバッチ処理 → **200-250 msg/分**

### ワーカー設定

| 変数名 | デフォルト | 最適化後 | 理由 | 重要度 |
|--------|-----------|---------|------|--------|
| `MAX_WORKERS` | **4** | **1** | 2vCPUではワーカー1つが最適 | ⭐⭐⭐⭐⭐ |

**説明**:
- t3.medium (2vCPU) では、`MAX_WORKERS=1` が最適
- ワーカーが多すぎるとCPU競合でかえって遅くなる
- 計算式: `最適ワーカー数 = vCPU数 - 1`（メインプロセス分を引く）

### 処理タイムアウト

| 変数名 | デフォルト | 最適化後 | 理由 | 重要度 |
|--------|-----------|---------|------|--------|
| `PROCESSING_TIMEOUT` | 300秒 | **180秒** | ハングアップファイルの影響を最小化 | ⭐⭐⭐⭐ |
| `OCR_TIMEOUT` | 180秒 | **120秒** | OCR処理のタイムアウトを短縮 | ⭐⭐⭐ |

**説明**:
- タイムアウトを短縮することで、処理できないファイルで詰まる時間を削減
- DLQに早めに送ることで、全体の処理速度を向上

### ファイルサイズ制限

| 変数名 | デフォルト | 最適化後 | 理由 | 重要度 |
|--------|-----------|---------|------|--------|
| `MAX_FILE_SIZE_MB` | 100 | **50** | メモリ不足防止 | ⭐⭐⭐⭐ |
| `MAX_IMAGE_SIZE_MB` | 50 | **30** | メモリ使用量削減 | ⭐⭐⭐ |
| `MAX_OFFICE_SIZE_MB` | 100 | **50** | メモリ不足防止 | ⭐⭐⭐ |
| `MAX_PDF_SIZE_MB` | 100 | **50** | メモリ不足防止 | ⭐⭐⭐⭐ |

**説明**:
- t3.medium (4GB RAM) では大きなファイル処理でOOM（メモリ不足）になる可能性
- ファイルサイズ制限を下げることで安定性を向上

### OCR設定

| 変数名 | デフォルト | 最適化後 | 理由 | 重要度 |
|--------|-----------|---------|------|--------|
| `PDF_DPI` | 300 | **200** | CPU・メモリ使用量削減 | ⭐⭐⭐⭐ |
| `IMAGE_PREPROCESSING` | true | **false** | CPU使用量削減 | ⭐⭐⭐ |
| `MAX_PDF_PAGES` | 1000 | **500** | 処理時間・メモリ削減 | ⭐⭐⭐ |

**説明**:
- DPI 300→200: 精度はやや下がるが、処理時間が約30%短縮
- 前処理無効化: CPU使用量を削減、処理時間を短縮
- ページ数制限: 巨大PDFでの詰まりを防止

### サムネイル設定

| 変数名 | デフォルト | 最適化後 | 理由 | 重要度 |
|--------|-----------|---------|------|--------|
| `THUMBNAIL_WIDTH` | 200 | **150** | 処理時間削減 | ⭐⭐ |
| `THUMBNAIL_HEIGHT` | 200 | **150** | 処理時間削減 | ⭐⭐ |
| `THUMBNAIL_QUALITY` | 85 | **75** | ファイルサイズ削減 | ⭐⭐ |
| `THUMBNAIL_PDFS` | true | **false** | CPU削減（PDFサムネイルは重い） | ⭐⭐⭐ |
| `THUMBNAIL_OFFICE` | true | **false** | CPU削減（Officeサムネイルは重い） | ⭐⭐⭐ |

**説明**:
- サムネイル生成は意外とCPU・メモリを消費
- 画像のみサムネイル生成、PDF・Officeは無効化

### リトライ設定

| 変数名 | デフォルト | 最適化後 | 理由 | 重要度 |
|--------|-----------|---------|------|--------|
| `MAX_RETRIES` | 3 | **2** | 失敗時の無駄な再試行を削減 | ⭐⭐⭐ |
| `RETRY_DELAY` | 5秒 | **3秒** | リトライ間隔を短縮 | ⭐⭐ |

**説明**:
- 処理できないファイルは早めにDLQに送る
- 無駄な再試行を減らして全体の処理速度を向上

### ログ設定

| 変数名 | デフォルト | 最適化後 | 理由 | 重要度 |
|--------|-----------|---------|------|--------|
| `LOG_LEVEL` | INFO | **WARNING** | ログ出力によるオーバーヘッド削減 | ⭐⭐⭐⭐ |

**説明**:
- INFO レベルでは大量のログが出力され、I/Oオーバーヘッドが発生
- WARNING に変更することで、必要なエラーログのみ出力

## systemd設定値

### 再起動ポリシー

| 設定項目 | デフォルト | 最適化後 | 理由 | 重要度 |
|---------|-----------|---------|------|--------|
| `Restart` | always | **on-failure** | 失敗時のみ再起動 | ⭐⭐⭐⭐ |
| `RestartSec` | 10秒 | **30秒** | 再起動ループを防ぐ | ⭐⭐⭐⭐⭐ |
| `StartLimitInterval` | 0（無制限） | **300秒** | 5分間の制限 | ⭐⭐⭐⭐⭐ |
| `StartLimitBurst` | なし | **5** | 5回まで再起動許可 | ⭐⭐⭐⭐⭐ |
| `StartLimitAction` | なし | **none** | 制限到達時は停止 | ⭐⭐⭐⭐ |

**説明**:
- `RestartSec=30`: 再起動間隔を延長することで、一時的なエラーによる再起動ループを防ぐ
- `StartLimitBurst=5`: 5分間に5回再起動したら停止（無限ループを防ぐ）

### リソース制限

| 設定項目 | デフォルト | 最適化後 | 理由 | 重要度 |
|---------|-----------|---------|------|--------|
| `LimitNOFILE` | 1024 | **65536** | ファイルディスクリプタ数 | ⭐⭐⭐ |
| `LimitNPROC` | 4096 | **2048** | プロセス数制限（2vCPU向け） | ⭐⭐⭐ |
| `MemoryMax` | なし | **3G** | メモリ上限（OOM防止） | ⭐⭐⭐⭐⭐ |
| `CPUQuota` | なし | **150%** | CPU使用率上限（1.5コア相当） | ⭐⭐⭐⭐ |

**説明**:
- `MemoryMax=3G`: 4GBのうち3GBまで使用可能（システム分を確保）
- `CPUQuota=150%`: 2vCPUのうち1.5コア相当（MAX_WORKERS=1に最適）

### タイムアウト設定

| 設定項目 | デフォルト | 最適化後 | 理由 | 重要度 |
|---------|-----------|---------|------|--------|
| `TimeoutStartSec` | なし | **60秒** | 起動タイムアウト | ⭐⭐⭐ |
| `TimeoutStopSec` | なし | **60秒** | 停止タイムアウト | ⭐⭐⭐ |

### セキュリティ設定

| 設定項目 | 値 | 説明 | 重要度 |
|---------|---|------|--------|
| `NoNewPrivileges` | true | 新しい権限を取得不可 | ⭐⭐⭐ |
| `PrivateTmp` | true | 専用の/tmpを使用 | ⭐⭐⭐ |
| `ProtectSystem` | strict | システムファイルを保護 | ⭐⭐⭐⭐ |
| `ReadWritePaths` | /tmp /var/log | 書き込み可能なパス | ⭐⭐⭐⭐ |
| `OOMScoreAdjust` | -100 | OOMで優先的にkillされない | ⭐⭐⭐⭐⭐ |

**説明**:
- `OOMScoreAdjust=-100`: メモリ不足時に他のプロセスより優先度を上げる

## 実行コマンド設定

### Python実行パス

| 項目 | デフォルト | 最適化後 | 理由 | 重要度 |
|-----|-----------|---------|------|--------|
| `ExecStart` | `/usr/bin/python3.11` | **/home/ec2-user/python-worker/venv/bin/python3** | pip依存関係エラーを回避 | ⭐⭐⭐⭐⭐ |

**説明**:
- システムのPythonではなく、venv内のPythonを使用
- これにより、pip依存関係エラーによる再起動ループを完全に回避

### 環境変数

| 変数名 | 値 | 説明 | 重要度 |
|--------|---|------|--------|
| `PYTHONUNBUFFERED` | 1 | 出力バッファリングを無効化 | ⭐⭐⭐ |
| `PATH` | venv/bin を最優先 | venv内のツールを使用 | ⭐⭐⭐⭐ |

## 設定値のインパクト分析

### 処理速度への影響（大きい順）

1. **SQS_MAX_MESSAGES: 1→10** ⭐⭐⭐⭐⭐
   - 影響: **処理速度10倍**
   - 理由: バッチ処理により、SQSポーリングのオーバーヘッドを削減

2. **MAX_WORKERS: 4→1** ⭐⭐⭐⭐⭐
   - 影響: **CPU競合を排除、約1.5倍**
   - 理由: 2vCPUでは1ワーカーが最適、コンテキストスイッチのオーバーヘッドを削減

3. **LOG_LEVEL: INFO→WARNING** ⭐⭐⭐⭐
   - 影響: **約5-10%の性能向上**
   - 理由: ログ出力のI/Oオーバーヘッドを削減

4. **PDF_DPI: 300→200** ⭐⭐⭐⭐
   - 影響: **OCR処理時間30%短縮**
   - 理由: DPI低下により処理ピクセル数が減少

5. **IMAGE_PREPROCESSING: true→false** ⭐⭐⭐
   - 影響: **画像処理時間20%短縮**
   - 理由: 前処理ステップを省略

### 安定性への影響（大きい順）

1. **RestartSec: 10→30秒** ⭐⭐⭐⭐⭐
   - 影響: **再起動ループを防止**
   - 理由: 段階的バックオフにより、一時的なエラーでの再起動を抑制

2. **MemoryMax: なし→3G** ⭐⭐⭐⭐⭐
   - 影響: **OOMによるクラッシュを防止**
   - 理由: メモリ上限を明示的に設定

3. **MAX_FILE_SIZE_MB: 100→50** ⭐⭐⭐⭐
   - 影響: **メモリ不足を防止**
   - 理由: 大きなファイルでのメモリ不足を回避

4. **ExecStart: system python→venv python** ⭐⭐⭐⭐⭐
   - 影響: **pip依存関係エラーを完全に回避**
   - 理由: 専用の仮想環境を使用

5. **StartLimitBurst: なし→5** ⭐⭐⭐⭐⭐
   - 影響: **無限再起動ループを防止**
   - 理由: 5分間に5回再起動したら停止

### DLQ増加への影響（大きい順）

1. **PROCESSING_TIMEOUT: 300→180秒** ⭐⭐⭐⭐
   - 影響: **処理できないファイルを早めにDLQに送る**
   - 理由: タイムアウトを短縮

2. **MAX_RETRIES: 3→2** ⭐⭐⭐
   - 影響: **無駄な再試行を削減**
   - 理由: 失敗が確実なファイルは早めにDLQに送る

3. **MAX_FILE_SIZE_MB: 100→50** ⭐⭐⭐⭐
   - 影響: **処理不可能な大ファイルを事前に除外**
   - 理由: 処理できないファイルでDLQを埋めない

## インスタンスタイプ別推奨設定

### t3.medium (2vCPU, 4GB RAM) ← 現在

```bash
SQS_MAX_MESSAGES=10
MAX_WORKERS=1
MAX_FILE_SIZE_MB=50
PDF_DPI=200
MemoryMax=3G
CPUQuota=150%
```

**期待速度**: 200-250 msg/分

### t3.large (2vCPU, 8GB RAM)

```bash
SQS_MAX_MESSAGES=10
MAX_WORKERS=1
MAX_FILE_SIZE_MB=100
PDF_DPI=300
MemoryMax=6G
CPUQuota=150%
```

**期待速度**: 250-300 msg/分

### c5.xlarge (4vCPU, 8GB RAM)

```bash
SQS_MAX_MESSAGES=10
MAX_WORKERS=3
MAX_FILE_SIZE_MB=100
PDF_DPI=300
MemoryMax=7G
CPUQuota=300%
```

**期待速度**: 400-500 msg/分

### c5.2xlarge (8vCPU, 16GB RAM)

```bash
SQS_MAX_MESSAGES=10
MAX_WORKERS=7
MAX_FILE_SIZE_MB=150
PDF_DPI=300
MemoryMax=14G
CPUQuota=700%
```

**期待速度**: 800-1000 msg/分

## まとめ

### 最も重要な設定（Top 5）

1. **SQS_MAX_MESSAGES=10** - 処理速度10倍
2. **MAX_WORKERS=1** - CPU最適化
3. **RestartSec=30** - 再起動ループ防止
4. **MemoryMax=3G** - OOM防止
5. **ExecStart=venv/bin/python3** - pip依存関係エラー回避

### 期待される効果（t3.medium）

- **処理速度**: 122 → 200-250 msg/分（1.6〜2倍）
- **完了時間**: 35時間 → 17-21時間（約半分）
- **安定性**: 再起動ループを解消
- **DLQ**: 増加を抑制

### 次のステップ

1. **緊急修正スクリプト実行**（5分）
2. **30分後に効果確認**（monitor-performance.sh実行）
3. **不十分な場合は、インスタンスタイプ変更またはスケールアウトを検討**
