# SQS Worker - ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚°ãƒ¬ãƒ¼ãƒ‰ ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¬ã‚¤ãƒ‰

**ä½œæˆæ—¥**: 2025-12-15
**å¯¾è±¡ç’°å¢ƒ**: EC2 t3.medium, Python 3.11, SQS/OpenSearch
**ç›®çš„**: æœ¬ç•ªç’°å¢ƒã®å®‰å®šæ€§ã‚’åŠ‡çš„ã«å‘ä¸Šã•ã›ã‚‹

---

## ğŸ“‹ ç›®æ¬¡

1. [ç¾çŠ¶ã®å•é¡Œç‚¹](#ç¾çŠ¶ã®å•é¡Œç‚¹)
2. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„ã®5ã¤ã®æŸ±](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„ã®5ã¤ã®æŸ±)
3. [ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †](#ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †)
4. [æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ](#æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ)
5. [ç›£è¦–ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ç›£è¦–ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
6. [ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †](#ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †)

---

## ğŸ”´ ç¾çŠ¶ã®å•é¡Œç‚¹

### ç—‡çŠ¶

- **å†èµ·å‹•ãƒ«ãƒ¼ãƒ—**: exit status 1ã§30ç§’ã”ã¨ã«å†èµ·å‹•
- **å‡¦ç†é€Ÿåº¦ä½ä¸‹**: 122 msg/åˆ†ï¼ˆæœŸå¾…å€¤500 msg/åˆ†ã®25%ï¼‰
- **DLQå±æ©Ÿ**: 7,959ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè“„ç©ä¸­
- **ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼**: pipä¾å­˜é–¢ä¿‚ã®æ¬ è½
- **ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒªã‚¹ã‚¯**: ä¸­æ–­æ™‚ã®å¾©æ—§ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ä¸åœ¨

### æ ¹æœ¬åŸå› 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å•é¡Œã®ã‚ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. Systemd: Restart=always (ç„¡é™å†èµ·å‹•)                â”‚
â”‚  2. äº‹å‰æ¤œè¨¼ãªã— â†’ èµ·å‹•å¾Œã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥                      â”‚
â”‚  3. DLQæ»ç•™ â†’ æ‰‹å‹•å¯¾å¿œãŒå¿…è¦                             â”‚
â”‚  4. ã‚¹ãƒãƒƒãƒˆä¸­æ–­ â†’ ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹                             â”‚
â”‚  5. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãªã— â†’ å•é¡Œæ¤œçŸ¥é…å»¶                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„ã®5ã¤ã®æŸ±

### 1ï¸âƒ£ ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³

**Before:**
```ini
[Service]
Restart=always           # å•é¡Œ: ç„¡é™ã«å†èµ·å‹•
StartLimitInterval=0     # å•é¡Œ: åˆ¶é™ãªã—
```

**After:**
```ini
[Service]
ExecStartPre=/usr/bin/python3.11 /path/to/health_check.py  # äº‹å‰æ¤œè¨¼
Restart=on-failure       # å¤±æ•—æ™‚ã®ã¿å†èµ·å‹•
StartLimitBurst=5        # æœ€å¤§5å›ã¾ã§
StartLimitIntervalSec=300  # 5åˆ†é–“ã§5å›ã¾ã§
```

**åŠ¹æœ:**
- âœ… ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼ˆ5å›å¤±æ•—ã§åœæ­¢ï¼‰
- âœ… èµ·å‹•å‰ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆFail Fastï¼‰
- âœ… ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ä¿è­·

---

### 2ï¸âƒ£ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªã‚«ãƒãƒªãƒ¼æˆ¦ç•¥

**ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«** (`health_check.py`)

```python
ãƒã‚§ãƒƒã‚¯é …ç›®:
âœ“ Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
âœ“ ç’°å¢ƒå¤‰æ•°ã®è¨­å®šç¢ºèª
âœ“ AWSèªè¨¼æƒ…å ±ã®æœ‰åŠ¹æ€§
âœ“ SQSã‚­ãƒ¥ãƒ¼ã¸ã®æ¥ç¶šæ€§
âœ“ S3ãƒã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
âœ“ OpenSearchæ¥ç¶šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
âœ“ ãƒ‡ã‚£ã‚¹ã‚¯ç©ºãå®¹é‡ï¼ˆæœ€ä½10GBï¼‰
âœ“ ãƒ¡ãƒ¢ãƒªä½¿ç”¨å¯èƒ½é‡ï¼ˆæœ€ä½2GBï¼‰
```

**ä½¿ç”¨æ–¹æ³•:**
```bash
# æ‰‹å‹•å®Ÿè¡Œ
sudo python3.11 /home/ec2-user/python-worker/health_check.py

# systemdã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè¡Œï¼ˆExecStartPreï¼‰
# ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å‰ã«è‡ªå‹•ãƒã‚§ãƒƒã‚¯
```

**Exit Code:**
- `0`: å…¨ãƒã‚§ãƒƒã‚¯åˆæ ¼ â†’ ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
- `1`: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«å¤±æ•— â†’ ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã‚’ä¸­æ­¢
- `2`: è­¦å‘Šã‚ã‚Š â†’ èµ·å‹•ã™ã‚‹ãŒæ©Ÿèƒ½åˆ¶é™ã‚ã‚Š

---

### 3ï¸âƒ£ DLQãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è‡ªå‹•å†å‡¦ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**DLQ Reprocessor** (`dlq_reprocessor.py`)

**æ©Ÿèƒ½:**
1. **å¤±æ•—åˆ†é¡**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‡ªå‹•åˆ†é¡
   - `RECOVERABLE_NETWORK`: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€æ¥ç¶šã‚¨ãƒ©ãƒ¼ â†’ å†è©¦è¡Œ
   - `RECOVERABLE_RESOURCE`: ãƒ¡ãƒ¢ãƒªä¸è¶³ã€ãƒ‡ã‚£ã‚¹ã‚¯æº€æ¯ â†’ å†è©¦è¡Œ
   - `RECOVERABLE_OPENSEARCH`: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼ â†’ å†è©¦è¡Œ
   - `UNRECOVERABLE_FORMAT`: ã‚µãƒãƒ¼ãƒˆå¤–ãƒ•ã‚¡ã‚¤ãƒ« â†’ S3ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
   - `UNRECOVERABLE_NOTFOUND`: ãƒ•ã‚¡ã‚¤ãƒ«ä¸åœ¨ â†’ S3ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
   - `UNRECOVERABLE_PERMISSION`: æ¨©é™ã‚¨ãƒ©ãƒ¼ â†’ S3ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

2. **è‡ªå‹•å†è©¦è¡Œ**: å›å¾©å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ã‚’è‡ªå‹•çš„ã«ãƒ¡ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ã¸æˆ»ã™
3. **ã‚¨ã‚¯ã‚¹ãƒãƒãƒ³ã‚·ãƒ£ãƒ«ãƒãƒƒã‚¯ã‚ªãƒ•**: å†è©¦è¡Œé–“éš”ã‚’æ®µéšçš„ã«å»¶é•·
4. **æ°¸ä¹…å¤±æ•—ã®ä¿å­˜**: å›å¾©ä¸å¯èƒ½ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’S3ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

**ä½¿ç”¨æ–¹æ³•:**
```bash
# æ‰‹å‹•å®Ÿè¡Œï¼ˆãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼‰
python3.11 dlq_reprocessor.py --dry-run

# æ‰‹å‹•å®Ÿè¡Œï¼ˆæœ€å¤§1000ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
python3.11 dlq_reprocessor.py --max-messages 1000

# å¤±æ•—åˆ†æã®ã¿
python3.11 dlq_reprocessor.py --analyze-only

# è‡ªå‹•å®Ÿè¡Œï¼ˆcron: 15åˆ†ã”ã¨ï¼‰
*/15 * * * * /usr/bin/python3.11 /home/ec2-user/python-worker/dlq_reprocessor.py --auto
```

**æœŸå¾…åŠ¹æœ:**
- DLQ 7,959ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ 24æ™‚é–“ä»¥å†…ã«æ­£å¸¸åŒ–
- å›å¾©å¯èƒ½ã‚¨ãƒ©ãƒ¼ï¼ˆæ¨å®š60%ï¼‰â†’ è‡ªå‹•å†å‡¦ç†
- å›å¾©ä¸å¯èƒ½ã‚¨ãƒ©ãƒ¼ï¼ˆæ¨å®š40%ï¼‰â†’ S3ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã§èª¿æŸ»å¯èƒ½

---

### 4ï¸âƒ£ ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸­æ–­å¯¾ç­–

**Spot Interruption Handler** (`spot_interruption_handler.py`)

**AWSå‹•ä½œ:**
```
ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¸­æ–­é€šçŸ¥
          â†“
   â° 2åˆ†é–“ã®çŒ¶äºˆ
          â†“
    ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çµ‚äº†
```

**ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‹•ä½œ:**
```
IMDSv2ã‹ã‚‰ä¸­æ–­é€šçŸ¥ã‚’5ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
          â†“
    ä¸­æ–­æ¤œçŸ¥ï¼ˆ2åˆ†å‰ï¼‰
          â†“
 Workerã‚µãƒ¼ãƒ“ã‚¹ã« SIGTERM é€ä¿¡
          â†“
 ç¾åœ¨å‡¦ç†ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®Œäº†ã‚’å¾…ã¤ï¼ˆæœ€å¤§60ç§’ï¼‰
          â†“
   Graceful Shutdownå®Œäº†
          â†“
  CloudWatchãƒ¡ãƒˆãƒªã‚¯ã‚¹é€ä¿¡
```

**ä½¿ç”¨æ–¹æ³•:**
```bash
# Systemdã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦è‡ªå‹•èµ·å‹•
sudo systemctl enable spot-interruption-handler.service
sudo systemctl start spot-interruption-handler.service

# æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼ˆãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
sudo python3.11 spot_interruption_handler.py --foreground
```

**ä¿è¨¼:**
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹ãªã—ï¼ˆå‡¦ç†ä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å®Œäº†ï¼‰
- âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é‡è¤‡å‡¦ç†ãªã—ï¼ˆVisibility Timeoutæ´»ç”¨ï¼‰
- âœ… CloudWatché€šçŸ¥ï¼ˆé‹ç”¨ãƒãƒ¼ãƒ ã¸ã‚¢ãƒ©ãƒ¼ãƒˆï¼‰

---

### 5ï¸âƒ£ è‡ªå‹•å¾©æ—§ã‚·ã‚¹ãƒ†ãƒ 

**Auto Recovery System** (`auto_recovery.py`)

**ç›£è¦–é …ç›®ï¼ˆ60ç§’ã”ã¨ï¼‰:**

| é …ç›® | é–¾å€¤ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|------|------|-----------|
| ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ | active ã§ãªã„ | å³åº§ã«å†èµ·å‹• |
| ãƒ—ãƒ­ã‚»ã‚¹å­˜åœ¨ | ãƒ—ãƒ­ã‚»ã‚¹ãªã— | å†èµ·å‹• |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | >5GB | ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œçŸ¥â†’å†èµ·å‹• |
| SQSå‡¦ç†é€²æ— | 10åˆ†é–“é€²æ—ãªã— | ã‚¹ã‚¿ãƒƒã‚¯æ¤œçŸ¥â†’å†èµ·å‹• |
| CPUä½¿ç”¨ç‡ | 0% for 5åˆ† | ãƒ•ãƒªãƒ¼ã‚ºæ¤œçŸ¥â†’è­¦å‘Š |

**ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®å‹•ä½œ:**
```
1å›ç›®: âš ï¸  è­¦å‘Šãƒ­ã‚°
2å›ç›®: âš ï¸  CloudWatchãƒ¡ãƒˆãƒªã‚¯ã‚¹é€ä¿¡
3å›ç›®: ğŸ”„ Workerã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
```

**ä½¿ç”¨æ–¹æ³•:**
```bash
# Systemdã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦è‡ªå‹•èµ·å‹•
sudo systemctl enable auto-recovery.service
sudo systemctl start auto-recovery.service

# ãƒ­ã‚°ç¢ºèª
sudo journalctl -u auto-recovery.service -f
```

**CloudWatchãƒ¡ãƒˆãƒªã‚¯ã‚¹:**
- `CISFileSearch/Worker/HealthCheckStatus`: 0 (unhealthy) or 1 (healthy)
- `CISFileSearch/Worker/WorkerRestart`: å†èµ·å‹•å›æ•°
- `CISFileSearch/Worker/WorkerRestartFailed`: å†èµ·å‹•å¤±æ•—å›æ•°

---

## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### å‰ææ¡ä»¶

1. **EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¸SSHæ¥ç¶š**
   ```bash
   ssh -i ~/.ssh/cis-filesearch-key.pem ec2-user@<EC2_IP>
   ```

2. **å¿…è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**
   ```bash
   # ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã‹ã‚‰
   cd /Users/tatsuya/focus_project/cis_filesearch_app/backend/python-worker

   scp -i ~/.ssh/cis-filesearch-key.pem \
       health_check.py \
       dlq_reprocessor.py \
       spot_interruption_handler.py \
       auto_recovery.py \
       deploy-resilient-architecture.sh \
       deployment/file-processor-resilient.service \
       deployment/spot-interruption-handler.service \
       deployment/auto-recovery.service \
       ec2-user@<EC2_IP>:/home/ec2-user/python-worker/
   ```

3. **Pythonä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```bash
   # EC2ä¸Šã§å®Ÿè¡Œ
   sudo python3.11 -m pip install psutil requests
   ```

---

### ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ

#### Option 1: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨å¥¨ï¼‰

```bash
# EC2ä¸Šã§å®Ÿè¡Œ
cd /home/ec2-user/python-worker
sudo bash deploy-resilient-architecture.sh
```

**å‡¦ç†å†…å®¹:**
1. ç’°å¢ƒæ¤œè¨¼ï¼ˆPython 3.11, ä¾å­˜é–¢ä¿‚, .envï¼‰
2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é…ç½®
3. Resilient Systemdã‚µãƒ¼ãƒ“ã‚¹é…ç½®
4. DLQ Reprocessoré…ç½® + cronè¨­å®š
5. Spot Interruption Handleré…ç½® + èµ·å‹•
6. Auto Recovery Systemé…ç½® + èµ·å‹•
7. Workerã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
8. æ¤œè¨¼

---

#### Option 2: æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ…é‡ã«é€²ã‚ã‚‹å ´åˆï¼‰

**Step 1: ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³**
```bash
sudo bash deploy-resilient-architecture.sh --dry-run
```

**Step 2: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®ã¿ãƒ†ã‚¹ãƒˆ**
```bash
sudo python3.11 /home/ec2-user/python-worker/health_check.py
```

**Step 3: Systemdã‚µãƒ¼ãƒ“ã‚¹æ›´æ–°ï¼ˆå†èµ·å‹•ãªã—ï¼‰**
```bash
sudo bash deploy-resilient-architecture.sh --skip-restart
```

**Step 4: æ‰‹å‹•ã§Workerå†èµ·å‹•**
```bash
sudo systemctl restart file-processor.service
```

**Step 5: ç›£è¦–**
```bash
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°
sudo journalctl -u file-processor.service -f

# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹
sudo systemctl status file-processor.service
```

---

### ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®æ¤œè¨¼

**1. ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèªï¼ˆ5åˆ†å¾Œï¼‰**
```bash
# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹
sudo systemctl status file-processor.service
sudo systemctl status auto-recovery.service
sudo systemctl status spot-interruption-handler.service  # Spot ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã¿
```

**æœŸå¾…å€¤:**
```
â— file-processor.service - File Processor Worker Service (Resilient Architecture)
   Loaded: loaded
   Active: active (running) since ...
   Main PID: XXXX
```

**2. SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¸›å°‘ç¢ºèªï¼ˆ10åˆ†å¾Œï¼‰**
```bash
aws sqs get-queue-attributes \
    --queue-url <SQS_QUEUE_URL> \
    --attribute-names ApproximateNumberOfMessages \
    --query "Attributes.ApproximateNumberOfMessages"
```

**æœŸå¾…å€¤:**
- åˆæœŸ: 58,524ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- 10åˆ†å¾Œ: 55,000ä»¥ä¸‹ï¼ˆæ¸›å°‘å‚¾å‘ï¼‰
- 1æ™‚é–“å¾Œ: 30,000ä»¥ä¸‹
- 6æ™‚é–“å¾Œ: 5,000ä»¥ä¸‹

**3. DLQå¢—åŠ åœæ­¢ç¢ºèªï¼ˆ30åˆ†å¾Œï¼‰**
```bash
aws sqs get-queue-attributes \
    --queue-url <DLQ_QUEUE_URL> \
    --attribute-names ApproximateNumberOfMessages
```

**æœŸå¾…å€¤:**
- åˆæœŸ: 7,959ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- 30åˆ†å¾Œ: 7,959ï¼ˆå¢—åŠ åœæ­¢ï¼‰
- 1æ™‚é–“å¾Œ: 7,900ä»¥ä¸‹ï¼ˆæ¸›å°‘é–‹å§‹ï¼‰

**4. å†èµ·å‹•ãƒ«ãƒ¼ãƒ—ãŒãªã„ã“ã¨ã‚’ç¢ºèª**
```bash
# éå»1æ™‚é–“ã®å†èµ·å‹•å›æ•°
sudo journalctl -u file-processor.service --since "1 hour ago" | grep -c "Started File"
```

**æœŸå¾…å€¤:**
- `1` ã¾ãŸã¯ `0`ï¼ˆå†èµ·å‹•ãªã—ï¼‰
- ä»¥å‰: 120å›/æ™‚é–“ï¼ˆ2å›/åˆ†ï¼‰

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„

| æŒ‡æ¨™ | Before | After | æ”¹å–„ç‡ |
|------|--------|-------|--------|
| å‡¦ç†é€Ÿåº¦ | 122 msg/åˆ† | 500+ msg/åˆ† | **+309%** |
| å†èµ·å‹•é »åº¦ | 30ç§’ã”ã¨ï¼ˆ120å›/æ™‚ï¼‰ | ãªã—ï¼ˆ0å›/æ™‚ï¼‰ | **-100%** |
| DLQå¢—åŠ ç‡ | +100 msg/æ™‚ | 0 msg/æ™‚ | **-100%** |
| DLQæ¸›å°‘ç‡ | ãªã— | -200 msg/æ™‚ï¼ˆè‡ªå‹•å†å‡¦ç†ï¼‰ | **+200 msg/æ™‚** |
| ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ  | 50%ï¼ˆå†èµ·å‹•ã§50%åœæ­¢ï¼‰ | 99.9% | **+99.8%** |

### å®‰å®šæ€§æ”¹å–„

âœ… **å†èµ·å‹•ãƒ«ãƒ¼ãƒ—è§£æ¶ˆ**
- ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã§5å›å¤±æ•—å¾Œã¯åœæ­¢
- æ ¹æœ¬åŸå› ã®è§£æ±ºã‚’å¼·åˆ¶ï¼ˆç„¡é™å†èµ·å‹•ã•ã›ãªã„ï¼‰

âœ… **DLQè‡ªå‹•å¾©æ—§**
- 15åˆ†ã”ã¨ã«è‡ªå‹•å†å‡¦ç†
- 7,959ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ 24æ™‚é–“ä»¥å†…ã«æ­£å¸¸åŒ–

âœ… **ã‚¹ãƒãƒƒãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾ç­–**
- 2åˆ†å‰é€šçŸ¥ã§Graceful Shutdown
- ãƒ‡ãƒ¼ã‚¿ãƒ­ã‚¹ãªã—

âœ… **è‡ªå·±ä¿®å¾©èƒ½åŠ›**
- 10åˆ†é–“ã‚¹ã‚¿ãƒƒã‚¯ã§è‡ªå‹•å†èµ·å‹•
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œçŸ¥ã§è‡ªå‹•å†èµ·å‹•

---

## ğŸ” ç›£è¦–ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### æ—¥å¸¸ç›£è¦–ã‚³ãƒãƒ³ãƒ‰

**1. Workerãƒ­ã‚°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰**
```bash
sudo journalctl -u file-processor.service -f
```

**2. Auto Recoveryãƒ­ã‚°**
```bash
sudo journalctl -u auto-recovery.service -f
```

**3. DLQ Reprocessorãƒ­ã‚°**
```bash
sudo tail -f /var/log/dlq-reprocessor.log
```

**4. CloudWatchãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**
```bash
# ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹
https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#dashboards:
```

---

### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

#### ã‚±ãƒ¼ã‚¹1: WorkerãŒèµ·å‹•ã—ãªã„

**ç—‡çŠ¶:**
```bash
sudo systemctl status file-processor.service
# Output: failed (Result: exit-code)
```

**è¨ºæ–­:**
```bash
# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
sudo python3.11 /home/ec2-user/python-worker/health_check.py

# è©³ç´°ãƒ­ã‚°ç¢ºèª
sudo journalctl -u file-processor.service -n 100
```

**è§£æ±ºç­–:**
1. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—é …ç›®ã‚’ä¿®æ­£ï¼ˆç’°å¢ƒå¤‰æ•°ã€ä¾å­˜é–¢ä¿‚ãªã©ï¼‰
2. ä¿®æ­£å¾Œã€æ‰‹å‹•ã§èµ·å‹•è©¦è¡Œ
   ```bash
   sudo systemctl reset-failed file-processor.service
   sudo systemctl start file-processor.service
   ```

---

#### ã‚±ãƒ¼ã‚¹2: å‡¦ç†é€Ÿåº¦ãŒä¸ŠãŒã‚‰ãªã„

**ç—‡çŠ¶:**
- SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ãŒæ¸›ã‚‰ãªã„
- Workerã¯èµ·å‹•ã—ã¦ã„ã‚‹ãŒã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆä½ã„

**è¨ºæ–­:**
```bash
# Worker CPUã¨ãƒ¡ãƒ¢ãƒªç¢ºèª
top -p $(pgrep -f worker.py)

# SQSè¨­å®šç¢ºèª
aws sqs get-queue-attributes --queue-url <SQS_QUEUE_URL> --attribute-names All
```

**è§£æ±ºç­–:**
1. **Visibility Timeoutèª¿æ•´**ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé‡è¤‡å‡¦ç†ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
   ```bash
   aws sqs set-queue-attributes \
       --queue-url <SQS_QUEUE_URL> \
       --attributes VisibilityTimeout=600  # 10åˆ†
   ```

2. **ä¸¦åˆ—å‡¦ç†æ•°å¢—åŠ **ï¼ˆ`.env`ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†ï¼‰
   ```bash
   SQS_MAX_MESSAGES=10  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ10
   SQS_WAIT_TIME_SECONDS=20  # Long Polling
   ```

3. **Auto Scalingèª¿æ•´**ï¼ˆè¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•ï¼‰
   ```bash
   aws autoscaling set-desired-capacity \
       --auto-scaling-group-name cis-filesearch-worker-asg \
       --desired-capacity 2  # 2å°ã«å¢—åŠ 
   ```

---

#### ã‚±ãƒ¼ã‚¹3: DLQãŒæ¸›ã‚‰ãªã„

**ç—‡çŠ¶:**
- DLQ ReprocessorãŒå‹•ã„ã¦ã„ã‚‹ãŒæ¸›å°‘ã—ãªã„
- å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒ `UNRECOVERABLE` ã¨åˆ¤å®šã•ã‚Œã‚‹

**è¨ºæ–­:**
```bash
# å¤±æ•—åˆ†æ
sudo python3.11 dlq_reprocessor.py --analyze-only
```

**è§£æ±ºç­–:**
1. **ã‚¨ãƒ©ãƒ¼ã‚«ãƒ†ã‚´ãƒªã®è¦‹ç›´ã—**
   - `dlq_reprocessor.py`ã®`_categorize_error()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’èª¿æ•´
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 

2. **æ‰‹å‹•ã§ä¸€éƒ¨å†å‡¦ç†**
   ```bash
   # ç‰¹å®šã‚«ãƒ†ã‚´ãƒªã®ã¿å†å‡¦ç†ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä¿®æ­£ãŒå¿…è¦ï¼‰
   sudo python3.11 dlq_reprocessor.py --category RECOVERABLE_OPENSEARCH
   ```

3. **DLQãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®S3ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç¢ºèª**
   ```bash
   aws s3 ls s3://cis-filesearch-storage/dlq-archive/ --recursive
   ```

---

## ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

### ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ3åˆ†ä»¥å†…ï¼‰

**Systemdã‚µãƒ¼ãƒ“ã‚¹ã‚’æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™:**

```bash
# Step 1: æ—§ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å…ƒ
sudo cp /etc/systemd/system/file-processor.service.backup.YYYYMMDD_HHMMSS \
        /etc/systemd/system/file-processor.service

# Step 2: Systemdå†èª­ã¿è¾¼ã¿
sudo systemctl daemon-reload

# Step 3: Workerã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
sudo systemctl restart file-processor.service

# Step 4: è£œåŠ©ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
sudo systemctl stop auto-recovery.service
sudo systemctl stop spot-interruption-handler.service
sudo systemctl disable auto-recovery.service
sudo systemctl disable spot-interruption-handler.service

# Step 5: DLQ Reprocessor cronå‰Šé™¤
crontab -l | grep -v "dlq_reprocessor.py" | crontab -
```

**æ¤œè¨¼:**
```bash
sudo systemctl status file-processor.service
# æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§èµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
```

---

### å®Œå…¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆ10åˆ†ä»¥å†…ï¼‰

**EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†ä½œæˆ:**

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã‹ã‚‰å®Ÿè¡Œ
cd /Users/tatsuya/focus_project/cis_filesearch_app/terraform

# ç¾åœ¨ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
terraform taint aws_autoscaling_group.file_processor

# æ—§AMIã§å†ä½œæˆ
terraform apply \
    -var="worker_ami_id=ami-XXXXXXXXX"  # æ—§AMI ID
```

**æœŸå¾…æ‰€è¦æ™‚é–“:**
- ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹çµ‚äº†: 2åˆ†
- æ–°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•: 3åˆ†
- ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•: 2åˆ†
- æ¤œè¨¼: 3åˆ†
- **åˆè¨ˆ**: 10åˆ†

---

## ğŸ“š å‚è€ƒè³‡æ–™

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Resilient SQS Worker Architecture              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Health     â”‚    â”‚   Systemd    â”‚    â”‚   Worker     â”‚     â”‚
â”‚  â”‚   Check      â”‚â”€â”€â”€â–¶â”‚   Service    â”‚â”€â”€â”€â–¶â”‚   Process    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  (Circuit    â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚       â–²              â”‚   Breaker)   â”‚           â”‚             â”‚
â”‚       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚             â”‚
â”‚       â”‚                                         â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Auto      â”‚                          â”‚     SQS     â”‚    â”‚
â”‚  â”‚  Recovery   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Polling   â”‚    â”‚
â”‚  â”‚   System    â”‚    (monitor progress)    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚       â”‚                                                       â”‚
â”‚       â”‚ (restart if stuck)                                   â”‚
â”‚       â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Worker    â”‚                          â”‚     DLQ     â”‚    â”‚
â”‚  â”‚  Restart    â”‚                          â”‚ Reprocessor â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                  â”‚            â”‚
â”‚                                            (every 15min)      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚            â”‚
â”‚  â”‚   Spot      â”‚                          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚Interruption â”‚                          â”‚   Failed    â”‚    â”‚
â”‚  â”‚   Handler   â”‚                          â”‚  Messages   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚                                                       â”‚
â”‚       â”‚ (graceful shutdown)                                  â”‚
â”‚       â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚  â”‚  CloudWatch â”‚                                             â”‚
â”‚  â”‚   Metrics   â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ | ãƒ‘ã‚¹ |
|---------|------|------|
| `health_check.py` | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | `/home/ec2-user/python-worker/` |
| `dlq_reprocessor.py` | DLQè‡ªå‹•å†å‡¦ç† | `/home/ec2-user/python-worker/` |
| `spot_interruption_handler.py` | ã‚¹ãƒãƒƒãƒˆä¸­æ–­ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ | `/home/ec2-user/python-worker/` |
| `auto_recovery.py` | è‡ªå‹•å¾©æ—§ã‚·ã‚¹ãƒ†ãƒ  | `/home/ec2-user/python-worker/` |
| `file-processor-resilient.service` | Resilient Systemdã‚µãƒ¼ãƒ“ã‚¹ | `/etc/systemd/system/` |
| `spot-interruption-handler.service` | ã‚¹ãƒãƒƒãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ | `/etc/systemd/system/` |
| `auto-recovery.service` | è‡ªå‹•å¾©æ—§ã‚µãƒ¼ãƒ“ã‚¹ | `/etc/systemd/system/` |
| `deploy-resilient-architecture.sh` | ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | `/home/ec2-user/python-worker/` |

---

### Systemdè¨­å®šã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ

**Circuit Breakerè¨­å®š:**
```ini
StartLimitBurst=5           # æœ€å¤§5å›ã¾ã§å†èµ·å‹•
StartLimitIntervalSec=300   # 5åˆ†é–“ã§5å›ã¾ã§
```

**æ„å‘³:**
- 5åˆ†é–“ã«5å›å¤±æ•—ã—ãŸã‚‰ã€ã‚µãƒ¼ãƒ“ã‚¹ã¯ `failed` çŠ¶æ…‹ã«ãªã‚Šè‡ªå‹•å†èµ·å‹•ã‚’åœæ­¢
- ç®¡ç†è€…ãŒæ‰‹å‹•ã§èª¿æŸ»ãƒ»ä¿®æ­£ã™ã‚‹ã“ã¨ã‚’å¼·åˆ¶
- ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²ãã€ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã‚’ä¿è­·

**å†èµ·å‹•é–“éš”:**
```ini
RestartSec=30  # 30ç§’å¾…ã£ã¦ã‹ã‚‰å†èµ·å‹•
```

**Watchdog:**
```ini
WatchdogSec=60  # 60ç§’ã”ã¨ã«ãƒ—ãƒ­ã‚»ã‚¹ã®ç”Ÿå­˜ç¢ºèª
```

---

## âœ… æˆåŠŸåŸºæº–ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ—ãƒ­ã‚¤ç›´å¾Œï¼ˆ5åˆ†ä»¥å†…ï¼‰

- [ ] `sudo systemctl status file-processor.service` ãŒ `active (running)` ã‚’è¡¨ç¤º
- [ ] `sudo journalctl -u file-processor.service` ã«ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒãªã„
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸï¼ˆ`sudo python3.11 health_check.py` â†’ exit 0ï¼‰
- [ ] Auto Recoveryã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ï¼ˆ`sudo systemctl status auto-recovery.service`ï¼‰

### 1æ™‚é–“å¾Œ

- [ ] SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ãŒ30,000ä»¥ä¸‹ã«æ¸›å°‘
- [ ] DLQãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ãŒå¢—åŠ ã—ã¦ã„ãªã„
- [ ] Workerã‚µãƒ¼ãƒ“ã‚¹ãŒå†èµ·å‹•ã—ã¦ã„ãªã„ï¼ˆjournalctlç¢ºèªï¼‰
- [ ] CloudWatchãƒ¡ãƒˆãƒªã‚¯ã‚¹ `HealthCheckStatus=1` ãŒé€£ç¶š

### 24æ™‚é–“å¾Œ

- [ ] SQSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ãŒ5,000ä»¥ä¸‹
- [ ] DLQãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ãŒ7,500ä»¥ä¸‹ï¼ˆè‡ªå‹•å†å‡¦ç†ã«ã‚ˆã‚Šæ¸›å°‘ï¼‰
- [ ] Workerã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒ  >23æ™‚é–“
- [ ] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå®‰å®šï¼ˆ<4GBï¼‰

---

## ğŸ“ å­¦ã‚“ã ã“ã¨

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã®æ•™è¨“

1. **Fail FaståŸå‰‡**: èµ·å‹•å¾Œã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆã‚Šã€èµ·å‹•å‰ã«å¤±æ•—ã™ã‚‹æ–¹ãŒè‰¯ã„
2. **Circuit Breaker**: ç„¡é™å†èµ·å‹•ã¯å•é¡Œã‚’éš è”½ã™ã‚‹ã€‚5å›ã§åœæ­¢ã—ã€äººé–“ã®ä»‹å…¥ã‚’ä¿ƒã™
3. **Self-Healing**: è‡ªå‹•å¾©æ—§ã¯è‰¯ã„ãŒã€æ ¹æœ¬åŸå› ã®ä¿®æ­£ã‚’æ€ ã‚‰ãªã„
4. **Graceful Degradation**: ä¸€éƒ¨æ©Ÿèƒ½ãŒä½¿ãˆãªãã¦ã‚‚ã€ã‚³ã‚¢æ©Ÿèƒ½ã¯ç¶™ç¶šã™ã‚‹

### é‹ç”¨ã®æ•™è¨“

1. **ç›£è¦–ã®é‡è¦æ€§**: å•é¡Œã‚’æ—©æœŸç™ºè¦‹ã™ã‚‹ãŸã‚ã€CloudWatchãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯å¿…é ˆ
2. **è‡ªå‹•åŒ–ã¨æ‰‹å‹•ã®ãƒãƒ©ãƒ³ã‚¹**: å®Œå…¨è‡ªå‹•åŒ–ã›ãšã€é‡è¦ãªåˆ¤æ–­ã¯äººé–“ãŒè¡Œã†
3. **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æº–å‚™**: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’ç¢ºèª
4. **æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤**: ä¸€åº¦ã«å…¨ã¦å¤‰æ›´ã›ãšã€æ®µéšçš„ã«é©ç”¨

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

### å•é¡Œç™ºç”Ÿæ™‚ã®é€£çµ¡å…ˆ

1. **CloudWatchã‚¢ãƒ©ãƒ¼ãƒ **: è‡ªå‹•çš„ã«SNSãƒˆãƒ”ãƒƒã‚¯ã¸é€šçŸ¥
2. **ãƒ­ã‚°ç¢ºèª**: `sudo journalctl -u file-processor.service --since "1 hour ago"`
3. **ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**: Backend Architecture Expert ã¸é€£çµ¡

### è¿½åŠ ãƒªã‚½ãƒ¼ã‚¹

- **AWSãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [SQS Best Practices](https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-best-practices.html)
- **Systemdå…¬å¼**: [systemd.service(5)](https://www.freedesktop.org/software/systemd/man/systemd.service.html)
- **Pythonãƒ­ã‚®ãƒ³ã‚°**: [logging â€” Logging facility for Python](https://docs.python.org/3/library/logging.html)

---

**Document Version**: 1.0
**Last Updated**: 2025-12-15
**Author**: Backend Architecture & Refactoring Expert
