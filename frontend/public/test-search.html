<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIS ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ  - E2Eãƒ†ã‚¹ãƒˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 32px;
        }
        .search-section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        input[type="file"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a67d8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            max-height: 500px;
            overflow-y: auto;
        }
        .result-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }
        .result-item:hover {
            background: #f5f5f5;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .result-path {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .result-snippet {
            font-size: 14px;
            color: #555;
            line-height: 1.4;
        }
        .result-meta {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        em {
            background-color: yellow;
            font-style: normal;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” CIS ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ  - E2Eãƒ†ã‚¹ãƒˆ</h1>

        <!-- ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="search-section">
            <h2>ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</h2>
            <div class="search-box">
                <input type="text" id="textQuery" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå®‡éƒ½å®®ï¼‰" value="å®‡éƒ½å®®">
                <button onclick="performTextSearch()">æ¤œç´¢</button>
            </div>
            <div id="textStatus"></div>
            <div id="textResults" class="results" style="display:none;"></div>
        </div>

        <!-- ç”»åƒæ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="search-section">
            <h2>ğŸ¨ ç”»åƒæ¤œç´¢</h2>
            <div class="search-box">
                <input type="file" id="imageFile" accept="image/*">
                <button onclick="performImageSearch()">é¡ä¼¼ç”»åƒã‚’æ¤œç´¢</button>
            </div>
            <div id="imageStatus"></div>
            <div id="imageResults" class="results" style="display:none;"></div>
        </div>
    </div>

    <script>
        // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢
        async function performTextSearch() {
            const query = document.getElementById('textQuery').value;
            if (!query) {
                showStatus('textStatus', 'error', 'æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            showStatus('textStatus', 'info', 'æ¤œç´¢ä¸­...');
            document.getElementById('textResults').style.display = 'none';

            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}&searchMode=or&page=1&limit=10`);
                const data = await response.json();

                if (data.success) {
                    showStatus('textStatus', 'success', `âœ… ${data.data.total}ä»¶ã®çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                    displayResults('textResults', data.data.results);
                } else {
                    showStatus('textStatus', 'error', `âŒ ã‚¨ãƒ©ãƒ¼: ${data.error}`);
                }
            } catch (error) {
                showStatus('textStatus', 'error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ç”»åƒæ¤œç´¢
        async function performImageSearch() {
            const fileInput = document.getElementById('imageFile');
            const file = fileInput.files[0];

            if (!file) {
                showStatus('imageStatus', 'error', 'ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            showStatus('imageStatus', 'info', 'ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');
            document.getElementById('imageResults').style.display = 'none';

            try {
                // Step 1: ç”»åƒåŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
                const formData = new FormData();
                formData.append('file', file);

                const embeddingResponse = await fetch('/api/image-embedding', {
                    method: 'POST',
                    body: formData
                });

                const embeddingData = await embeddingResponse.json();

                if (!embeddingData.success) {
                    showStatus('imageStatus', 'error', `âŒ åŸ‹ã‚è¾¼ã¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${embeddingData.error}`);
                    return;
                }

                showStatus('imageStatus', 'info', 'é¡ä¼¼ç”»åƒã‚’æ¤œç´¢ä¸­...');

                // Step 2: é¡ä¼¼ç”»åƒæ¤œç´¢
                const searchResponse = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageEmbedding: embeddingData.data.embedding,
                        page: 1,
                        size: 10
                    })
                });

                const searchData = await searchResponse.json();

                if (searchData.success) {
                    const total = searchData.data?.total || searchData.data?.pagination?.total || 0;
                    showStatus('imageStatus', 'success', `âœ… ${total}ä»¶ã®é¡ä¼¼ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                    displayResults('imageResults', searchData.data.results);
                } else {
                    showStatus('imageStatus', 'error', `âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${searchData.error}`);
                }
            } catch (error) {
                showStatus('imageStatus', 'error', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        // çµæœè¡¨ç¤º
        function displayResults(elementId, results) {
            const element = document.getElementById(elementId);

            if (!results || results.length === 0) {
                element.innerHTML = '<div class="loading">çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>';
                element.style.display = 'block';
                return;
            }

            let html = '';
            results.forEach((result, index) => {
                const highlightedFileName = result.highlights?.file_name?.[0] || result.fileName;
                const snippet = result.snippet || result.highlights?.content?.[0] || '(ã‚¹ãƒ‹ãƒšãƒƒãƒˆãªã—)';
                const fileSize = formatFileSize(result.fileSize);
                const score = result.relevanceScore ? result.relevanceScore.toFixed(2) : 'N/A';

                html += `
                    <div class="result-item">
                        <div class="result-title">${index + 1}. ${highlightedFileName}</div>
                        <div class="result-path">${result.filePath}</div>
                        <div class="result-snippet">${snippet}</div>
                        <div class="result-meta">
                            ã‚µã‚¤ã‚º: ${fileSize} |
                            ã‚¹ã‚³ã‚¢: ${score} |
                            ã‚¿ã‚¤ãƒ—: ${result.fileType || 'N/A'}
                        </div>
                    </div>
                `;
            });

            element.innerHTML = html;
            element.style.display = 'block';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatFileSize(bytes) {
            if (!bytes) return 'N/A';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ã‚’å®Ÿè¡Œ
        window.onload = function() {
            setTimeout(() => {
                console.log('è‡ªå‹•ãƒ†ã‚¹ãƒˆé–‹å§‹: ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ã€Œå®‡éƒ½å®®ã€');
                performTextSearch();
            }, 500);
        };
    </script>
</body>
</html>