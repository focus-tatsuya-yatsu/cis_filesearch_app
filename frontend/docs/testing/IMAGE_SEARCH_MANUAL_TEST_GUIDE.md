# 画像検索機能 手動テストガイド

このドキュメントは、画像検索機能の包括的な手動テスト手順を提供します。

## テスト環境

- **フロントエンド**: http://localhost:3000
- **バックエンドAPI**: https://5xbn3ng31f.execute-api.ap-northeast-1.amazonaws.com/default/search
- **OpenSearchインデックス**: file-index-v2-knn
- **データ件数**: 1000件（道路設計部の画像データ）
- **インデックス内容**: CIMG0012.JPG, CIMG0004.JPG, 53.jpg等

## 事前準備

### 1. 環境セットアップ

```bash
cd /Users/tatsuya/focus_project/cis_filesearch_app/frontend

# 依存関係インストール
yarn install

# 開発サーバー起動
yarn dev
```

### 2. テスト用画像の準備

以下のテスト画像を準備してください：

- **有効なJPEG画像**: 100KB - 1MB程度
- **有効なPNG画像**: 100KB - 1MB程度
- **大きな画像**: 5MB以上（バリデーションテスト用）
- **無効なファイル**: PDF、Word文書など（エラーハンドリングテスト用）

テスト用画像を生成するスクリプト：

```bash
yarn run create-test-image.sh
```

## テストシナリオ

### シナリオ 1: 基本的な画像アップロードと検索

**目的**: 画像検索の基本フローが正常に動作することを確認

**手順**:

1. ブラウザで http://localhost:3000 を開く
2. 「画像で検索」ボタンをクリック
3. ドロップダウンが開くことを確認
4. 「画像を選択」または「ここに画像をドロップ」エリアをクリック
5. JPEGまたはPNG画像を選択
6. アップロード進捗が表示されることを確認
7. 「画像を処理中...」というトーストが表示されることを確認
8. 検索結果が2秒以内に表示されることを確認

**期待される結果**:

- ✅ ドロップダウンがスムーズに開く
- ✅ 画像プレビューが表示される
- ✅ プログレスバーが0% → 100%まで進行
- ✅ 「検索完了」トーストが表示される
- ✅ 検索結果が1件以上表示される
- ✅ 各結果にファイル名、パス、サイズ、更新日が表示される
- ✅ 信頼度スコアが90%以上

**確認ポイント**:

```
[ ] ドロップダウンの開閉がスムーズか
[ ] 画像プレビューが正しく表示されるか
[ ] プログレスバーが動作しているか
[ ] トースト通知が適切に表示されるか
[ ] 検索レスポンスが2秒以内か
[ ] 結果件数が表示されているか
[ ] 各結果のメタデータが完全か
```

---

### シナリオ 2: 検索結果の品質検証

**目的**: 1000件のデータから適切な検索結果が返されることを確認

**手順**:

1. 画像検索を実行（シナリオ1と同様）
2. 検索結果の最初の5件を確認
3. 各結果の信頼度スコアを記録
4. ファイル情報の完全性を確認

**期待される結果**:

- ✅ すべての結果の信頼度スコアが90%以上
- ✅ スコアが降順にソートされている
- ✅ 各結果に以下の情報が表示される：
  - ファイル名（例: CIMG0012.JPG）
  - ファイルパス（適切に省略されている）
  - ファイルサイズ（KB/MB表記）
  - 更新日（日本語形式）
  - 部署名（例: 道路設計部）

**確認ポイント**:

```
結果1:
  [ ] ファイル名: __________________
  [ ] 信頼度: _____% (≥90%)
  [ ] パス表示: 適切に省略されているか
  [ ] サイズ表記: 正しいか
  [ ] 日付形式: 2025/01/20 14:30 のような形式か
  [ ] 部署名: 表示されているか

結果2-5: 同様に確認
```

---

### シナリオ 3: ファイルメタデータの表示確認

**目的**: OpenSearchから取得した全メタデータが正しく表示されることを確認

**手順**:

1. 画像検索を実行
2. 最初の結果をホバー
3. 全メタデータが表示されることを確認
4. パスコピーボタンをクリック
5. クリップボードの内容を確認（Ctrl+V でテキストエディタに貼り付け）

**期待される結果**:

- ✅ ホバー時にプレビューアイコンが表示される
- ✅ パスコピーボタンが表示される
- ✅ コピーボタンクリックで「コピーしました」トーストが表示
- ✅ クリップボードに完全なファイルパスがコピーされる
- ✅ コピー成功後、アイコンがチェックマークに変わる（2秒間）

**確認ポイント**:

```
[ ] ファイル名が正しく表示されているか
[ ] ファイルパスが省略されているか（長すぎないか）
[ ] ファイルサイズのフォーマットが正しいか（例: 1.5 MB）
[ ] 更新日が日本語形式か
[ ] 部署名が表示されているか
[ ] パスコピー機能が動作するか
[ ] トースト通知が表示されるか
```

---

### シナリオ 4: パスの省略表示（truncatePath）

**目的**: 長いファイルパスが適切に省略されていることを確認

**手順**:

1. 画像検索を実行
2. 長いパスを持つ結果を見つける
3. パスの表示形式を確認
4. ホバーまたはクリックで完全なパスが表示されるか確認

**期待される結果**:

- ✅ パスが適切に省略されている（例: `.../folder/file.jpg`）
- ✅ 省略されても重要な情報（ファイル名、親フォルダ）は見える
- ✅ ツールチップまたは展開で完全なパスが確認できる
- ✅ 省略表示が統一されている

**テストケース**:

| パスの長さ | 期待される表示 |
|----------|-------------|
| 短いパス (< 50文字) | 完全に表示 |
| 中程度のパス (50-80文字) | 中央部分を省略 `.../` |
| 長いパス (> 80文字) | 先頭と末尾のみ表示 |

**確認ポイント**:

```
[ ] 短いパスは完全表示されるか
[ ] 長いパスは適切に省略されるか
[ ] 省略されても読みやすいか
[ ] 完全なパスを確認できる方法があるか
```

---

### シナリオ 5: エラーハンドリング

**目的**: 各種エラーケースで適切なエラーメッセージが表示されることを確認

#### 5.1 無効なファイル形式

**手順**:
1. PDFファイルまたはWord文書をアップロード

**期待される結果**:
- ✅ エラートースト表示: "JPEG、PNG形式の画像のみサポートされています"
- ✅ アップロードが中止される
- ✅ ドロップダウンが開いたまま（再試行可能）

#### 5.2 ファイルサイズ超過

**手順**:
1. 5MB以上の画像ファイルをアップロード

**期待される結果**:
- ✅ エラートースト表示: "ファイルサイズは5MB以下にしてください"
- ✅ アップロードが中止される

#### 5.3 ネットワークエラー

**手順**:
1. DevToolsでネットワークをオフラインに設定
2. 画像をアップロード

**期待される結果**:
- ✅ エラートースト表示: "ネットワークエラーが発生しました"
- ✅ プログレスバーが停止
- ✅ 再試行可能な状態に戻る

#### 5.4 結果が0件の場合

**手順**:
1. 完全に異なる画像（風景写真など）をアップロード

**期待される結果**:
- ✅ 空状態メッセージ表示: "結果が見つかりませんでした"
- ✅ "別の画像で試してみてください"というヒント表示
- ✅ ドロップダウンが開いたまま

**確認ポイント**:

```
無効なファイル形式:
  [ ] エラーメッセージが表示されるか
  [ ] メッセージが分かりやすいか
  [ ] 再試行可能か

ファイルサイズ超過:
  [ ] エラーメッセージが表示されるか
  [ ] 制限値が明記されているか

ネットワークエラー:
  [ ] エラーメッセージが表示されるか
  [ ] ローディング状態が適切に解除されるか

結果0件:
  [ ] 空状態メッセージが表示されるか
  [ ] 次のアクションが明確か
```

---

### シナリオ 6: パフォーマンステスト

**目的**: 1000件のデータでもパフォーマンスが維持されることを確認

#### 6.1 検索レスポンスタイム

**手順**:
1. ストップウォッチまたはDevToolsのNetworkタブを準備
2. 画像をアップロード
3. 検索完了までの時間を計測（3回実施）

**期待される結果**:
- ✅ 平均レスポンスタイム: 2秒以内
- ✅ 最大レスポンスタイム: 5秒以内
- ✅ タイムアウトエラーが発生しない

**計測結果記録**:

```
試行1: _____秒
試行2: _____秒
試行3: _____秒
平均: _____秒 (目標: ≤2秒)
```

#### 6.2 UIレスポンシビリティ

**手順**:
1. 画像をアップロード
2. 検索中にブラウザ操作（スクロール、クリック）を試す
3. プログレスバーの動作を確認

**期待される結果**:
- ✅ 検索中もUIが応答する
- ✅ プログレスバーがスムーズに進行
- ✅ ブラウザがフリーズしない

#### 6.3 連続検索テスト

**手順**:
1. 5回連続で画像検索を実行
2. 各回の検索速度を確認
3. メモリリークがないか確認（DevTools Memory タブ）

**期待される結果**:
- ✅ 各回のパフォーマンスが一定
- ✅ メモリ使用量が増え続けない
- ✅ UIが重くならない

**確認ポイント**:

```
レスポンスタイム:
  [ ] 目標の2秒以内か
  [ ] 安定しているか（ブレが少ない）

UIレスポンシビリティ:
  [ ] 検索中もスムーズに操作できるか
  [ ] プログレスバーが滑らかか

連続検索:
  [ ] パフォーマンスが劣化しないか
  [ ] メモリリークがないか
```

---

### シナリオ 7: 信頼度閾値のフィルタリング

**目的**: 信頼度90%以上の結果のみが表示されることを確認

**手順**:
1. 画像検索を実行
2. すべての検索結果の信頼度スコアを記録
3. 90%未満の結果がないことを確認

**期待される結果**:
- ✅ すべての結果が90%以上
- ✅ スコアが降順にソートされている
- ✅ スコア表示が明確（例: 95%）
- ✅ スコアに応じたビジュアル表現（色分けなど）

**スコア記録**:

```
結果1: _____% (≥90%)
結果2: _____% (≥90%)
結果3: _____% (≥90%)
結果4: _____% (≥90%)
結果5: _____% (≥90%)
...
最小スコア: _____% (≥90% であること)
```

---

### シナリオ 8: ページネーション

**目的**: 大量の結果が適切にページネーションされることを確認

**手順**:
1. 多くの結果を返す画像で検索
2. 表示される結果件数を確認
3. 「次へ」ボタンが表示されるか確認
4. 次のページに移動
5. 結果が更新されることを確認

**期待される結果**:
- ✅ 1ページあたり10-20件程度
- ✅ 総件数が表示される
- ✅ ページネーションボタンが機能する
- ✅ ページ遷移がスムーズ

**確認ポイント**:

```
[ ] 1ページの件数は適切か
[ ] 総件数が表示されているか
[ ] ページ移動がスムーズか
[ ] 前後のページに戻れるか
```

---

### シナリオ 9: レスポンシブデザイン

**目的**: モバイル、タブレット、デスクトップで正しく表示されることを確認

#### 9.1 デスクトップ（1920x1080）

**手順**:
1. ブラウザをフルスクリーンに設定
2. 画像検索を実行
3. レイアウトを確認

**期待される結果**:
- ✅ 検索結果が3カラムグリッド表示
- ✅ すべての要素が見やすい
- ✅ ホバーエフェクトが機能

#### 9.2 タブレット（768x1024）

**手順**:
1. DevToolsでタブレットサイズに変更
2. 画像検索を実行
3. レイアウトを確認

**期待される結果**:
- ✅ 検索結果が2カラムグリッド表示
- ✅ タッチ操作がしやすいサイズ
- ✅ テキストが読みやすい

#### 9.3 モバイル（375x667）

**手順**:
1. DevToolsでモバイルサイズに変更
2. 画像検索を実行
3. レイアウトを確認

**期待される結果**:
- ✅ 検索結果が1カラム表示
- ✅ ドラッグ&ドロップエリアが適切なサイズ
- ✅ ボタンがタップしやすい

**確認ポイント**:

```
デスクトップ:
  [ ] 3カラムグリッドか
  [ ] ホバーエフェクトが機能するか

タブレット:
  [ ] 2カラムグリッドか
  [ ] タッチ操作しやすいか

モバイル:
  [ ] 1カラム表示か
  [ ] テキストが読みやすいか
  [ ] ボタンが押しやすいか
```

---

### シナリオ 10: アクセシビリティ

**目的**: キーボード操作とスクリーンリーダー対応を確認

#### 10.1 キーボードナビゲーション

**手順**:
1. Tabキーで要素間を移動
2. Enterキーで「画像で検索」を開く
3. Tabでファイル入力にフォーカス
4. Enterでファイル選択ダイアログを開く

**期待される結果**:
- ✅ すべての要素にTabでアクセス可能
- ✅ フォーカス表示が明確
- ✅ Enterキーで操作可能
- ✅ Escキーでドロップダウンを閉じられる

#### 10.2 ARIAラベル

**手順**:
1. DevToolsでElements タブを開く
2. 各要素のARIA属性を確認

**期待される結果**:
- ✅ `aria-label` が適切に設定されている
- ✅ `role` 属性が正しい
- ✅ `aria-live` で動的更新を通知

**確認ポイント**:

```
キーボード操作:
  [ ] Tab で移動可能か
  [ ] Enter で操作可能か
  [ ] Esc で閉じられるか
  [ ] フォーカス表示が明確か

ARIAラベル:
  [ ] aria-label が設定されているか
  [ ] role 属性が適切か
  [ ] スクリーンリーダーで読み上げ可能か
```

---

## テスト結果記録シート

### 全体評価

```
日付: __________
テスター: __________
ブラウザ: __________ (Chrome/Firefox/Safari)
環境: __________ (Dev/Staging/Production)

総合評価: [ ] 合格 / [ ] 不合格

主要な問題:
1. ______________________________________
2. ______________________________________
3. ______________________________________

軽微な問題:
1. ______________________________________
2. ______________________________________

改善提案:
1. ______________________________________
2. ______________________________________
```

### シナリオ別結果

| シナリオ | ステータス | 所要時間 | 備考 |
|---------|----------|---------|------|
| 1. 基本的なアップロード | [ ] Pass / [ ] Fail | _____秒 | |
| 2. 検索結果の品質 | [ ] Pass / [ ] Fail | | |
| 3. メタデータ表示 | [ ] Pass / [ ] Fail | | |
| 4. パス省略表示 | [ ] Pass / [ ] Fail | | |
| 5. エラーハンドリング | [ ] Pass / [ ] Fail | | |
| 6. パフォーマンス | [ ] Pass / [ ] Fail | _____秒 | |
| 7. 信頼度フィルタリング | [ ] Pass / [ ] Fail | | |
| 8. ページネーション | [ ] Pass / [ ] Fail | | |
| 9. レスポンシブデザイン | [ ] Pass / [ ] Fail | | |
| 10. アクセシビリティ | [ ] Pass / [ ] Fail | | |

## クイックテストチェックリスト

短時間で主要機能を確認する場合は、以下のチェックリストを使用してください：

```
[ ] 画像をアップロードできる
[ ] 検索結果が表示される（2秒以内）
[ ] 信頼度スコアがすべて90%以上
[ ] ファイル名、パス、サイズ、日付が表示される
[ ] パスコピー機能が動作する
[ ] エラーハンドリングが機能する（無効ファイル）
[ ] モバイルでも正常に動作する
[ ] キーボードで操作できる
```

## トラブルシューティング

### 問題: 検索結果が表示されない

**原因候補**:
- バックエンドAPIが応答していない
- OpenSearchが起動していない
- ネットワークエラー

**確認方法**:
```bash
# API疎通確認
curl https://5xbn3ng31f.execute-api.ap-northeast-1.amazonaws.com/default/search

# DevToolsのNetworkタブでエラーを確認
```

### 問題: アップロードが失敗する

**原因候補**:
- ファイルサイズ超過
- 無効なファイル形式
- AWS Bedrock接続エラー

**確認方法**:
- Console ログを確認
- ファイルサイズを確認
- ファイル形式を確認

### 問題: パフォーマンスが遅い

**原因候補**:
- OpenSearchインデックスの問題
- ネットワーク遅延
- ブラウザキャッシュの問題

**確認方法**:
```bash
# OpenSearch接続確認
yarn run check-opensearch-local.sh
```

## 参考資料

- [E2Eテスト実装](/Users/tatsuya/focus_project/cis_filesearch_app/frontend/e2e/image-search.spec.ts)
- [統合テスト](/Users/tatsuya/focus_project/cis_filesearch_app/frontend/src/__tests__/integration/image-search-e2e.test.ts)
- [パフォーマンステスト](/Users/tatsuya/focus_project/cis_filesearch_app/frontend/scripts/benchmark-image-search.ts)

---

**最終更新**: 2025-01-21
**バージョン**: 1.0.0
